---
title: "3-12_Memphis_qcew"
output: html_document
---

```{r message=FALSE, warning=FALSE, include=FALSE}

if(!require(pacman)){install.packages("pacman"); library(pacman)}
p_load(here, RPostgreSQL, sf, ggplot2, directlabels,ggthemes, tidyverse, dbplyr, stargazer,cowplot, lubridate, gridExtra,data.table)

#query the corridors from bike_lanes
user <- "minji2"
host <- "pgsql102.rc.pdx.edu"
pw <- scan(here::here("batteries.pgpss"), what = "")
dbname <- "bike_lanes"

con <- dbConnect("PostgreSQL", host = host, user = user, dbname = dbname, 
                 password = pw, port = 5433)

source(here::here("Code/corridor_comparison_functions.R"))

memphis_qcew <- tbl(con, "memphis_qcew") %>% collect() %>% mutate(street_group = as.character(street_group))
memphis_qcew$Type <- as.factor(memphis_qcew$Type)

dbDisconnect(con)

```

# Defining function: agg_trend_table_qcew

agg_trend_table_qcew <- function(df, group) {
  
  df <- if(class(df) == "sf") {
    
    df <- as.data.frame(df, stringsAsFactors = FALSE) %>% select(-starts_with("geom"))
    
  } else {
    
    df
  }
  
  df <- df %>% filter(street_group == group)
  
  
  df_plot <- df %>% group_by(year, Type) %>%
    summarise(emp_food = sum(emp_food),
              emp_retail = sum(emp_retail),
              wage_food = sum(wage_food),
              wage_retail = sum(wage_retail),
              estb_food = sum(estb_food),
              estb_retail = sum(estb_retail))
              
  return(df_plot)
  
}


# Corridor Comparisons -------------------------------------------------------

## Madison Avenue

### Employment trend comparison

```{r, echo=FALSE, message=FALSE, warning=FALSE, fig.width = 9.5, fig.asp=.5}

madison_agg <- agg_trend_table_qcew (memphis_qcew, group = 1)

# add a new function to draw plots with 4 control corridors
agg_trend_plot_emp <- function(df_plot, industry, corridor_name, 
                                 industry_code = c("emp_retail", "emp_food"), 
                                 construct_year, end_year) {
  
  df_plot$Type <- factor(df_plot$Type, levels = rev(levels(df_plot$Type)))
  
  #convert year to proper date
  
  df_plot$year <-as.character(paste0(df_plot$year, "-01-01"))
  df_plot$year <- as.Date(df_plot$year, "%Y-%m-%d")

  construct_date <- as.character(paste0(construct_year, "-01-01"))
  construct_date <- as.Date(construct_date, "%Y-%m-%d")

  end_date <- as.character(paste0(end_year, "-01-01"))
  end_date <- as.Date(end_date, "%Y-%m-%d")

  #making the plot
  
  ats_df <- ggplot(df_plot, aes(x = year, y = get(industry_code), shape = Type, group = Type, colour = Type)) + 
    geom_line()  +
    geom_rect(aes(xmin = as.Date(construct_date, "%Y"), xmax = as.Date(end_date, "%Y"), ymin = -Inf, ymax = Inf),
              fill = "#adff2f",linetype=0,alpha = 0.03) +
    geom_point(size = 3, fill="white") +
    scale_shape_manual(values=c(22,21,21,21,21))+
    scale_x_date(date_breaks = "3 years", date_labels = "%Y") +
    theme_minimal() +
    labs(title = glue("{industry} Employment Comparison:\n {corridor_name}"), x="Year",y="Employment",
         caption = "Shaded area represents the construction period") +
    guides(title = "Street Type")
  
  return(ats_df)
}

madison_retail_trend_plot <- agg_trend_plot_emp(madison_agg, industry = "Retail", industry_code = "emp_retail", corridor_name = "Madison Avenue", construct_year = 2011, end_year = 2012)

madison_food_trend_plot <- agg_trend_plot_emp(madison_agg, industry = "Food/Accommodataion",industry_code = "emp_food", corridor_name = "Madision Avenue .", construct_year = 2011, end_year = 2012)

prow <- plot_grid(madison_retail_trend_plot + theme(legend.position="none"),
                  madison_food_trend_plot + theme(legend.position="none"),
                  align = 'vh', hjust = -1, nrow = 1)

legend_b <- get_legend(madison_retail_trend_plot + theme(legend.position="bottom"))

plot_grid( prow, legend_b, ncol = 1, rel_heights = c(4, .2))

```

### Wage trend comparison

```{r, echo=FALSE, message=FALSE, warning=FALSE, fig.width = 9.5, fig.asp=.5}

# add a new function to draw plots with 4 control corridors
agg_trend_plot_wage <- function(df_plot, industry, corridor_name, 
                                 industry_code = c("wage_retail", "wage_food"), 
                                 construct_year, end_year) {
  
  df_plot$Type <- factor(df_plot$Type, levels = rev(levels(df_plot$Type)))
  
  #convert year to proper date
  
  df_plot$year <-as.character(paste0(df_plot$year, "-01-01"))
  df_plot$year <- as.Date(df_plot$year, "%Y-%m-%d")

  construct_date <- as.character(paste0(construct_year, "-01-01"))
  construct_date <- as.Date(construct_date, "%Y-%m-%d")

  end_date <- as.character(paste0(end_year, "-01-01"))
  end_date <- as.Date(end_date, "%Y-%m-%d")

  #making the plot
  
  ats_df <- ggplot(df_plot, aes(x = year, y = get(industry_code), shape = Type, group = Type, colour = Type)) + 
    geom_line()  +
    geom_rect(aes(xmin = as.Date(construct_date, "%Y"), xmax = as.Date(end_date, "%Y"), ymin = -Inf, ymax = Inf),
              fill = "#adff2f",linetype=0,alpha = 0.03) +
    geom_point(size = 3, fill="white") +
    scale_shape_manual(values=c(22,21,21,21,21))+
    scale_x_date(date_breaks = "3 years", date_labels = "%Y") +
    theme_minimal() +
    labs(title = glue("{industry} Wage Comparison:\n {corridor_name}"), x="Year",y="Wage",
         caption = "Shaded area represents the construction period") +
    guides(title = "Street Type")
  
  return(ats_df)
}

madison_retail_trend_plot <- agg_trend_plot_wage(madison_agg, industry = "Retail", industry_code = "wage_retail", corridor_name = "Madison Avenue", construct_year = 2011, end_year = 2012)

madison_food_trend_plot <- agg_trend_plot_wage(madison_agg, industry = "Food/Accommodataion",industry_code = "wage_food", corridor_name = "Madision Avenue .", construct_year = 2011, end_year = 2012)

prow <- plot_grid(madison_retail_trend_plot + theme(legend.position="none"),
                  madison_food_trend_plot + theme(legend.position="none"),
                  align = 'vh', hjust = -1, nrow = 1)

legend_b <- get_legend(madison_retail_trend_plot + theme(legend.position="bottom"))

plot_grid( prow, legend_b, ncol = 1, rel_heights = c(4, .2))

```

### Establishment counts trend comparison

```{r, echo=FALSE, message=FALSE, warning=FALSE, fig.width = 9.5, fig.asp=.5}

# add a new function to draw plots with 4 control corridors
agg_trend_plot_estb <- function(df_plot, industry, corridor_name, 
                                 industry_code = c("estb_retail", "estb_food"), 
                                 construct_year, end_year) {
  
  df_plot$Type <- factor(df_plot$Type, levels = rev(levels(df_plot$Type)))
  
  #convert year to proper date
  
  df_plot$year <-as.character(paste0(df_plot$year, "-01-01"))
  df_plot$year <- as.Date(df_plot$year, "%Y-%m-%d")

  construct_date <- as.character(paste0(construct_year, "-01-01"))
  construct_date <- as.Date(construct_date, "%Y-%m-%d")

  end_date <- as.character(paste0(end_year, "-01-01"))
  end_date <- as.Date(end_date, "%Y-%m-%d")

  #making the plot
  
  ats_df <- ggplot(df_plot, aes(x = year, y = get(industry_code), shape = Type, group = Type, colour = Type)) + 
    geom_line()  +
    geom_rect(aes(xmin = as.Date(construct_date, "%Y"), xmax = as.Date(end_date, "%Y"), ymin = -Inf, ymax = Inf),
              fill = "#adff2f",linetype=0,alpha = 0.03) +
    geom_point(size = 3, fill="white") +
    scale_shape_manual(values=c(22,21,21,21,21))+
    scale_x_date(date_breaks = "3 years", date_labels = "%Y") +
    theme_minimal() +
    labs(title = glue("{industry} Establishment Comparison:\n {corridor_name}"), x="Year",y="The number of establishment",
         caption = "Shaded area represents the construction period") +
    guides(title = "Street Type")
  
  return(ats_df)
}

madison_retail_trend_plot <- agg_trend_plot_estb(madison_agg, industry = "Retail", industry_code = "estb_retail", corridor_name = "Madison Avenue", construct_year = 2011, end_year = 2012)

madison_food_trend_plot <- agg_trend_plot_estb(madison_agg, industry = "Food/Accommodataion",industry_code= "estb_food", corridor_name = "Madision Avenue .", construct_year = 2011, end_year = 2012)

prow <- plot_grid(madison_retail_trend_plot + theme(legend.position="none"),
                  madison_food_trend_plot + theme(legend.position="none"),
                  align = 'vh', hjust = -1, nrow = 1)

legend_b <- get_legend(madison_retail_trend_plot + theme(legend.position="bottom"))

plot_grid( prow, legend_b, ncol = 1, rel_heights = c(4, .2))

```

## Broad Avenue

### Employment trend comparison

```{r, echo=FALSE, message=FALSE, warning=FALSE, fig.width = 9.5, fig.asp=.5}

broad_agg <- agg_trend_table_qcew (memphis_qcew, group = 2)

broad_retail_trend_plot <- agg_trend_plot_emp(broad_agg, industry = "Retail", industry_code = "emp_retail", corridor_name = "Broad Avenue", construct_year = 2011, end_year = 2012)

broad_food_trend_plot <- agg_trend_plot_emp(broad_agg, industry = "Food/Accommodataion",industry_code = "emp_food", corridor_name = "Broad Avenue .", construct_year = 2011, end_year = 2012)

prow <- plot_grid(broad_retail_trend_plot + theme(legend.position="none"),
                  broad_food_trend_plot + theme(legend.position="none"),
                  align = 'vh', hjust = -1, nrow = 1)

legend_b <- get_legend(broad_retail_trend_plot + theme(legend.position="bottom"))

plot_grid( prow, legend_b, ncol = 1, rel_heights = c(4, .2))

```

### Wage trend comparison

```{r, echo=FALSE, message=FALSE, warning=FALSE, fig.width = 9.5, fig.asp=.5}

broad_retail_trend_plot <- agg_trend_plot_wage(broad_agg, industry = "Retail", industry_code = "wage_retail", corridor_name = "Broad Avenue", construct_year = 2011, end_year = 2012)

broad_food_trend_plot <- agg_trend_plot_wage(broad_agg, industry = "Food/Accommodataion",industry_code = "wage_food", corridor_name = "Broad Avenue .", construct_year = 2011, end_year = 2012)

prow <- plot_grid(broad_retail_trend_plot + theme(legend.position="none"),
                  broad_food_trend_plot + theme(legend.position="none"),
                  align = 'vh', hjust = -1, nrow = 1)

legend_b <- get_legend(broad_retail_trend_plot + theme(legend.position="bottom"))

plot_grid( prow, legend_b, ncol = 1, rel_heights = c(4, .2))

```

### Establishment counts trend comparison

```{r, echo=FALSE, message=FALSE, warning=FALSE, fig.width = 9.5, fig.asp=.5}

broad_retail_trend_plot <- agg_trend_plot_estb(broad_agg, industry = "Retail", industry_code = "estb_retail", corridor_name = "Broad Avenue", construct_year = 2011, end_year = 2012)

broad_food_trend_plot <- agg_trend_plot_estb(broad_agg, industry = "Food/Accommodataion",industry_code= "estb_food", corridor_name = "Broad Avenue .", construct_year = 2011, end_year = 2012)

prow <- plot_grid(broad_retail_trend_plot + theme(legend.position="none"),
                  broad_food_trend_plot + theme(legend.position="none"),
                  align = 'vh', hjust = -1, nrow = 1)

legend_b <- get_legend(broad_retail_trend_plot + theme(legend.position="bottom"))

plot_grid( prow, legend_b, ncol = 1, rel_heights = c(4, .2))

```