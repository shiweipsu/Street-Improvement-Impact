---
title: "San Francisco Corridors"
author: "Wei Shi"
date: "November 5, 2018"
output:
  word_document: default
  pdf_document:
    includes:
      in_header: header.tex
    number_sections: true
fig_width: 7
fig_height: 5
---

```{r setup,include=FALSE}

knitr::opts_chunk$set(cache = TRUE)
```

## load data

```{r message=FALSE, warning=FALSE, include=FALSE}

if(!require(pacman)){install.packages("pacman"); library(pacman)}
p_load(here, RPostgreSQL, sf, ggplot2, directlabels,ggthemes, tidyverse, dbplyr, stargazer,cowplot, lubridate, data.table)

#query the corridors from bike_lanes
user <- "shiwei"
host <- "pgsql102.rc.pdx.edu"
pw <- scan(here::here("batteries.pgpss"), what = "")
dbname <- "bike_lanes"

con <- dbConnect("PostgreSQL", host = host, user = user, dbname = dbname, 
                 password = pw, port = 5433)

source(here::here("Code/corridor_comparison_functions.R"))

sf_corridor <- st_read(dsn = con, query = "select a.geoid10 as geoid, a.c000 as c000,
                       a.cns07 as cns07, a.cns08 as cns08, a.cns12 as cns12, a.cns14 as cns14, a.cns15 as cns15, 
                       a.cns16 as cns16, a.cns17 as cns17, a.cns18 as cns18, a.cns19 as cns19, a.ce01 as ce01, a.ce02 as ce02, a.ce03 as ce03, a.cr01 as cr01,a.cr02 as cr02, a.cr03 as cr03, a.cr04 as cr04, a.cr05 as cr05, a.cr07 as cr07, a.cs02 as cs02, a.cd01 as cd01, a.cd02 as cd02, a.cd02 as cd03, a.cd04 as cd04, b.type as Type, b.FULLNAME as name, b.buildstart as buildstart, b.buildend as buildend, b.group as corridor_group, a.year as year, a.geometry
                       FROM sf_lehd a, sf_corridor b
                       WHERE ST_Intersects(ST_Buffer(b.geometry, 20), a.geometry);")

sf_corridor[sf_corridor$name =="Polk St",]$type <- "Treatment: Polk"
sf_corridor[sf_corridor$name=="Van Ness Ave",]$type <- "Control: Van Ness"
sf_corridor[sf_corridor$name =="17th St",]$type <- "Treatment: 17th St"
sf_corridor[sf_corridor$name=="18th St",]$type <- "Control: 18th St"
sf_corridor$type <- as.factor(sf_corridor$type)

sf_corridor <- sf_corridor %>%
  rename(C000 = c000, CNS07 = cns07, CNS08 = cns08, CNS12 = cns12, CNS14 = cns14, CNS15 = cns15,
         CNS16 = cns16, CNS17 = cns17, CNS18 = cns18, CNS19 = cns19, CE01=ce01, CE02=ce02, 
         CE03=ce03, CR01=cr01, CR02=cr02, CR03=cr03, CR04=cr04, CR05=cr05, CR07=cr07, CS02=cs02, 
         CD01=cd01, CD02=cd02, CD03=cd03, CD04=cd04,
         Group=corridor_group, BuildStart = buildstart, BuildEnd = buildend, Name = name, Type=type)

sf_lehd <- st_read(dsn = con, query = "SELECT * FROM sf_lehd") %>% as.data.frame() %>% 
  rename(C000 = c000, CNS07 = cns07, CNS18 = cns18, CNS12 = cns12, CNS14 = cns14, CNS15 = cns15,
         CNS16 = cns16, CNS17 = cns17, CNS18 = cns18, CNS19 = cns19, CE01=ce01, CE02=ce02, 
         CE03=ce03, CR01=cr01, CR02=cr02, CR03=cr03, CR04=cr04, CR05=cr05, CR07=cr07, CS02=cs02,
         CD01=cd01, CD02=cd02, CD03=cd03, CD04=cd04)

sf_corridor_rac <- st_read(dsn = con, query = "select a.geoid10 as geoid, a.c000 as c000,
                           a.cns07 as cns07, a.cns08 as cns08, a.cns12 as cns12, a.cns14 as cns14, a.cns15 as cns15, 
                           a.cns16 as cns16, a.cns17 as cns17, a.cns18 as cns18, a.cns19 as cns19, a.ce01 as ce01, a.ce02 as ce02, a.ce03 as ce03, a.cr01 as cr01,a.cr02 as cr02, a.cr03 as cr03, a.cr04 as cr04, a.cr05 as cr05, a.cr07 as cr07, a.cs02 as cs02, a.cd01 as cd01, a.cd02 as cd02, a.cd03 as cd03, a.cd04 as cd04, b.fullname as Name, b.type as Type, b.buildstart as buildstart, b.buildend as buildend, b.group as corridor_group, a.year as year, a.geometry
                           FROM sf_rac a, sf_corridor b
                           WHERE ST_Intersects(ST_Buffer(b.geometry, 20), a.geometry);")

sf_corridor_rac[sf_corridor_rac$name =="Van Ness Ave",]$type <- "Control: Van Ness"
sf_corridor_rac[sf_corridor_rac$name=="Polk St",]$type <- "Treatment: Polk"
sf_corridor_rac[sf_corridor_rac$name =="18th St",]$type <- "Control: 18th St"
sf_corridor_rac[sf_corridor_rac$name=="17th St",]$type <- "Treatment: 17th St"
sf_corridor_rac$type <- as.factor(sf_corridor_rac$type)

sf_corridor_rac <- sf_corridor_rac %>%
  rename(C000 = c000, CNS07 = cns07, CNS08 = cns08, CNS12 = cns12, CNS14 = cns14, CNS15 = cns15,
         CNS16 = cns16, CNS17 = cns17, CNS18 = cns18, CNS19 = cns19, CE01=ce01, CE02=ce02, 
         CE03=ce03, CR01=cr01, CR02=cr02, CR03=cr03, CR04=cr04, CR05=cr05, CR07=cr07, CS02=cs02,
         CD01=cd01, CD02=cd02, CD03=cd03, CD04=cd04,
         Group=corridor_group, BuildStart = buildstart, BuildEnd = buildend, Name = name, Type=type)


sf_rac <- st_read(dsn = con, query = "SELECT * FROM sf_rac") %>% as.data.frame() %>% 
  rename(C000 = c000, CNS07 = cns07, CNS18 = cns18, CNS12 = cns12, CNS14 = cns14, CNS15 = cns15,
         CNS16 = cns16, CNS17 = cns17, CNS18 = cns18, CNS19 = cns19, CE01=ce01, CE02=ce02, 
         CE03=ce03, CR01=cr01, CR02=cr02, CR03=cr03, CR04=cr04, CR05=cr05, CR07=cr07, CS02=cs02,
         CD01=cd01, CD02=cd02, CD03=cd03, CD04=cd04)

sf_emp_ratio <- employ_ratio_test(sf_corridor)

sf_growth <- growth_rate(sf_corridor)

# load nets
sf_nets <- st_read(dsn = con, query = "select * FROM nets") %>% filter(city =="SAN FRANCISCO")

sf_blocks <- left_join(as.data.frame(sf_corridor), unique(sf_lehd[,c(1,56)]), by =c("geoid" = "geoid10")) %>% 
  mutate(geometry.x=NULL, geometry=geometry.y, geometry.y=NULL) %>% st_sf

sf_nets_b <- st_join(sf_nets, unique(sf_blocks[,c(26:30,32)]) %>% st_sf, join=st_intersects, left=F)  
names(sf_nets_b)  <- tolower(names(sf_nets_b))

sf_nets_bf <- st_read(dsn = con, query = "select * FROM nets a, sf_corridor b
WHERE ST_Intersects(ST_Buffer(b.geometry, 20), a.geometry);")


 sf_polk_b <- sf_nets_b %>% 
  filter(group==1) %>% 
  gather(key, value, -c(1:10,89:97)) %>% 
  separate(key, c("retail", "year"), sep=-2) %>% 
  spread(retail, value) %>% 
  mutate(biz1 = case_when(substr(naics,1,3) %in% c(441:454) ~ "Retail",
                               substr(naics,1,3) %in% c(722) ~ "Food"),
         year = ifelse(as.numeric(year)<16, paste0("20",year), paste0("19",year)))
 
 sf_polk_bf <- sf_nets_bf %>% 
  filter(group==1) %>% 
  gather(key, value, -c(1:10,89:97)) %>% 
  separate(key, c("retail", "year"), sep=-2) %>% 
  spread(retail, value) %>% 
  mutate(biz2 = case_when((substr(naics,1,3) %in% c(443,445,446,448,451,452,453)|substr(naics,1,4) %in% c(8121,8123,8129)) ~ "Retail",
                               substr(naics,1,4) %in% c(7224,7225) ~ "Food"),
         year = ifelse(as.numeric(year)<16, paste0("20",year), paste0("19",year)))
 
 sf_sev_b <- sf_nets_b %>% 
  filter(group==2) %>% 
  gather(key, value, -c(1:10,89:97)) %>% 
  separate(key, c("retail", "year"), sep=-2) %>% 
  spread(retail, value) %>% 
  mutate(biz1 = case_when(substr(naics,1,3) %in% c(441:454) ~ "Retail",
                               substr(naics,1,3) %in% c(722) ~ "Food"),
         year = ifelse(as.numeric(year)<16, paste0("20",year), paste0("19",year)))
 
 sf_sev_bf <- sf_nets_bf %>% 
  filter(group==2) %>% 
  gather(key, value, -c(1:10,89:97)) %>% 
  separate(key, c("retail", "year"), sep=-2) %>% 
  spread(retail, value) %>% 
  mutate(biz2 = case_when((substr(naics,1,3) %in% c(443,445,446,448,451,452,453)|substr(naics,1,4) %in% c(8121,8123,8129)) ~ "Retail",
                               substr(naics,1,4) %in% c(7224,7225) ~ "Food"),
         year = ifelse(as.numeric(year)<16, paste0("20",year), paste0("19",year)))

# nets <- st_read(dsn = con, query = "select * from nets") %>% filter (city == "SAN FRANCISCO")

nets <- setDT(sf_nets)
nets <- setkey(nets, dunsnumber)
nets_long <- melt(nets, id.vars = c("dunsnumber", "city"),
                  measure.vars = 11:88,
                  variable.factor = TRUE)

sf_nets_a <- nets_long %>% 
  separate(variable, c("retail", "year"), sep=-2) %>% 
  spread(retail, value) %>% 
  mutate(biz1 = case_when(substr(naics,1,3) %in% c(441:454) ~ "Retail",
                               substr(naics,1,3) %in% c(722) ~ "Food"),
         biz2 = case_when((substr(naics,1,3) %in% c(443,445,446,448,451,452,453)|substr(naics,1,4) %in% c(8121,8123,8129)) ~ "Retail",
                               substr(naics,1,4) %in% c(7224,7225) ~ "Food"),
         year = ifelse(as.numeric(year)<16, paste0("20",year), paste0("19",year)))

nets_biz1 <- sf_nets_a %>% 
  group_by(year, biz1) %>% 
  summarise(emp = sum(emp, na.rm = T), sales= sum(sales, na.rm = T), n=n(),
            emp_pest = emp/n, sales_pest = sales/n) %>% drop_na(.)

nets_biz2 <- sf_nets_a %>% 
  group_by(year, biz2) %>% 
  summarise(emp = sum(emp, na.rm = T), sales= sum(sales, na.rm = T), n=n(),
            emp_pest = emp/n, sales_pest = sales/n) %>% drop_na(.)


dbDisconnect(con)

```


# corridor comparison
```{r message=FALSE, warning=FALSE, include=FALSE}

#comparisons-----
## polk street
# prepare city level data & block level corridor data at the year before construction
conyear <- first(filter(sf_corridor, Group== 1, Type== "Treatment: Polk")$BuildStart)-1 
# find the year before construction

sf_lehd_2008 <- sf_lehd %>% filter(year == conyear, CNS07+ CNS18 > 0)
polk <- sf_corridor %>% filter(Group ==1, Type =="Treatment: Polk", year==conyear) %>% employ_ratio_test(.)
vanness <- sf_corridor %>% filter(Group ==1, Type =="Control: Van Ness", year ==conyear) %>% employ_ratio_test(.)

# find quantile dataframe 
p <- seq(0,1, by = .05)
quant_df <- data.frame(q_tot_emp = quantile(sf_lehd_2008$C000, probs = p, na.rm = TRUE),
                       q_retail = quantile(sf_lehd_2008$CNS07, probs = p, na.rm = TRUE),
                       q_food_accom = quantile(sf_lehd_2008$CNS18, probs = p, na.rm = TRUE),
                       probs = p)

polk %>% summarise(TotEmp = sum(C000)/nrow(polk), RetailEmp = sum(CNS07)/nrow(polk),
                                     AccomEmp = sum(CNS18)/nrow(polk)) %>% as.data.frame()
vanness %>% summarise(TotEmp = sum(C000)/nrow(vanness), RetailEmp = sum(CNS07)/nrow(vanness),
                                     AccomEmp = sum(CNS18)/nrow(vanness)) %>% as.data.frame
sf_lehd_2008 %>% summarise(TotEmp = sum(C000)/nrow(sf_lehd_2008), RetailEmp = sum(CNS07)/nrow(sf_lehd_2008),
                                     AccomEmp = sum(CNS18)/nrow(sf_lehd_2008)) %>% as.data.frame()

# get employment at block level, divided by nrow()
 

# t-test: compare retail, food_accom, business amount---
t.test(polk$Business, vanness$Business)
t.test(polk$Retail, vanness$Retail)
t.test(polk$Food_Accom, vanness$Food_Accom)
t.test(polk$ratio1, vanness$ratio1)
t.test(polk$ratio2, vanness$ratio2)

# t-tests: growth rate----
sf_growth <- growth_rate(filter(sf_corridor, Group==1))

polk_growth <- sf_growth %>%  
  mutate(year=as.numeric(as.character(year))) %>% 
  filter(Group==1, Type=="Treatment: Polk", year<=conyear) 
vanness_growth <- sf_growth %>%  
  mutate(year=as.numeric(as.character(year))) %>% 
  filter(Group==1, Type=="Control: Van Ness", year<=conyear) 

t.test(polk_growth$biz_growth,vanness_growth$biz_growth)
t.test(polk_growth$retail_growth,vanness_growth$retail_growth)
t.test(polk_growth$food_accom_growth,vanness_growth$food_accom_growth)


## 17th street
# prepare city level data & block level corridor data at the year before construction
conyear <- first(filter(sf_corridor, Group== 2, Type== "Treatment: 17th St")$BuildStart)-1 
# find the year before construction

sf_lehd_2010 <- sf_lehd %>% filter(year == conyear, CNS07+ CNS18 > 0)
sevth <- sf_corridor %>% filter(Group ==2, Type =="Treatment: 17th St", year==conyear) %>% employ_ratio_test(.)
eigth <- sf_corridor %>% filter(Group ==2, Type =="Control: 18th St", year ==conyear) %>% employ_ratio_test(.)


# find quantile dataframe 

p <- seq(0,1, by = .05)
quant_df <- data.frame(q_tot_emp = quantile(sf_lehd_2010$C000, probs = p, na.rm = TRUE),
                       q_retail = quantile(sf_lehd_2010$CNS07, probs = p, na.rm = TRUE),
                       q_food_accom = quantile(sf_lehd_2010$CNS18, probs = p, na.rm = TRUE),
                       probs = p)

sevth %>% summarise(TotEmp = sum(C000)/nrow(sevth), RetailEmp = sum(CNS07)/nrow(sevth),
                                     AccomEmp = sum(CNS18)/nrow(sevth)) %>% as.data.frame()
eigth %>% summarise(TotEmp = sum(C000)/nrow(eigth), RetailEmp = sum(CNS07)/nrow(eigth),
                                     AccomEmp = sum(CNS18)/nrow(eigth)) %>% as.data.frame
sf_lehd_2010 %>% summarise(TotEmp = sum(C000)/nrow(sf_lehd_2010), RetailEmp = sum(CNS07)/nrow(sf_lehd_2010),
                                     AccomEmp = sum(CNS18)/nrow(sf_lehd_2010)) %>% as.data.frame()

# get employment at block level, divided by nrow()
 

# t-test: compare retail, food_accom, business amount---
t.test(sevth$Business, eigth$Business)
t.test(sevth$Retail, eigth$Retail)
t.test(sevth$Food_Accom, eigth$Food_Accom)
t.test(sevth$ratio1, eigth$ratio1)
t.test(sevth$ratio2, eigth$ratio2)

# t-tests: growth rate----
sf_growth <- growth_rate(filter(sf_corridor, Group==2))

sevth_growth <- sf_growth %>%  
  mutate(year=as.numeric(as.character(year))) %>% 
  filter(Group==2, Type=="Treatment: 17th St", year<=conyear) 
eigth_growth <- sf_growth %>%  
  mutate(year=as.numeric(as.character(year))) %>% 
  filter(Group==2, Type=="Control: 18th St", year<=conyear) 

t.test(sevth_growth$biz_growth,eigth_growth$biz_growth)
t.test(sevth_growth$retail_growth,eigth_growth$retail_growth)
t.test(sevth_growth$food_accom_growth,eigth_growth$food_accom_growth)
```

# plot trend
```{r, echo=FALSE, message=FALSE, warning=FALSE, fig.width = 9.5, fig.asp=.5}
# polk
polk_agg <- agg_trend_table(sf_corridor, group = 1)

polk_agg_retail_trend_plot <- agg_trend_plot(polk_agg, industry = "Retail", industry_code = "CNS07", corridor_name = "Polk Street", construct_year = 2009, end_year = 2010)

polk_agg_food_trend_plot <- agg_trend_plot(polk_agg, industry = "Food/Accommodataion",industry_code = "CNS18", corridor_name = "Polk Street", construct_year = 2009, end_year = 2010)

prow <- plot_grid(polk_agg_retail_trend_plot + theme(legend.position="none"),
                  polk_agg_food_trend_plot + theme(legend.position="none"), align = 'vh', hjust = -1, nrow = 1)
legend_b <- get_legend(polk_agg_retail_trend_plot + theme(legend.position="bottom"))
plot_grid(prow, legend_b, ncol = 1, rel_heights = c(4, .2))

# 17th st
sevth_agg <- agg_trend_table(sf_corridor, group = 2)

sevth_agg_retail_trend_plot <- agg_trend_plot(sevth_agg, industry = "Retail", industry_code = "CNS07", corridor_name = "17th Street", construct_year = 2011, end_year = 2012)

sevth_agg_food_trend_plot <- agg_trend_plot(sevth_agg, industry = "Food/Accommodataion",industry_code = "CNS18", corridor_name = "17th Street", construct_year = 2011, end_year = 2012)

prow <- plot_grid(sevth_agg_retail_trend_plot + theme(legend.position="none"),
                  sevth_agg_food_trend_plot + theme(legend.position="none"), align = 'vh', hjust = -1, nrow = 1)

legend_b <- get_legend(sevth_agg_retail_trend_plot + theme(legend.position="bottom"))

plot_grid(prow, legend_b, ncol = 1, rel_heights = c(4, .2))
```

## trend analysis - plot
```{r echo=FALSE, fig.asp=0.5, fig.width=9.5, message=FALSE, warning=FALSE}
# polk
polk_agg <- agg_index_trend_table(sf_corridor, group = 1, construct_year = 2009)
polk_agg$Type <- as.character(polk_agg$Type)
sf <- sf_lehd %>% group_by(year) %>%
  summarise(CNS07 = sum(CNS07),
            CNS18 = sum(CNS18),
            business = CNS07 + CNS18) %>%
  mutate(CNS07_sd = CNS07/380.6, # dividied by employment in 2009 in CNS07, CNS18 and business
         CNS18_sd = CNS18/520.04,
         business_sd = business/900.64,
         Type = "City") %>%
  select(Type, year, CNS07_sd, CNS18_sd, business_sd)
polk_agg <- rbind(as.data.frame(polk_agg), as.data.frame(sf))
polk_agg$Type <- as.factor(as.character(polk_agg$Type))

polk_agg_retail_plot <- agg_index_trend_plot(polk_agg, industry = "Retail", corridor_name = "Polk Ave.",industry_code = "CNS07_sd", construct_year = 2009, end_year = 2010)
polk_agg_food_plot <- agg_index_trend_plot(polk_agg, industry = "Food/Accommodations", corridor_name = "Polk Ave.",industry_code = "CNS18_sd", construct_year = 2009, end_year = 2010)

prow <- plot_grid(polk_agg_retail_plot + theme(legend.position="none"),
                  polk_agg_food_plot + theme(legend.position="none"), align = 'vh', hjust = -1, nrow = 1)
legend_b <- get_legend(polk_agg_retail_plot + theme(legend.position="bottom"))
plot_grid(prow, legend_b, ncol = 1, rel_heights = c(3, .2))

# 17th st
sevth_agg <- agg_index_trend_table(sf_corridor, group = 2, construct_year = 2011)
sf <- sf_lehd %>% group_by(year) %>%
  summarise(CNS07 = sum(CNS07),
            CNS18 = sum(CNS18),
            business = CNS07 + CNS18) %>%
  mutate(CNS07_sd = CNS07/387.68,
         CNS18_sd = CNS18/550.50,
         business_sd = business/938.18,
         Type = "City") %>%
  select(Type, year, CNS07_sd, CNS18_sd, business_sd)
sevth_agg <- rbind(as.data.frame(sevth_agg), as.data.frame(sf))
sevth_agg$Type <- as.factor(as.character(sevth_agg$Type))

sevth_agg_retail_plot <- agg_index_trend_plot(sevth_agg, industry = "Retail", corridor_name = "sevth Ave.",industry_code = "CNS07_sd", construct_year = 2011, end_year = 2012)
sevth_agg_food_plot <- agg_index_trend_plot(sevth_agg, industry = "Food/Accommodations", corridor_name = "sevth Ave.",industry_code = "CNS18_sd", construct_year = 2011, end_year = 2012)

prow <- plot_grid(sevth_agg_retail_plot + theme(legend.position="none"),
                  sevth_agg_food_plot + theme(legend.position="none"), align = 'vh', hjust = -1, nrow = 1)
legend_b <- get_legend(sevth_agg_retail_plot + theme(legend.position="bottom"))
plot_grid(prow, legend_b, ncol = 1, rel_heights = c(3, .2))
```

## trend analysis - table
```{r echo=FALSE, fig.asp=0.5, fig.width=9.5, message=FALSE, warning=FALSE}

# compute post change table compare to base year
polk_agg %>% 
  filter (year %in% c(2009, 2010, 2011, 2012)) %>% 
  group_by(Type) %>% 
  mutate(retail_growth =(CNS07_sd/lag(CNS07_sd)-1)*100,
         food_accom_growth = (CNS18_sd/lag(CNS18_sd)-1)*100)

sevth_agg %>% 
  filter (year %in% c(2011, 2012, 2013, 2014)) %>% 
  group_by(Type) %>% 
  mutate(retail_growth =(CNS07_sd/lag(CNS07_sd)-1)*100,
         food_accom_growth = (CNS18_sd/lag(CNS18_sd)-1)*100)
  
  
```


# model
```{r, echo=FALSE, results='asis'}

sf_corridor<- sf_corridor %>% mutate (Type = case_when(Name == "17th St"| Name == "Polk St"|Name == "Valencia St"~ "Treatment", 
                                                       TRUE ~ "Control"),
                                      Type = as.factor(Type))
sf_corridor$Type <- relevel(sf_corridor$Type,ref = ("Treatment"))

#polk ave

polk_agg_did <- did_agg_analysis(sf_corridor, group = 1, endyear = 2010)
stargazer(polk_agg_did[[1]], polk_agg_did[[2]], polk_agg_did[[3]], 
          title = "Polk Ave. Corridor Difference-in-Difference Estimates", 
          column.labels  = c("Retail Emp.", "Accomodations Emp.", "'Business' Emp."), type = "text")

polk_agg_its <- agg_its_analysis(sf_corridor, group = 1, endyear = 2010)
stargazer(polk_agg_its[[1]], polk_agg_its[[2]], polk_agg_its[[3]], 
          title = "Polk Ave. Corridor Interrupted Time Series Estimates", 
          column.labels  = c("Retail Emp.", "Accomodations Emp.", "'Business' Emp."), type = "text")

# 17th street
sevth_agg_did <- did_agg_analysis(sf_corridor, group = 2, endyear = 2012)
stargazer(sevth_agg_did[[1]], sevth_agg_did[[2]], sevth_agg_did[[3]], 
          title = "17th St. Corridor Difference-in-Difference Estimates", 
          column.labels  = c("Retail Emp.", "Accomodations Emp.", "'Business' Emp."), type = "text")

sevth_agg_its <- agg_its_analysis(sf_corridor, group = 2, endyear = 2012)
stargazer(sevth_agg_its[[1]], sevth_agg_its[[2]], sevth_agg_its[[3]], 
          title = "17th St. Corridor Interrupted Time Series Estimates", 
          column.labels  = c("Retail Emp.", "Accomodations Emp.", "'Business' Emp."), type = "text")


```

# Retail sales
```{r, echo=FALSE, message=FALSE, warning=FALSE, fig.width = 9.5, fig.asp=.5}
sf_sales <- read.csv("Data/sanfrancisco/SFMTA Data_Polk2009.csv")

sf_sales <- sf_sales %>% 
  mutate(sale = case_when(YEAR==2013 ~ (SumOfQTR01+SumOfQTR02+SumOfQTR03)/3*4,
                          YEAR!=2013 ~ (SumOfQTR01+SumOfQTR02+SumOfQTR03+SumOfQTR04))) %>% 
  select(Name, YEAR, MTASEGDESC, sale, Group)

sf_sale <- sf_sales %>% spread(MTASEGDESC, sale) %>% 
  rename(Retail = 'Hardware/Furniture/Commercial/Industrial',
         year = YEAR) %>% 
  mutate(CNS18 = Restaurants,
         CNS07 = Retail + Other,
         Type = case_when(Name == "City" ~ "City",
                          Name == "Polk" ~ "Treatment: Polk",
                          Name == "Van Ness" ~ "Control: Van Ness"),
         Group=1,
         geometry = "geometry")

polk_sale <- agg_index_trend_table(sf_sale, group = 1, construct_year = 2009)
polk_sale$Type <- as.factor(polk_sale$Type)

polk_agg_retail_plot <- trend_plot(polk_sale, industry = "Retail", corridor_name = "Polk St.",industry_code = "CNS07_sd", construct_year = 2009, end_year = 2010, y_lable = "Sales", index = "Indexed")
polk_agg_food_plot <- trend_plot(polk_sale, industry = "Food", corridor_name = "Polk St.",industry_code = "CNS18_sd", construct_year = 2009, end_year = 2010, y_lable = "Sales", index = "Indexed")

plot_grid(polk_agg_retail_plot,polk_agg_food_plot)
prow <- plot_grid(polk_agg_retail_plot + theme(legend.position="none"),
                  polk_agg_food_plot + theme(legend.position="none"), align = 'vh', hjust = -1, nrow = 1)
legend_b <- get_legend(polk_agg_retail_plot + theme(legend.position="bottom"))
plot_grid(prow, legend_b, ncol = 1, rel_heights = c(3, .2))

# compute post change table compare to base year
post_change <- polk_sale %>% 
  filter (year %in% c(2009, 2010, 2011, 2012)) %>% 
  group_by(Type) %>% 
  mutate(retail_growth =(CNS07_sd/lag(CNS07_sd)-1)*100,
         food_accom_growth = (CNS18_sd/lag(CNS18_sd)-1)*100)
  
```

# sales model
```{r, echo=FALSE, results='asis'}

sf_sale$Type <- relevel(as.factor(sf_sale$Type),ref = "Treatment: Polk")
sf_sale <- filter(sf_sale, Type!="City")

polk_agg_did <- did_agg_analysis(sf_sale, group = 1, endyear = 2010)
stargazer(polk_agg_did[[1]], polk_agg_did[[2]], polk_agg_did[[3]], 
          title = "polk & Oak Ave. Corridor Difference-in-Difference Estimates", 
          column.labels  = c("Retail Emp.", "Accomodations Emp.", "'Business' Emp."), type = "text")

sf_sale <- mutate(sf_sale, Type = ifelse(Type=="Treatment: Polk" ,"Treatment", "Control: Van Ness"))
polk_agg_its <- agg_its_analysis(sf_sale, group = 1, endyear = 2010)
stargazer(polk_agg_its[[1]], polk_agg_its[[2]], polk_agg_its[[3]], 
          title = "polk & Oak Ave. Corridor Interrupted Time Series Estimates", 
          column.labels  = c("Retail Emp.", "Accomodations Emp.", "'Business' Emp."), type = "text")
```


# NETS analysis
# Polk
## trend plot - industry type 1
```{r, echo=FALSE, message=FALSE, warning=FALSE, fig.width = 9.5, fig.asp=1.3}
# one types of industry categories similar to LEHD
polk_nets_b <- sf_polk_b %>% 
  group_by(name, type, buildstart, buildend, group, year, biz1) %>% 
  summarise(emp = sum(emp), sales= sum(sales), n=n(),
            emp_pest = emp/n, sales_pest = sales/n) %>% filter(biz1==c("Food", "Retail")) %>%
 as.data.frame(.) %>% select(-geometry)

nets_biz1 <- nets_biz1 %>% 
  mutate(name="city", type="City", buildstart=0, buildend=0, group=1) %>% select(name:group, year:sales_pest) %>% as.data.frame(.)

polk_nets_b <- rbind(polk_nets_b, nets_biz1) %>% mutate(geometry=0)

# employment plot
# abousolute employment
polk_nets1_emp <- polk_nets_b %>% select(-sales, -n, -emp_pest, -sales_pest) %>% 
  spread(key = biz1, emp) %>% 
  rename(CNS07 = Retail, CNS18 = Food, Group=group, Type= type)
polk_nets1_emp $Type <- as.factor(polk_nets1_emp $Type)

polk_emp_retail_trend_plot <- trend_plot(filter(polk_nets1_emp, Type!="City"), industry = "Retail", industry_code = "CNS07", corridor_name = "Polk Street", construct_year = 2009, end_year = 2010, y_lable = "Employment", index = "Total")

polk_emp_food_trend_plot <- trend_plot(filter(polk_nets1_emp, Type!="City"), industry = "Food",industry_code = "CNS18", corridor_name = "Polk Street", construct_year = 2009, end_year = 2010, y_lable = "Employment", index = "Total")

# there are two food restraunt close in 1966 and 2002 seperately with over 100 employment

# employment per establishment
polk_nets1_emp_pest <- polk_nets_b %>% select(-sales, -n, -emp, -sales_pest) %>% spread(key = biz1, emp_pest) %>% 
  rename(CNS07_pest = Retail, CNS18_pest = Food, Group=group, Type= type)
polk_nets1_emp_pest $Type <- as.factor(polk_nets1_emp_pest $Type)

polk_emp_pest_retail_trend_plot <- trend_plot(polk_nets1_emp_pest, industry = "Retail", industry_code = "CNS07_pest", corridor_name = "Polk Street", construct_year = 2009, end_year = 2010, y_lable = "Employment", index = "Per Establishment")

polk_emp_pest_food_trend_plot <- trend_plot(polk_nets1_emp_pest, industry = "Food",industry_code = "CNS18_pest", corridor_name = "Polk Street", construct_year = 2009, end_year = 2010, y_lable = "Employment", index = "Per Establishment")

# indexed employment
polk_nets1_emp_idx <- agg_index_trend_table(polk_nets1_emp, group = 1, construct_year = 2009)
polk_nets1_emp_idx $Type <- as.factor(polk_nets1_emp_idx $Type)

polk_emp_retail_indexed_trend_plot <- trend_plot(polk_nets1_emp_idx, industry = "Retail", industry_code = "CNS07_sd", corridor_name = "Polk Street", construct_year = 2009, end_year = 2010, y_lable = "Employment", index = "Indexed")

polk_emp_food_indexed_trend_plot <- trend_plot(polk_nets1_emp_idx, industry = "Food",industry_code = "CNS18_sd", corridor_name = "Polk Street", construct_year = 2009, end_year = 2010, y_lable = "Employment", index = "Indexed")

prow <- plot_grid(polk_emp_retail_trend_plot + theme(legend.position="none"),
                  polk_emp_food_trend_plot + theme(legend.position="none"),
                  polk_emp_pest_retail_trend_plot + theme(legend.position="none"),
                  polk_emp_pest_food_trend_plot + theme(legend.position="none"),
                  polk_emp_retail_indexed_trend_plot + theme(legend.position="none"),
                  polk_emp_food_indexed_trend_plot + theme(legend.position="none"), 
           align = 'vh', hjust = -1, nrow = 3)

legend_b <- get_legend(polk_emp_retail_indexed_trend_plot + theme(legend.position="bottom"))

plot_grid( prow, legend_b, ncol = 1, rel_heights = c(4, .2))

# sales plot
# abousolute sales
polk_nets1_sales <- polk_nets_b %>% select(-emp, -n, -emp_pest, -sales_pest) %>% spread(key = biz1, sales) %>% 
  rename(CNS07 = Retail, CNS18 = Food, Group=group, Type= type)
polk_nets1_sales $Type <- as.factor(polk_nets1_sales$Type)

polk_sales_retail_trend_plot <- trend_plot(filter(polk_nets1_sales, Type!="City"), industry = "Retail", industry_code = "CNS07", corridor_name = "Polk Street", construct_year = 2009, end_year = 2010, y_lable = "Sales", index = "Total")

polk_sales_food_trend_plot <- trend_plot(filter(polk_nets1_sales, Type!="City"), industry = "Food",industry_code = "CNS18", corridor_name = "Polk Street", construct_year = 2009, end_year = 2010, y_lable = "Sales", index = "Total")


# sales per establishment
polk_nets1_sales_pest <- polk_nets_b %>% select(-sales, -n, -emp, -emp_pest) %>% spread(key = biz1, sales_pest) %>% 
  rename(CNS07_pest = Retail, CNS18_pest = Food, Group=group, Type= type)
polk_nets1_sales_pest $Type <- as.factor(polk_nets1_sales_pest $Type)

polk_sales_pest_retail_trend_plot <- trend_plot(polk_nets1_sales_pest, industry = "Retail", industry_code = "CNS07_pest", corridor_name = "Polk Street", construct_year = 2009, end_year = 2010, y_lable = "Sales", index = "Per Establishment")

polk_sales_pest_food_trend_plot <- trend_plot(polk_nets1_sales_pest, industry = "Food",industry_code = "CNS18_pest", corridor_name = "Polk Street", construct_year = 2009, end_year = 2010, y_lable = "Sales", index = "Per Establishment")

# indexed sales
polk_nets1_sales_idx <- agg_index_trend_table(polk_nets1_sales, group = 1, construct_year = 2009)
polk_nets1_sales_idx $Type <- as.factor(polk_nets1_sales_idx $Type)

polk_sales_retail_indexed_trend_plot <- trend_plot(polk_nets1_sales_idx, industry = "Retail", industry_code = "CNS07_sd", corridor_name = "Polk Street", construct_year = 2009, end_year = 2010, y_lable = "Sales", index = "Indexed")

polk_sales_food_indexed_trend_plot <- trend_plot(polk_nets1_sales_idx, industry = "Food",industry_code = "CNS18_sd", corridor_name = "Polk Street", construct_year = 2009, end_year = 2010, y_lable = "Sales", index = "Indexed")

prow <- plot_grid(polk_sales_retail_trend_plot + theme(legend.position="none"),
                  polk_sales_food_trend_plot + theme(legend.position="none"),
                  polk_sales_pest_retail_trend_plot + theme(legend.position="none"),
                  polk_sales_pest_food_trend_plot + theme(legend.position="none"),
                  polk_sales_retail_indexed_trend_plot + theme(legend.position="none"),
                  polk_sales_food_indexed_trend_plot + theme(legend.position="none"), 
           align = 'vh', hjust = -1, nrow = 3)

legend_b <- get_legend(polk_sales_retail_indexed_trend_plot + theme(legend.position="bottom"))

plot_grid( prow, legend_b, ncol = 1, rel_heights = c(4, .2))


```

## trend plot - industry type 2
```{r, echo=FALSE, message=FALSE, warning=FALSE, fig.width = 9.5, fig.asp=1.3}
# one types of industry categories similar to LEHD
polk_nets_bf <- sf_polk_bf %>% 
  group_by(fullname, type, buildstart, buildend, group, year, biz2) %>% 
  summarise(emp = sum(emp), sales= sum(sales), n=n(),
            emp_pest = emp/n, sales_pest = sales/n) %>% filter(biz2==c("Food", "Retail")) %>%
 as.data.frame(.) %>% select(-geometry)

nets_biz2 <- nets_biz2 %>% 
  mutate(fullname="city", type="City", buildstart=0, buildend=0, group=1) %>% select(fullname:group, year:sales_pest) %>% as.data.frame(.)

polk_nets_bf <- rbind(polk_nets_bf, nets_biz2) %>% mutate(geometry=0)

# employment plot
# abousolute employment
polk_nets2_emp <- polk_nets_bf %>% select(-sales, -n, -emp_pest, -sales_pest) %>% spread(key = biz2, emp) %>% 
  rename(CNS07 = Retail, CNS18 = Food, Group=group, Type= type)
polk_nets2_emp $Type <- as.factor(polk_nets2_emp $Type)

polk_emp_retail_trend_plot <- trend_plot(filter(polk_nets2_emp, Type!="City"), industry = "Retail", industry_code = "CNS07", corridor_name = "Polk Street", construct_year = 2009, end_year = 2010, y_lable = "Employment", index = "Total")

polk_emp_food_trend_plot <- trend_plot(filter(polk_nets2_emp, Type!="City"), industry = "Food",industry_code = "CNS18", corridor_name = "Polk Street", construct_year = 2009, end_year = 2010, y_lable = "Employment", index = "Total")

# there are two food restraunt close in 1966 and 2002 seperately with over 100 employment

# employment per establishment
polk_nets2_emp_pest <- polk_nets_bf %>% select(-sales, -n, -emp, -sales_pest) %>% spread(key = biz2, emp_pest) %>% 
  rename(CNS07_pest = Retail, CNS18_pest = Food, Group=group, Type= type)
polk_nets2_emp_pest $Type <- as.factor(polk_nets2_emp_pest $Type)

polk_emp_pest_retail_trend_plot <- trend_plot(polk_nets2_emp_pest, industry = "Retail", industry_code = "CNS07_pest", corridor_name = "Polk Street", construct_year = 2009, end_year = 2010, y_lable = "Employment", index = "Per Establishment")

polk_emp_pest_food_trend_plot <- trend_plot(polk_nets2_emp_pest, industry = "Food",industry_code = "CNS18_pest", corridor_name = "Polk Street", construct_year = 2009, end_year = 2010, y_lable = "Employment", index = "Per Establishment")

# indexed employment
polk_nets2_emp_idx <- agg_index_trend_table(polk_nets2_emp, group = 1, construct_year = 2009)
polk_nets2_emp_idx $Type <- as.factor(polk_nets2_emp_idx $Type)

polk_emp_retail_indexed_trend_plot <- trend_plot(polk_nets2_emp_idx, industry = "Retail", industry_code = "CNS07_sd", corridor_name = "Polk Street", construct_year = 2009, end_year = 2010, y_lable = "Employment", index = "Indexed")

polk_emp_food_indexed_trend_plot <- trend_plot(polk_nets2_emp_idx, industry = "Food",industry_code = "CNS18_sd", corridor_name = "Polk Street", construct_year = 2009, end_year = 2010, y_lable = "Employment", index = "Indexed")

prow <- plot_grid(polk_emp_retail_trend_plot + theme(legend.position="none"),
                  polk_emp_food_trend_plot + theme(legend.position="none"),
                  polk_emp_pest_retail_trend_plot + theme(legend.position="none"),
                  polk_emp_pest_food_trend_plot + theme(legend.position="none"),
                  polk_emp_retail_indexed_trend_plot + theme(legend.position="none"),
                  polk_emp_food_indexed_trend_plot + theme(legend.position="none"), 
           align = 'vh', hjust = -1, nrow = 3)

legend_b <- get_legend(polk_emp_retail_indexed_trend_plot + theme(legend.position="bottom"))

plot_grid( prow, legend_b, ncol = 1, rel_heights = c(2, .2))

# sales plot
# abousolute sales
polk_nets2_sales <- polk_nets_bf %>% select(-emp, -n, -emp_pest, -sales_pest) %>% spread(key = biz2, sales) %>% 
  rename(CNS07 = Retail, CNS18 = Food, Group=group, Type= type)
polk_nets2_sales $Type <- as.factor(polk_nets2_sales$Type)

polk_sales_retail_trend_plot <- trend_plot(filter(polk_nets2_sales, Type!="City"), industry = "Retail", industry_code = "CNS07", corridor_name = "Polk Street", construct_year = 2009, end_year = 2010, y_lable = "Sales", index = "Total")

polk_sales_food_trend_plot <- trend_plot(filter(polk_nets2_sales, Type!="City"), industry = "Food",industry_code = "CNS18", corridor_name = "Polk Street", construct_year = 2009, end_year = 2010, y_lable = "Sales", index = "Total")


# sales per establishment
polk_nets2_sales_pest <- polk_nets_bf %>% select(-sales, -n, -emp, -emp_pest) %>% spread(key = biz2, sales_pest) %>% 
  rename(CNS07_pest = Retail, CNS18_pest = Food, Group=group, Type= type)
polk_nets2_sales_pest $Type <- as.factor(polk_nets2_sales_pest $Type)

polk_sales_pest_retail_trend_plot <- trend_plot(polk_nets2_sales_pest, industry = "Retail", industry_code = "CNS07_pest", corridor_name = "Polk Street", construct_year = 2009, end_year = 2010, y_lable = "Sales", index = "Per Establishment")

polk_sales_pest_food_trend_plot <- trend_plot(polk_nets2_sales_pest, industry = "Food",industry_code = "CNS18_pest", corridor_name = "Polk Street", construct_year = 2009, end_year = 2010, y_lable = "Sales", index = "Per Establishment")

# indexed sales
polk_nets2_sales_idx <- agg_index_trend_table(polk_nets2_sales, group = 1, construct_year = 2009)
polk_nets2_sales_idx $Type <- as.factor(polk_nets2_sales_idx $Type)

polk_sales_retail_indexed_trend_plot <- trend_plot(polk_nets2_sales_idx, industry = "Retail", industry_code = "CNS07_sd", corridor_name = "Polk Street", construct_year = 2009, end_year = 2010, y_lable = "Sales", index = "Indexed")

polk_sales_food_indexed_trend_plot <- trend_plot(polk_nets2_sales_idx, industry = "Food",industry_code = "CNS18_sd", corridor_name = "Polk Street", construct_year = 2009, end_year = 2010, y_lable = "Sales", index = "Indexed")

prow <- plot_grid(polk_sales_retail_trend_plot + theme(legend.position="none"),
                  polk_sales_food_trend_plot + theme(legend.position="none"),
                  polk_sales_pest_retail_trend_plot + theme(legend.position="none"),
                  polk_sales_pest_food_trend_plot + theme(legend.position="none"),
                  polk_sales_retail_indexed_trend_plot + theme(legend.position="none"),
                  polk_sales_food_indexed_trend_plot + theme(legend.position="none"), 
           align = 'vh', hjust = -1, nrow = 3)

legend_b <- get_legend(polk_sales_retail_indexed_trend_plot + theme(legend.position="bottom"))

plot_grid( prow, legend_b, ncol = 1, rel_heights = c(4, .2))


```


## trend analysis - table
```{r echo=FALSE, fig.asp=0.5, fig.width=9.5, message=FALSE, warning=FALSE}

# compute post change table compare to base year
polk_nets1_emp %>% 
  filter (year %in% c(2009, 2010, 2011, 2012)) %>% 
  group_by(Type) %>% 
  mutate(retail_growth =(CNS07/lag(CNS07)-1)*100,
         food_accom_growth = (CNS18/lag(CNS18)-1)*100)

polk_nets1_sales %>% 
  filter (year %in% c(2009, 2010, 2011, 2012)) %>% 
  group_by(Type) %>% 
  mutate(retail_growth =(CNS07/lag(CNS07)-1)*100,
         food_accom_growth = (CNS18/lag(CNS18)-1)*100)


polk_nets2_emp %>% 
  filter (year %in% c(2009, 2010, 2011, 2012)) %>% 
  group_by(Type) %>% 
  mutate(retail_growth =(CNS07/lag(CNS07)-1)*100,
         food_accom_growth = (CNS18/lag(CNS18)-1)*100)

polk_nets2_sales %>% 
  filter (year %in% c(2009, 2010, 2011, 2012)) %>% 
  group_by(Type) %>% 
  mutate(retail_growth =(CNS07/lag(CNS07)-1)*100,
         food_accom_growth = (CNS18/lag(CNS18)-1)*100)
  
```

# model
```{r, echo=FALSE, results='asis'}
# DID
#employment
polk_nets2_emp$Type <- relevel(polk_nets2_emp$Type,ref = "Treatment")
polk_nets2_sales$Type <- relevel(polk_nets2_sales$Type,ref = "Treatment")

polk_nets2_emp_did <- did_agg_analysis(filter(polk_nets2_emp, Type!="City" & year>2003), group = 1, endyear = 2010)

polk_nets2_sales_did <- did_agg_analysis(filter(polk_nets2_sales, Type!="City" & year>2003), group = 1, endyear = 2010)

stargazer(polk_nets2_emp_did[[1]], polk_nets2_emp_did[[2]], polk_nets2_sales_did[[1]], polk_nets2_sales_did[[2]], 
          title = "Polk Ave. Corridor Difference-in-Difference Estimates", 
          column.labels  = c("Retail", "Food", "Retail","Food"), 
          type = "text", dep.var.labels = c("Employment","Employment", "Sales", "Sales"), model.numbers = F)


# ITS

polk_nets2_emp_its <- agg_its_analysis(filter(polk_nets2_emp, year>2003), group = 1, endyear = 2010)
polk_nets2_sales_its <- agg_its_analysis(filter(polk_nets2_sales, year>2003), group = 1, endyear = 2010)

stargazer(polk_nets2_emp_its[[1]], polk_nets2_emp_its[[2]], polk_nets2_sales_its[[1]], polk_nets2_sales_its[[2]], 
          title = "Polk Ave. Corridor Difference-in-Difference Estimates", 
          column.labels  = c("Retail", "Food", "Retail","Food"), 
          type = "text", dep.var.labels = c("Employment","Employment", "Sales", "Sales"), model.numbers = F)


polk_nets1_sales_its <- agg_its_analysis(polk_nets1_sales, group = 1, endyear = 2010)

stargazer(polk_nets1_sales_its[[1]], polk_nets2_sales_its[[1]], polk_nets1_sales_its[[2]], polk_nets2_sales_its[[2]], 
          title = "Polk Ave. Corridor Difference-in-Difference Estimates", 
          column.labels  = c("Type 1", "Type 2", "Type 1","Type 2"), 
          type = "text", dep.var.labels = c("Retail Sales", "Food Sales"), model.numbers = F)


```



# 17th
## trend plot - industry type 1
```{r, echo=FALSE, message=FALSE, warning=FALSE, fig.width = 9.5, fig.asp=1.3}
# one types of industry categories similar to LEHD
sev_nets_b <- sf_sev_b %>% 
  group_by(name, type, buildstart, buildend, group, year, biz1) %>% 
  summarise(emp = sum(emp), sales= sum(sales), n=n(),
            emp_pest = emp/n, sales_pest = sales/n) %>% filter(biz1==c("Food", "Retail")) %>%
 as.data.frame(.) %>% select(-geometry)

nets_biz1 <- nets_biz1 %>% 
  mutate(name="city", type="City", buildstart=0, buildend=0, group=2) %>% select(name:group, year:sales_pest) %>% as.data.frame(.)

sev_nets_b <- rbind(sev_nets_b, nets_biz1) %>% mutate(geometry=0)

# employment plot
# abousolute employment
sev_nets1_emp <- sev_nets_b %>% select(-sales, -n, -emp_pest, -sales_pest) %>% 
  spread(key = biz1, emp) %>% 
  rename(CNS07 = Retail, CNS18 = Food, Group=group, Type= type)
sev_nets1_emp $Type <- as.factor(sev_nets1_emp $Type)

sev_emp_retail_trend_plot <- trend_plot(filter(sev_nets1_emp, Type!="City"), industry = "Retail", industry_code = "CNS07", corridor_name = "17th Street", construct_year = 2011, end_year = 2012, y_lable = "Employment", index = "Total")

sev_emp_food_trend_plot <- trend_plot(filter(sev_nets1_emp, Type!="City"), industry = "Food",industry_code = "CNS18", corridor_name = "17th Street", construct_year = 2011, end_year = 2012, y_lable = "Employment", index = "Total")


# employment per establishment
sev_nets1_emp_pest <- sev_nets_b %>% select(-sales, -n, -emp, -sales_pest) %>% spread(key = biz1, emp_pest) %>% 
  rename(CNS07_pest = Retail, CNS18_pest = Food, Group=group, Type= type)
sev_nets1_emp_pest $Type <- as.factor(sev_nets1_emp_pest $Type)

sev_emp_pest_retail_trend_plot <- trend_plot(sev_nets1_emp_pest, industry = "Retail", industry_code = "CNS07_pest", corridor_name = "17th Street", construct_year = 2011, end_year = 2012, y_lable = "Employment", index = "Per Establishment")

sev_emp_pest_food_trend_plot <- trend_plot(sev_nets1_emp_pest, industry = "Food",industry_code = "CNS18_pest", corridor_name = "17th Street", construct_year = 2011, end_year = 2012, y_lable = "Employment", index = "Per Establishment")

# indexed employment
sev_nets1_emp_idx <- agg_index_trend_table(sev_nets1_emp, group = 2, construct_year = 2009)
sev_nets1_emp_idx $Type <- as.factor(sev_nets1_emp_idx $Type)

sev_emp_retail_indexed_trend_plot <- trend_plot(sev_nets1_emp_idx, industry = "Retail", industry_code = "CNS07_sd", corridor_name = "17th Street", construct_year = 2011, end_year = 2012, y_lable = "Employment", index = "Indexed")

sev_emp_food_indexed_trend_plot <- trend_plot(sev_nets1_emp_idx, industry = "Food",industry_code = "CNS18_sd", corridor_name = "17th Street", construct_year = 2011, end_year = 2012, y_lable = "Employment", index = "Indexed")

prow <- plot_grid(sev_emp_retail_trend_plot + theme(legend.position="none"),
                  sev_emp_food_trend_plot + theme(legend.position="none"),
                  sev_emp_pest_retail_trend_plot + theme(legend.position="none"),
                  sev_emp_pest_food_trend_plot + theme(legend.position="none"),
                  sev_emp_retail_indexed_trend_plot + theme(legend.position="none"),
                  sev_emp_food_indexed_trend_plot + theme(legend.position="none"), 
           align = 'vh', hjust = -1, nrow = 3)

legend_b <- get_legend(sev_emp_retail_indexed_trend_plot + theme(legend.position="bottom"))

plot_grid( prow, legend_b, ncol = 1, rel_heights = c(4, .2))

# sales plot
# abousolute sales
sev_nets1_sales <- sev_nets_b %>% select(-emp, -n, -emp_pest, -sales_pest) %>% spread(key = biz1, sales) %>% 
  rename(CNS07 = Retail, CNS18 = Food, Group=group, Type= type)
sev_nets1_sales $Type <- as.factor(sev_nets1_sales$Type)

sev_sales_retail_trend_plot <- trend_plot(filter(sev_nets1_sales, Type!="City"), industry = "Retail", industry_code = "CNS07", corridor_name = "17th Street", construct_year = 2011, end_year = 2012, y_lable = "Sales", index = "Total")

sev_sales_food_trend_plot <- trend_plot(filter(sev_nets1_sales, Type!="City"), industry = "Food",industry_code = "CNS18", corridor_name = "17th Street", construct_year = 2011, end_year = 2012, y_lable = "Sales", index = "Total")


# sales per establishment
sev_nets1_sales_pest <- sev_nets_b %>% select(-sales, -n, -emp, -emp_pest) %>% spread(key = biz1, sales_pest) %>% 
  rename(CNS07_pest = Retail, CNS18_pest = Food, Group=group, Type= type)
sev_nets1_sales_pest $Type <- as.factor(sev_nets1_sales_pest $Type)

sev_sales_pest_retail_trend_plot <- trend_plot(sev_nets1_sales_pest, industry = "Retail", industry_code = "CNS07_pest", corridor_name = "17th Street", construct_year = 2011, end_year = 2012, y_lable = "Sales", index = "Per Establishment")

sev_sales_pest_food_trend_plot <- trend_plot(sev_nets1_sales_pest, industry = "Food",industry_code = "CNS18_pest", corridor_name = "17th Street", construct_year = 2009, end_year = 2010, y_lable = "Sales", index = "Per Establishment")

# indexed sales
sev_nets1_sales_idx <- agg_index_trend_table(sev_nets1_sales, group = 2, construct_year = 2009)
sev_nets1_sales_idx $Type <- as.factor(sev_nets1_sales_idx $Type)

sev_sales_retail_indexed_trend_plot <- trend_plot(sev_nets1_sales_idx, industry = "Retail", industry_code = "CNS07_sd", corridor_name = "17th Street", construct_year = 2011, end_year = 2012, y_lable = "Sales", index = "Indexed")

sev_sales_food_indexed_trend_plot <- trend_plot(sev_nets1_sales_idx, industry = "Food",industry_code = "CNS18_sd", corridor_name = "17th Street", construct_year = 2011, end_year = 2012, y_lable = "Sales", index = "Indexed")

prow <- plot_grid(sev_sales_retail_trend_plot + theme(legend.position="none"),
                  sev_sales_food_trend_plot + theme(legend.position="none"),
                  sev_sales_pest_retail_trend_plot + theme(legend.position="none"),
                  sev_sales_pest_food_trend_plot + theme(legend.position="none"),
                  sev_sales_retail_indexed_trend_plot + theme(legend.position="none"),
                  sev_sales_food_indexed_trend_plot + theme(legend.position="none"), 
           align = 'vh', hjust = -1, nrow = 3)

legend_b <- get_legend(sev_sales_retail_indexed_trend_plot + theme(legend.position="bottom"))

plot_grid( prow, legend_b, ncol = 1, rel_heights = c(4, .2))


```

## trend plot - industry type 2
```{r, echo=FALSE, message=FALSE, warning=FALSE, fig.width = 9.5, fig.asp=1.3}
# one types of industry categories similar to LEHD
sev_nets_bf <- sf_sev_bf %>% 
  group_by(fullname, type, buildstart, buildend, group, year, biz2) %>% 
  summarise(emp = sum(emp), sales= sum(sales), n=n(),
            emp_pest = emp/n, sales_pest = sales/n) %>% filter(biz2==c("Food", "Retail")) %>%
 as.data.frame(.) %>% select(-geometry)

nets_biz2 <- nets_biz2 %>% 
  mutate(fullname="city", type="City", buildstart=0, buildend=0, group=2) %>% select(fullname:group, year:sales_pest) %>% as.data.frame(.)

sev_nets_bf <- rbind(sev_nets_bf, nets_biz2) %>% mutate(geometry=0)

# employment plot
# abousolute employment
sev_nets2_emp <- sev_nets_bf %>% select(-sales, -n, -emp_pest, -sales_pest) %>% spread(key = biz2, emp) %>% 
  rename(CNS07 = Retail, CNS18 = Food, Group=group, Type= type)
sev_nets2_emp $Type <- as.factor(sev_nets2_emp $Type)

sev_emp_retail_trend_plot <- trend_plot(filter(sev_nets2_emp, Type!="City"), industry = "Retail", industry_code = "CNS07", corridor_name = "17th Street", construct_year = 2011, end_year = 2012, y_lable = "Employment", index = "Total")

sev_emp_food_trend_plot <- trend_plot(filter(sev_nets2_emp, Type!="City"), industry = "Food",industry_code = "CNS18", corridor_name = "17th Street", construct_year = 2011, end_year = 2012, y_lable = "Employment", index = "Total")

# employment per establishment
sev_nets2_emp_pest <- sev_nets_bf %>% select(-sales, -n, -emp, -sales_pest) %>% spread(key = biz2, emp_pest) %>% 
  rename(CNS07_pest = Retail, CNS18_pest = Food, Group=group, Type= type)
sev_nets2_emp_pest $Type <- as.factor(sev_nets2_emp_pest $Type)

sev_emp_pest_retail_trend_plot <- trend_plot(sev_nets2_emp_pest, industry = "Retail", industry_code = "CNS07_pest", corridor_name = "17th Street", construct_year = 2011, end_year = 2012, y_lable = "Employment", index = "Per Establishment")

sev_emp_pest_food_trend_plot <- trend_plot(sev_nets2_emp_pest, industry = "Food",industry_code = "CNS18_pest", corridor_name = "17th Street", construct_year = 2011, end_year = 2012, y_lable = "Employment", index = "Per Establishment")

# indexed employment
sev_nets2_emp_idx <- agg_index_trend_table(sev_nets2_emp, group = 2, construct_year = 2011)
sev_nets2_emp_idx $Type <- as.factor(sev_nets2_emp_idx $Type)

sev_emp_retail_indexed_trend_plot <- trend_plot(sev_nets2_emp_idx, industry = "Retail", industry_code = "CNS07_sd", corridor_name = "17th Street", construct_year = 2011, end_year = 2012, y_lable = "Employment", index = "Indexed")

sev_emp_food_indexed_trend_plot <- trend_plot(sev_nets2_emp_idx, industry = "Food",industry_code = "CNS18_sd", corridor_name = "17th Street", construct_year = 2011, end_year = 2012, y_lable = "Employment", index = "Indexed")

prow <- plot_grid(sev_emp_retail_trend_plot + theme(legend.position="none"),
                  sev_emp_food_trend_plot + theme(legend.position="none"),
                  sev_emp_pest_retail_trend_plot + theme(legend.position="none"),
                  sev_emp_pest_food_trend_plot + theme(legend.position="none"),
                  sev_emp_retail_indexed_trend_plot + theme(legend.position="none"),
                  sev_emp_food_indexed_trend_plot + theme(legend.position="none"), 
           align = 'vh', hjust = -1, nrow = 3)

legend_b <- get_legend(sev_emp_retail_indexed_trend_plot + theme(legend.position="bottom"))

plot_grid( prow, legend_b, ncol = 1, rel_heights = c(2, .2))

# sales plot
# abousolute sales
sev_nets2_sales <- sev_nets_bf %>% select(-emp, -n, -emp_pest, -sales_pest) %>% spread(key = biz2, sales) %>% 
  rename(CNS07 = Retail, CNS18 = Food, Group=group, Type= type)
sev_nets2_sales $Type <- as.factor(sev_nets2_sales$Type)

sev_sales_retail_trend_plot <- trend_plot(filter(sev_nets2_sales, Type!="City"), industry = "Retail", industry_code = "CNS07", corridor_name = "17th Street", construct_year = 2011, end_year = 2012, y_lable = "Sales", index = "Total")

sev_sales_food_trend_plot <- trend_plot(filter(sev_nets2_sales, Type!="City"), industry = "Food",industry_code = "CNS18", corridor_name = "17th Street", construct_year = 2011, end_year = 2012, y_lable = "Sales", index = "Total")


# sales per establishment
sev_nets2_sales_pest <- sev_nets_bf %>% select(-sales, -n, -emp, -emp_pest) %>% spread(key = biz2, sales_pest) %>% 
  rename(CNS07_pest = Retail, CNS18_pest = Food, Group=group, Type= type)
sev_nets2_sales_pest $Type <- as.factor(sev_nets2_sales_pest $Type)

sev_sales_pest_retail_trend_plot <- trend_plot(sev_nets2_sales_pest, industry = "Retail", industry_code = "CNS07_pest", corridor_name = "17th Street", construct_year = 2011, end_year = 2012, y_lable = "Sales", index = "Per Establishment")

sev_sales_pest_food_trend_plot <- trend_plot(sev_nets2_sales_pest, industry = "Food",industry_code = "CNS18_pest", corridor_name = "17th Street", construct_year = 2011, end_year = 2012, y_lable = "Sales", index = "Per Establishment")

# indexed sales
sev_nets2_sales_idx <- agg_index_trend_table(sev_nets2_sales, group = 2, construct_year = 2009)
sev_nets2_sales_idx $Type <- as.factor(sev_nets2_sales_idx $Type)

sev_sales_retail_indexed_trend_plot <- trend_plot(sev_nets2_sales_idx, industry = "Retail", industry_code = "CNS07_sd", corridor_name = "17th Street", construct_year = 2011, end_year = 2012, y_lable = "Sales", index = "Indexed")

sev_sales_food_indexed_trend_plot <- trend_plot(sev_nets2_sales_idx, industry = "Food",industry_code = "CNS18_sd", corridor_name = "17th Street", construct_year = 2011, end_year = 2012, y_lable = "Sales", index = "Indexed")

prow <- plot_grid(sev_sales_retail_trend_plot + theme(legend.position="none"),
                  sev_sales_food_trend_plot + theme(legend.position="none"),
                  sev_sales_pest_retail_trend_plot + theme(legend.position="none"),
                  sev_sales_pest_food_trend_plot + theme(legend.position="none"),
                  sev_sales_retail_indexed_trend_plot + theme(legend.position="none"),
                  sev_sales_food_indexed_trend_plot + theme(legend.position="none"), 
           align = 'vh', hjust = -1, nrow = 3)

legend_b <- get_legend(sev_sales_retail_indexed_trend_plot + theme(legend.position="bottom"))

plot_grid( prow, legend_b, ncol = 1, rel_heights = c(4, .2))


```

## trend analysis - table
```{r echo=FALSE, fig.asp=0.5, fig.width=9.5, message=FALSE, warning=FALSE}

# compute post change table compare to base year
sev_nets1_emp %>% 
  filter (year %in% c(2011, 2012, 2013, 2014)) %>% 
  group_by(Type) %>% 
  mutate(retail_growth =(CNS07/lag(CNS07)-1)*100,
         food_accom_growth = (CNS18/lag(CNS18)-1)*100)

sev_nets1_sales %>% 
  filter (year %in% c(2011, 2012, 2013, 2014)) %>% 
  group_by(Type) %>% 
  mutate(retail_growth =(CNS07/lag(CNS07)-1)*100,
         food_accom_growth = (CNS18/lag(CNS18)-1)*100)


sev_nets2_emp %>% 
  filter (year %in% c(2011, 2012, 2013, 2014)) %>% 
  group_by(Type) %>% 
  mutate(retail_growth =(CNS07/lag(CNS07)-1)*100,
         food_accom_growth = (CNS18/lag(CNS18)-1)*100)

sev_nets2_sales %>% 
  filter (year %in% c(2011, 2012, 2013, 2014)) %>% 
  group_by(Type) %>% 
  mutate(retail_growth =(CNS07/lag(CNS07)-1)*100,
         food_accom_growth = (CNS18/lag(CNS18)-1)*100)
  
```

# model
```{r, echo=FALSE, results='asis'}
# DID
#employment
sev_nets2_emp$Type <- relevel(sev_nets2_emp$Type,ref = "Treatment")
sev_nets2_sales$Type <- relevel(sev_nets2_sales$Type,ref = "Treatment")

sev_nets2_emp_did <- did_agg_analysis(filter(sev_nets2_emp, Type!="City" & year>2005), group = 2, endyear = 2012)

sev_nets2_sales_did <- did_agg_analysis(filter(sev_nets2_sales, Type!="City" & year>2005), group = 2, endyear = 2012)

stargazer(sev_nets2_emp_did[[1]], sev_nets2_emp_did[[2]], sev_nets2_sales_did[[1]], sev_nets2_sales_did[[2]], 
          title = "17th Street Corridor Difference-in-Difference Estimates", 
          column.labels  = c("Retail", "Food", "Retail","Food"), 
          type = "text", dep.var.labels = c("Employment","Employment", "Sales", "Sales"), model.numbers = F)


# ITS

sev_nets2_emp_its <- agg_its_analysis(filter(sev_nets2_emp, year>2005), group = 2, endyear = 2012)
sev_nets2_sales_its <- agg_its_analysis(filter(sev_nets2_sales, year>2005), group = 2, endyear = 2012)

stargazer(sev_nets2_emp_its[[1]], sev_nets2_emp_its[[2]], sev_nets2_sales_its[[1]], sev_nets2_sales_its[[2]], 
          title = "17th Street Corridor Difference-in-Difference Estimates", 
          column.labels  = c("Retail", "Food", "Retail","Food"), 
          type = "text", dep.var.labels = c("Employment","Employment", "Sales", "Sales"), model.numbers = F)


```
# Distributional analysis - polk
## additional distributional analysis - income (bar graph)
```{r echo=FALSE, fig.asp=0.5, fig.width=9.5, message=FALSE, warning=FALSE}
polk_inc <- sf_corridor_rac %>% as.data.frame() %>% filter(Group == 1) %>% 
  mutate(Type = factor(Type, levels = c("Treatment: Polk", "Control: Van Ness"))) %>% 
  group_by(Type, year) %>% 
  summarise(low_income = sum(CE01), 
            mid_income = sum(CE02), 
            high_income = sum(CE03)) %>% 
  group_by(Type) %>% 
  gather(income_level, employment,low_income, mid_income, high_income) %>% 
  mutate(year = as.Date(as.character(paste0(year, "-01-01")),"%Y-%m-%d"),
         income_level = factor(income_level, levels=c("high_income", "mid_income", "low_income")),
         n = case_when(Type == "Treatment: Polk" ~ 28,
                       Type == "Control: Van Ness" ~36)) 

ggplot(data=polk_inc, aes(x=year, y=employment/n)) +
  geom_bar(aes(fill=income_level),stat = "identity")+
  facet_wrap(~Type)+
  scale_x_date(date_breaks = "3 years", date_labels = "%Y") +
  labs(title="Income Composition Trend Among Corridors", x="Year", y ="Employment per block", 
       caption = "Bike lane is constructed in 2009") +
  theme(legend.position = "bottom") +
  scale_fill_discrete(name="Income Level",
                      breaks=c("high_income", "mid_income", "low_income"),
                      labels=c("High income", "Middle income", "Low income"))
  

```


## additional distributional analysis - race (line chart)
```{r echo=FALSE, fig.asp=1.5, fig.width=9.5, message=FALSE, warning=FALSE}
polk_race <- sf_corridor %>% as.data.frame() %>% filter(Group == 1) %>% 
  group_by(Type, year) %>% 
  summarise(
    white = sum(CR01), black = sum(CR02), ameindian = sum(CR03), asian = sum(CR04), 
    hawaii=sum(CR05), other=sum(CR07), tot_emp = sum(C000)) %>% 
  mutate(white_perc = white/tot_emp*100,
         black_perc = black/tot_emp*100,
         ameindian_perc = ameindian/tot_emp*100,
         asian_perc = asian/tot_emp*100,
         hawaii_perc = hawaii/tot_emp*100,
         other_perc = other/tot_emp*100) 

sf_race <- sf_lehd %>% 
  group_by(year) %>% 
  summarise(
    white = sum(CR01), black = sum(CR02), ameindian = sum(CR03), asian = sum(CR04), 
    hawaii=sum(CR05), other=sum(CR07), tot_emp = sum(C000)) %>% 
  mutate(white_perc = white/tot_emp*100,
         black_perc = black/tot_emp*100,
         ameindian_perc = ameindian/tot_emp*100,
         asian_perc = asian/tot_emp*100,
         hawaii_perc = hawaii/tot_emp*100,
         other_perc = other/tot_emp*100,
         Type = "City") %>% 
  select(Type, year:other_perc) %>% as.data.frame()


polk_race <- rbind(as.data.frame(polk_race), as.data.frame(sf_race))
polk_race[polk_race$year<2009,][,c(3:8,10:15)] <- NA
polk_race$Type <- as.factor(as.character(polk_race$Type))
  
white_plot <- dist_trend_plot(polk_race,demo = "White", demo_code = "white_perc", corridor_name = "Polk Street", cat = "Employment", construct_year = 2009, end_year = 2010, 45, 65)

black_plot <- dist_trend_plot(polk_race,demo = "Black", demo_code = "black_perc", corridor_name = "Polk Street", cat = "Employment", construct_year = 2009, end_year = 2010, 0,20)

ameindian_plot <- dist_trend_plot(polk_race,demo = "American Indian", demo_code = "ameindian_perc", corridor_name = "Polk Street", cat = "Employment",construct_year = 2009, end_year = 2010, 0,20)

asian_plot <- dist_trend_plot(polk_race,demo = "Asian", demo_code = "asian_perc", corridor_name = "Polk Street", cat = "Employment", construct_year = 2009, end_year = 2010,25,45)

hawaii_plot <- dist_trend_plot(polk_race,demo = "Native Hawaiian", demo_code = "hawaii_perc", corridor_name = "Polk Street", cat = "Employment", construct_year = 2009, end_year = 2010,0,20)

other_plot <- dist_trend_plot(polk_race,demo = "Two or More Races", demo_code = "other_perc", corridor_name = "Polk Street", cat = "Employment", construct_year = 2009, end_year = 2010,0,20)

prow <- plot_grid(white_plot + theme(legend.position="none"),
                  black_plot + theme(legend.position="none"),
                  asian_plot + theme(legend.position="none"),
                  ameindian_plot + theme(legend.position="none"),
                  hawaii_plot + theme(legend.position="none"),
                  other_plot + theme(legend.position="none"), 
           align = 'vh', hjust = -1, nrow = 3)

legend_b <- get_legend(white_plot + theme(legend.position="bottom"))

plot_grid( prow, legend_b, ncol = 1, rel_heights = c(4, .2))

```


## additional distributional analysis - race (table)
```{r}
start_end_race <- polk_race %>%
  select(Type, year, ends_with("_perc")) %>% # select variables ends with "_perc"
  filter(complete.cases(.)) %>%
  group_by(Type) %>% 
  summarise_at(vars(ends_with("_perc")), funs(change = (last(.)-first(.))/first(.)/6*100))

  
# calculate year by year race categories percentage change  
y_o_y_race <- polk_race %>% 
  select(Type, year, ends_with("_perc")) %>% 
  mutate_if(is.numeric, funs(change = ./lag(.)*100 -100)) %>% 
  group_by(Type) %>% 
  summarise_at(vars(ends_with("_change")), funs(mean(., na.rm=T)))

```

## residence - race
```{r echo=FALSE, fig.asp=1.5, fig.width=9.5, message=FALSE, warning=FALSE}
polk_race <- sf_corridor_rac %>% as.data.frame() %>% filter(Group == 1) %>% 
  group_by(Type, year) %>% 
  summarise(
    white = sum(CR01), black = sum(CR02), ameindian = sum(CR03), asian = sum(CR04), 
    hawaii=sum(CR05), other=sum(CR07), tot_emp = sum(C000)) %>% 
  mutate(white_perc = white/tot_emp*100,
         black_perc = black/tot_emp*100,
         ameindian_perc = ameindian/tot_emp*100,
         asian_perc = asian/tot_emp*100,
         hawaii_perc = hawaii/tot_emp*100,
         other_perc = other/tot_emp*100) 

pdx_race <- sf_rac %>% 
  group_by(year) %>% 
  summarise(
    white = sum(CR01), black = sum(CR02), ameindian = sum(CR03), asian = sum(CR04), 
    hawaii=sum(CR05), other=sum(CR07), tot_emp = sum(C000)) %>% 
  mutate(white_perc = white/tot_emp*100,
         black_perc = black/tot_emp*100,
         ameindian_perc = ameindian/tot_emp*100,
         asian_perc = asian/tot_emp*100,
         hawaii_perc = hawaii/tot_emp*100,
         other_perc = other/tot_emp*100,
         Type = "City") %>% 
  select(Type, year:other_perc)


polk_race <- rbind(as.data.frame(polk_race), as.data.frame(pdx_race))
polk_race[polk_race$year<2009,][,c(3:8,10:15)] <- NA
polk_race$Type <- as.factor(as.character(polk_race$Type))
  

white_plot <- dist_trend_plot(polk_race,demo = "White", demo_code = "white_perc", corridor_name = "Polk Street", cat = "Residents", construct_year = 2009, end_year = 2010, 55, 80)

black_plot <- dist_trend_plot(polk_race,demo = "Black", demo_code = "black_perc", corridor_name = "Polk Street", cat = "Residents", construct_year = 2009, end_year = 2010, 0,25)

ameindian_plot <- dist_trend_plot(polk_race,demo = "American Indian", demo_code = "ameindian_perc", corridor_name = "Polk Street", cat = "Residents",construct_year = 2009, end_year = 2010, 0,25)

asian_plot <- dist_trend_plot(polk_race,demo = "Asian", demo_code = "asian_perc", corridor_name = "Polk Street", cat = "Residents", construct_year = 2009, end_year = 2010,12,32)

hawaii_plot <- dist_trend_plot(polk_race,demo = "Native Hawaiian", demo_code = "hawaii_perc", corridor_name = "Polk Street", cat = "Residents", construct_year = 2009, end_year = 2010,0,25)

other_plot <- dist_trend_plot(polk_race,demo = "Two or More Races", demo_code = "other_perc", corridor_name = "Polk Street", cat = "Residents", construct_year = 2009, end_year = 2010,0,25)

prow <- plot_grid(white_plot + theme(legend.position="none"),
                  black_plot + theme(legend.position="none"),
                  ameindian_plot + theme(legend.position="none"),
                  asian_plot + theme(legend.position="none"),
                  hawaii_plot + theme(legend.position="none"),
                  other_plot + theme(legend.position="none"), 
           align = 'vh', hjust = -1, nrow = 3)

legend_b <- get_legend(white_plot + theme(legend.position="bottom"))

plot_grid( prow, legend_b, ncol = 1, rel_heights = c(4, .2))
```

## residence -race (table)
```{r}
start_end_race <- polk_race %>%
  select(Type, year, ends_with("_perc")) %>% # select variables ends with "_perc"
  filter(complete.cases(.)) %>%
  group_by(Type) %>% 
  summarise_at(vars(ends_with("_perc")), funs(change = (last(.)-first(.))/first(.)/6*100))

  
# calculate year by year race categories percentage change  
y_o_y_race <- polk_race %>% 
  select(Type, year, ends_with("_perc")) %>% 
  mutate_if(is.numeric, funs(change = ./lag(.)*100 -100)) %>% 
  group_by(Type) %>% 
  summarise_at(vars(ends_with("_change")), funs(mean(., na.rm=T)))

```



## additional distributional analysis - education (line chart)
```{r echo=FALSE, fig.asp=1, fig.width=9.5, message=FALSE, warning=FALSE}
polk_edu <- sf_corridor %>% as.data.frame() %>% filter(Group == 1) %>% 
  group_by(Type, year) %>% 
  summarise(
    hisch_under = sum(CD01), hisch = sum(CD02), col = sum(CD03), bach = sum(CD04), tot_emp = sum(C000)) %>% 
  mutate(hisch_under_perc = hisch_under/tot_emp*100,
         hisch_perc = hisch/tot_emp*100,
         col_perc = col/tot_emp*100,
         bach_perc = bach/tot_emp*100) 

sf_edu <- sf_lehd %>% 
  group_by(year) %>% 
  summarise(
    hisch_under = sum(CD01), hisch = sum(CD02), col = sum(CD03), bach = sum(CD04), tot_emp = sum(C000)) %>% 
  mutate(hisch_under_perc = hisch_under/tot_emp*100,
         hisch_perc = hisch/tot_emp*100,
         col_perc = col/tot_emp*100,
         bach_perc = bach/tot_emp*100,
         Type = "City") %>% 
  select(Type, year:bach_perc) %>% as.data.frame(.)


polk_edu <- rbind(as.data.frame(polk_edu), as.data.frame(sf_edu))
polk_edu[polk_edu$year<2009,][,c(3:6,8:11)] <- NA
polk_edu$Type <- as.factor(as.character(polk_edu$Type))
  

hisch_under_plot <- dist_trend_plot(polk_edu,demo = "Less Than High School", demo_code = "hisch_under_perc", corridor_name = "Polk Street", cat = "Employment", construct_year = 2009, end_year = 2010, 5, 20)

hisch_plot <- dist_trend_plot(polk_edu,demo = "High School", demo_code = "hisch_perc", corridor_name = "Polk Street", cat = "Employment", construct_year = 2009, end_year = 2010, 5, 20)

col_plot <- dist_trend_plot(polk_edu,demo = "College", demo_code = "col_perc", corridor_name = "Polk Street", cat = "Employment", construct_year = 2009, end_year = 2010, 15, 30)

bach_plot <- dist_trend_plot(polk_edu,demo = "Bachelor or Above", demo_code = "bach_perc", corridor_name = "Polk Street", cat = "Employment", construct_year = 2009, end_year = 2010,25,40)

prow <- plot_grid(hisch_under_plot + theme(legend.position="none"),
                  hisch_plot + theme(legend.position="none"),
                  col_plot + theme(legend.position="none"),
                  bach_plot + theme(legend.position="none"),
           align = 'vh', hjust = -1, nrow = 2)

legend_b <- get_legend(col_plot + theme(legend.position="bottom"))

plot_grid( prow, legend_b, ncol = 1, rel_heights = c(4, .2))
```

## additional distributional analysis - edu (table)
```{r}
start_end_edu <- polk_edu %>%
  select(Type, year, ends_with("_perc")) %>% # select variables ends with "_perc"
  filter(complete.cases(.)) %>%
  group_by(Type) %>% 
  summarise_at(vars(ends_with("_perc")), funs(change = (last(.)-first(.))/first(.)/6*100))
  
  
# calculate year by year race categories percentage change  
y_o_y_edu <- polk_edu %>% 
  select(Type, year, ends_with("_perc")) %>% 
  mutate_if(is.numeric, funs(change = ./lag(.)*100 -100)) %>% 
  group_by(Type) %>% 
  summarise_at(vars(ends_with("_change")), funs(mean(., na.rm=T)))
```

##  residence - education (line chart)
```{r echo=FALSE, fig.asp=1, fig.width=9.5, message=FALSE, warning=FALSE}
polk_edu <- sf_corridor_rac %>% as.data.frame() %>% filter(Group == 1) %>% 
  group_by(Type, year) %>% 
  summarise(
    hisch_under = sum(CD01), hisch = sum(CD02), col = sum(CD03), bach = sum(CD04), tot_emp = sum(C000)) %>% 
  mutate(hisch_under_perc = hisch_under/tot_emp*100,
         hisch_perc = hisch/tot_emp*100,
         col_perc = col/tot_emp*100,
         bach_perc = bach/tot_emp*100) 

sf_edu <- sf_rac %>% 
  group_by(year) %>% 
  summarise(
    hisch_under = sum(CD01), hisch = sum(CD02), col = sum(CD03), bach = sum(CD04), tot_emp = sum(C000)) %>% 
  mutate(hisch_under_perc = hisch_under/tot_emp*100,
         hisch_perc = hisch/tot_emp*100,
         col_perc = col/tot_emp*100,
         bach_perc = bach/tot_emp*100,
         Type = "City") %>% 
  select(Type, year:bach_perc) %>% as.data.frame(.)


polk_edu <- rbind(as.data.frame(polk_edu), as.data.frame(sf_edu))
polk_edu[polk_edu$year<2009,][,c(3:6,8:11)] <- NA
polk_edu$Type <- as.factor(as.character(polk_edu$Type))
  

hisch_under_plot <- dist_trend_plot(polk_edu,demo = "Less Than High School", demo_code = "hisch_under_perc", corridor_name = "Polk Street", cat = "Residents", construct_year = 2009, end_year = 2010, 5, 15)

hisch_plot <- dist_trend_plot(polk_edu,demo = "High School", demo_code = "hisch_perc", corridor_name = "Polk Street", cat = "Residents", construct_year = 2009, end_year = 2010, 8, 18)

col_plot <- dist_trend_plot(polk_edu,demo = "College", demo_code = "col_perc", corridor_name = "Polk Street", cat = "Residents", construct_year = 2009, end_year = 2010, 15, 25)

bach_plot <- dist_trend_plot(polk_edu,demo = "Bachelor or Above", demo_code = "bach_perc", corridor_name = "Polk Street", cat = "Residents", construct_year = 2009, end_year = 2010,29,39)

prow <- plot_grid(hisch_under_plot + theme(legend.position="none"),
                  hisch_plot + theme(legend.position="none"),
                  col_plot + theme(legend.position="none"),
                  bach_plot + theme(legend.position="none"),
           align = 'vh', hjust = -1, nrow = 2)

legend_b <- get_legend(col_plot + theme(legend.position="bottom"))

plot_grid( prow, legend_b, ncol = 1, rel_heights = c(4, .2))
```


## distributional rac - edu table
```{r echo=FALSE, fig.asp=1, fig.width=9.5, message=FALSE, warning=FALSE}
  
start_end_edu <- polk_edu %>%
  select(Type, year, ends_with("_perc")) %>% # select variables ends with "_perc"
  filter(complete.cases(.)) %>%
  group_by(Type) %>% 
  summarise_at(vars(ends_with("_perc")), funs(change = (last(.)-first(.))/first(.)/6*100))
  
  
# calculate year by year race categories percentage change  
y_o_y_edu <- polk_edu %>% 
  select(Type, year, ends_with("_perc")) %>% 
  mutate_if(is.numeric, funs(change = ./lag(.)*100 -100)) %>% 
  group_by(Type) %>% 
  summarise_at(vars(ends_with("_change")), funs(mean(., na.rm=T))) 

```

## gender
```{r echo=FALSE, fig.asp=0.5, fig.width=9.5, message=FALSE, warning=FALSE}
polk_gender <- sf_corridor %>% as.data.frame() %>% filter(Group == 1) %>% 
  group_by(Type, year) %>% 
  summarise(female = sum(CS02), tot_emp = sum(C000)) %>% 
  mutate(female_perc = female/tot_emp*100) 

sf_gender <- sf_lehd %>% 
  group_by(year) %>% 
  summarise(female = sum(CS02), tot_emp = sum(C000)) %>% 
  mutate(female_perc = female/tot_emp*100,
         Type = "City") %>% 
  select(Type, year:female_perc) %>% as.data.frame(.) %>% select(-geometry)

polk_gender <- rbind(as.data.frame(polk_gender), as.data.frame(sf_gender))
polk_gender[polk_gender$year<2009,][,c(3,5)] <- NA
polk_gender$Type <- as.factor(as.character(polk_gender$Type))

gender_plot <- dist_trend_plot(polk_gender,demo = "Female", demo_code = "female_perc", corridor_name = "Polk Street", cat = "Employment", construct_year = 2009, end_year = 2010, 43, 55)

polk_gender_rac <- sf_corridor_rac %>% as.data.frame() %>% filter(Group == 1) %>% 
  group_by(Type, year) %>% 
  summarise(female = sum(CS02), tot_emp = sum(C000)) %>% 
  mutate(female_perc = female/tot_emp*100) 

sf_gender_rac <- sf_rac %>% 
  group_by(year) %>% 
  summarise(female = sum(CS02), tot_emp = sum(C000)) %>% 
  mutate(female_perc = female/tot_emp*100,
         Type = "City") %>% 
  select(Type, year:female_perc) %>% as.data.frame(.) %>% select(-geometry)

polk_gender_rac <- rbind(as.data.frame(polk_gender_rac), as.data.frame(sf_gender_rac))
polk_gender_rac[polk_gender_rac$year<2009,][,c(3,5)] <- NA
polk_gender_rac$Type <- as.factor(as.character(polk_gender_rac$Type))

gender_rac_plot <- dist_trend_plot(polk_gender_rac,demo = "Female", demo_code = "female_perc", corridor_name = "Polk Street", cat = "Residents", construct_year = 2009, end_year = 2010, 43, 55)

prow <- plot_grid(gender_plot + theme(legend.position="none"),
                  gender_rac_plot + theme(legend.position="none"),
           align = 'vh', hjust = -1, nrow = 1)

legend_b <- get_legend(gender_plot + theme(legend.position="bottom"))

plot_grid( prow, legend_b, ncol = 1, rel_heights = c(4, .2))
```


# Distributional analysis - 17th
## additional distributional analysis - income (bar graph)
```{r echo=FALSE, fig.asp=0.5, fig.width=9.5, message=FALSE, warning=FALSE}
sev_inc <- sf_corridor_rac %>% as.data.frame() %>% filter(Group == 2) %>% 
  mutate(Type = factor(Type, levels = c("Treatment: 17th St", "Control: 18th St"))) %>% 
  group_by(Type, year) %>% 
  summarise(low_income = sum(CE01), 
            mid_income = sum(CE02), 
            high_income = sum(CE03)) %>% 
  group_by(Type) %>% 
  gather(income_level, employment,low_income, mid_income, high_income) %>% 
  mutate(year = as.Date(as.character(paste0(year, "-01-01")),"%Y-%m-%d"),
         income_level = factor(income_level, levels=c("high_income", "mid_income", "low_income")),
         n = case_when(Type == "Treatment: 17th St" ~ 20,
                       Type == "Control: 18th St" ~23)) 

ggplot(data=sev_inc, aes(x=year, y=employment/n)) +
  geom_bar(aes(fill=income_level),stat = "identity")+
  facet_wrap(~Type)+
  scale_x_date(date_breaks = "3 years", date_labels = "%Y") +
  labs(title="Income Composition Trend Among Corridors", x="Year", y ="Employment per block", 
       caption = "Bike lane is constructed in 2011") +
  theme(legend.position = "bottom") +
  scale_fill_discrete(name="Income Level",
                      breaks=c("high_income", "mid_income", "low_income"),
                      labels=c("High income", "Middle income", "Low income"))
  

```


## additional distributional analysis - race (line chart)
```{r echo=FALSE, fig.asp=1.5, fig.width=9.5, message=FALSE, warning=FALSE}
sev_race <- sf_corridor %>% as.data.frame() %>% filter(Group == 2) %>% 
  group_by(Type, year) %>% 
  summarise(
    white = sum(CR01), black = sum(CR02), ameindian = sum(CR03), asian = sum(CR04), 
    hawaii=sum(CR05), other=sum(CR07), tot_emp = sum(C000)) %>% 
  mutate(white_perc = white/tot_emp*100,
         black_perc = black/tot_emp*100,
         ameindian_perc = ameindian/tot_emp*100,
         asian_perc = asian/tot_emp*100,
         hawaii_perc = hawaii/tot_emp*100,
         other_perc = other/tot_emp*100) 

sf_race <- sf_lehd %>% 
  group_by(year) %>% 
  summarise(
    white = sum(CR01), black = sum(CR02), ameindian = sum(CR03), asian = sum(CR04), 
    hawaii=sum(CR05), other=sum(CR07), tot_emp = sum(C000)) %>% 
  mutate(white_perc = white/tot_emp*100,
         black_perc = black/tot_emp*100,
         ameindian_perc = ameindian/tot_emp*100,
         asian_perc = asian/tot_emp*100,
         hawaii_perc = hawaii/tot_emp*100,
         other_perc = other/tot_emp*100,
         Type = "City") %>% 
  select(Type, year:other_perc) %>% as.data.frame()


sev_race <- rbind(as.data.frame(sev_race), as.data.frame(sf_race))
sev_race[sev_race$year<2009,][,c(3:8,10:15)] <- NA
sev_race$Type <- as.factor(as.character(sev_race$Type))
  
white_plot <- dist_trend_plot(sev_race,demo = "White", demo_code = "white_perc", corridor_name = "17th Street", cat = "Employment", construct_year = 2011, end_year = 2012, 60, 75)

black_plot <- dist_trend_plot(sev_race,demo = "Black", demo_code = "black_perc", corridor_name = "17th Street", cat = "Employment", construct_year = 2011, end_year = 2012, 0,15)

ameindian_plot <- dist_trend_plot(sev_race,demo = "American Indian", demo_code = "ameindian_perc", corridor_name = "17th Street", cat = "Employment",construct_year = 2011, end_year = 2012, 0,15)

asian_plot <- dist_trend_plot(sev_race,demo = "Asian", demo_code = "asian_perc", corridor_name = "17th Street", cat = "Employment", construct_year = 2011, end_year = 2012,15,30)

hawaii_plot <- dist_trend_plot(sev_race,demo = "Native Hawaiian", demo_code = "hawaii_perc", corridor_name = "17th Street", cat = "Employment", construct_year = 2011, end_year = 2012,0,15)

other_plot <- dist_trend_plot(sev_race,demo = "Two or More Races", demo_code = "other_perc", corridor_name = "17th Street", cat = "Employment", construct_year = 2011, end_year = 2012,0,15)

prow <- plot_grid(white_plot + theme(legend.position="none"),
                  black_plot + theme(legend.position="none"),
                  asian_plot + theme(legend.position="none"),
                  ameindian_plot + theme(legend.position="none"),
                  hawaii_plot + theme(legend.position="none"),
                  other_plot + theme(legend.position="none"), 
           align = 'vh', hjust = -1, nrow = 3)

legend_b <- get_legend(white_plot + theme(legend.position="bottom"))

plot_grid( prow, legend_b, ncol = 1, rel_heights = c(4, .2))

```


## additional distributional analysis - race (table)
```{r}
start_end_race <- sev_race %>% filter(year >=2011) %>% 
  select(Type, year, ends_with("_perc")) %>% # select variables ends with "_perc"
  filter(complete.cases(.)) %>%
  group_by(Type) %>% 
  summarise_at(vars(ends_with("_perc")), funs(change = (last(.)-first(.))/first(.)/4*100))

  
# calculate year by year race categories percentage change  
y_o_y_race <- sev_race %>% filter(year >=2011) %>%
  select(Type, year, ends_with("_perc")) %>% 
  mutate_if(is.numeric, funs(change = ./lag(.)*100 -100)) %>% 
  group_by(Type) %>% 
  summarise_at(vars(ends_with("_change")), funs(mean(., na.rm=T)))

```

## residence - race
```{r echo=FALSE, fig.asp=1.5, fig.width=9.5, message=FALSE, warning=FALSE}
sev_race <- sf_corridor_rac %>% as.data.frame() %>% filter(Group == 2) %>% 
  group_by(Type, year) %>% 
  summarise(
    white = sum(CR01), black = sum(CR02), ameindian = sum(CR03), asian = sum(CR04), 
    hawaii=sum(CR05), other=sum(CR07), tot_emp = sum(C000)) %>% 
  mutate(white_perc = white/tot_emp*100,
         black_perc = black/tot_emp*100,
         ameindian_perc = ameindian/tot_emp*100,
         asian_perc = asian/tot_emp*100,
         hawaii_perc = hawaii/tot_emp*100,
         other_perc = other/tot_emp*100) 

pdx_race <- sf_rac %>% 
  group_by(year) %>% 
  summarise(
    white = sum(CR01), black = sum(CR02), ameindian = sum(CR03), asian = sum(CR04), 
    hawaii=sum(CR05), other=sum(CR07), tot_emp = sum(C000)) %>% 
  mutate(white_perc = white/tot_emp*100,
         black_perc = black/tot_emp*100,
         ameindian_perc = ameindian/tot_emp*100,
         asian_perc = asian/tot_emp*100,
         hawaii_perc = hawaii/tot_emp*100,
         other_perc = other/tot_emp*100,
         Type = "City") %>% 
  select(Type, year:other_perc)


sev_race <- rbind(as.data.frame(sev_race), as.data.frame(pdx_race))
sev_race[sev_race$year<2009,][,c(3:8,10:15)] <- NA
sev_race$Type <- as.factor(as.character(sev_race$Type))
  

white_plot <- dist_trend_plot(sev_race,demo = "White", demo_code = "white_perc", corridor_name = "17th Street", cat = "Residents", construct_year = 2011, end_year = 2012, 57, 77)

black_plot <- dist_trend_plot(sev_race,demo = "Black", demo_code = "black_perc",  corridor_name = "17th Street", cat = "Residents", construct_year = 2011, end_year = 2012, 0,20)

ameindian_plot <- dist_trend_plot(sev_race,demo = "American Indian", demo_code = "ameindian_perc", corridor_name = "17th Street", cat = "Residents", construct_year = 2011, end_year = 2012, 0,20)

asian_plot <- dist_trend_plot(sev_race,demo = "Asian", demo_code = "asian_perc", corridor_name = "17th Street", cat = "Residents", construct_year = 2011, end_year = 2012,15,35)

hawaii_plot <- dist_trend_plot(sev_race,demo = "Native Hawaiian", demo_code = "hawaii_perc", corridor_name = "17th Street", cat = "Residents", construct_year = 2011, end_year = 2012, 0,20)

other_plot <- dist_trend_plot(sev_race,demo = "Two or More Races", demo_code = "other_perc",  corridor_name = "17th Street", cat = "Residents", construct_year = 2011, end_year = 2012, 0,20)

prow <- plot_grid(white_plot + theme(legend.position="none"),
                  black_plot + theme(legend.position="none"),
                  ameindian_plot + theme(legend.position="none"),
                  asian_plot + theme(legend.position="none"),
                  hawaii_plot + theme(legend.position="none"),
                  other_plot + theme(legend.position="none"), 
           align = 'vh', hjust = -1, nrow = 3)

legend_b <- get_legend(white_plot + theme(legend.position="bottom"))

plot_grid( prow, legend_b, ncol = 1, rel_heights = c(4, .2))
```

## residence -race (table)
```{r}
start_end_race <- sev_race %>% filter(year >=2011) %>%
  select(Type, year, ends_with("_perc")) %>% # select variables ends with "_perc"
  filter(complete.cases(.)) %>%
  group_by(Type) %>% 
  summarise_at(vars(ends_with("_perc")), funs(change = (last(.)-first(.))/first(.)/4*100))

  
# calculate year by year race categories percentage change  
y_o_y_race <- sev_race %>% filter(year >=2011) %>%
  select(Type, year, ends_with("_perc")) %>% 
  mutate_if(is.numeric, funs(change = ./lag(.)*100 -100)) %>% 
  group_by(Type) %>% 
  summarise_at(vars(ends_with("_change")), funs(mean(., na.rm=T)))

```



## additional distributional analysis - education (line chart)
```{r echo=FALSE, fig.asp=1, fig.width=9.5, message=FALSE, warning=FALSE}
sev_edu <- sf_corridor %>% as.data.frame() %>% filter(Group == 2) %>% 
  group_by(Type, year) %>% 
  summarise(
    hisch_under = sum(CD01), hisch = sum(CD02), col = sum(CD03), bach = sum(CD04), tot_emp = sum(C000)) %>% 
  mutate(hisch_under_perc = hisch_under/tot_emp*100,
         hisch_perc = hisch/tot_emp*100,
         col_perc = col/tot_emp*100,
         bach_perc = bach/tot_emp*100) 

sf_edu <- sf_lehd %>% 
  group_by(year) %>% 
  summarise(
    hisch_under = sum(CD01), hisch = sum(CD02), col = sum(CD03), bach = sum(CD04), tot_emp = sum(C000)) %>% 
  mutate(hisch_under_perc = hisch_under/tot_emp*100,
         hisch_perc = hisch/tot_emp*100,
         col_perc = col/tot_emp*100,
         bach_perc = bach/tot_emp*100,
         Type = "City") %>% 
  select(Type, year:bach_perc) %>% as.data.frame(.)


sev_edu <- rbind(as.data.frame(sev_edu), as.data.frame(sf_edu))
sev_edu[sev_edu$year<2009,][,c(3:6,8:11)] <- NA
sev_edu$Type <- as.factor(as.character(sev_edu$Type))
  

hisch_under_plot <- dist_trend_plot(sev_edu,demo = "Less Than High School", demo_code = "hisch_under_perc", corridor_name = "17th Street", cat = "Employment", construct_year = 2011, end_year = 2012, 0, 20)

hisch_plot <- dist_trend_plot(sev_edu,demo = "High School", demo_code = "hisch_perc", corridor_name = "17th Street", cat = "Employment", construct_year = 2011, end_year = 2012, 5, 25)

col_plot <- dist_trend_plot(sev_edu,demo = "College", demo_code = "col_perc", corridor_name = "17th Street", cat = "Employment", construct_year = 2011, end_year = 2012, 12, 32)

bach_plot <- dist_trend_plot(sev_edu,demo = "Bachelor or Above", demo_code = "bach_perc", corridor_name = "17th Street", cat = "Employment", construct_year = 2011, end_year = 2012, 20,40)

prow <- plot_grid(hisch_under_plot + theme(legend.position="none"),
                  hisch_plot + theme(legend.position="none"),
                  col_plot + theme(legend.position="none"),
                  bach_plot + theme(legend.position="none"),
           align = 'vh', hjust = -1, nrow = 2)

legend_b <- get_legend(col_plot + theme(legend.position="bottom"))

plot_grid( prow, legend_b, ncol = 1, rel_heights = c(4, .2))
```

## additional distributional analysis - edu (table)
```{r}
start_end_edu <- sev_edu %>% filter(year>=2011) %>% 
  select(Type, year, ends_with("_perc")) %>% # select variables ends with "_perc"
  filter(complete.cases(.)) %>%
  group_by(Type) %>% 
  summarise_at(vars(ends_with("_perc")), funs(change = (last(.)-first(.))/first(.)/4*100))
  
  
# calculate year by year race categories percentage change  
y_o_y_edu <- sev_edu %>% 
  select(Type, year, ends_with("_perc")) %>% 
  mutate_if(is.numeric, funs(change = ./lag(.)*100 -100)) %>% 
  group_by(Type) %>% 
  summarise_at(vars(ends_with("_change")), funs(mean(., na.rm=T)))
```

## residence - education (line chart)
```{r echo=FALSE, fig.asp=1, fig.width=9.5, message=FALSE, warning=FALSE}
sev_edu <- sf_corridor_rac %>% as.data.frame() %>% filter(Group == 2) %>% 
  group_by(Type, year) %>% 
  summarise(
    hisch_under = sum(CD01), hisch = sum(CD02), col = sum(CD03), bach = sum(CD04), tot_emp = sum(C000)) %>% 
  mutate(hisch_under_perc = hisch_under/tot_emp*100,
         hisch_perc = hisch/tot_emp*100,
         col_perc = col/tot_emp*100,
         bach_perc = bach/tot_emp*100) 

sf_edu <- sf_rac %>% 
  group_by(year) %>% 
  summarise(
    hisch_under = sum(CD01), hisch = sum(CD02), col = sum(CD03), bach = sum(CD04), tot_emp = sum(C000)) %>% 
  mutate(hisch_under_perc = hisch_under/tot_emp*100,
         hisch_perc = hisch/tot_emp*100,
         col_perc = col/tot_emp*100,
         bach_perc = bach/tot_emp*100,
         Type = "City") %>% 
  select(Type, year:bach_perc) %>% as.data.frame(.)


sev_edu <- rbind(as.data.frame(sev_edu), as.data.frame(sf_edu))
sev_edu[sev_edu$year<2009,][,c(3:6,8:11)] <- NA
sev_edu$Type <- as.factor(as.character(sev_edu$Type))
  

hisch_under_plot <- dist_trend_plot(sev_edu,demo = "Less Than High School", demo_code = "hisch_under_perc", corridor_name = "17th Street", cat = "Residents", construct_year = 2011, end_year = 2012, 5, 15)

hisch_plot <- dist_trend_plot(sev_edu,demo = "High School", demo_code = "hisch_perc", corridor_name = "17th Street", cat = "Residents", construct_year = 2011, end_year = 2012, 8, 18)

col_plot <- dist_trend_plot(sev_edu,demo = "College", demo_code = "col_perc", corridor_name = "17th Street", cat = "Residents", construct_year = 2011, end_year = 2012, 15, 25)

bach_plot <- dist_trend_plot(sev_edu,demo = "Bachelor or Above", demo_code = "bach_perc", corridor_name = "17th Street", cat = "Residents", construct_year = 2011, end_year = 2012, 28,38)

prow <- plot_grid(hisch_under_plot + theme(legend.position="none"),
                  hisch_plot + theme(legend.position="none"),
                  col_plot + theme(legend.position="none"),
                  bach_plot + theme(legend.position="none"),
           align = 'vh', hjust = -1, nrow = 2)

legend_b <- get_legend(col_plot + theme(legend.position="bottom"))

plot_grid( prow, legend_b, ncol = 1, rel_heights = c(4, .2))
```


## distributional rac - edu table
```{r echo=FALSE, fig.asp=1, fig.width=9.5, message=FALSE, warning=FALSE}
  
start_end_edu <- sev_edu %>% filter(year>=2011) %>% 
  select(Type, year, ends_with("_perc")) %>% # select variables ends with "_perc"
  filter(complete.cases(.)) %>%
  group_by(Type) %>% 
  summarise_at(vars(ends_with("_perc")), funs(change = (last(.)-first(.))/first(.)/4*100))
  
  
# calculate year by year race categories percentage change  
y_o_y_edu <- sev_edu %>% 
  select(Type, year, ends_with("_perc")) %>% 
  mutate_if(is.numeric, funs(change = ./lag(.)*100 -100)) %>% 
  group_by(Type) %>% 
  summarise_at(vars(ends_with("_change")), funs(mean(., na.rm=T))) 

```

## gender
```{r echo=FALSE, fig.asp=0.5, fig.width=9.5, message=FALSE, warning=FALSE}
sev_gender <- sf_corridor %>% as.data.frame() %>% filter(Group == 2) %>% 
  group_by(Type, year) %>% 
  summarise(female = sum(CS02), tot_emp = sum(C000)) %>% 
  mutate(female_perc = female/tot_emp*100) 

sf_gender <- sf_lehd %>% 
  group_by(year) %>% 
  summarise(female = sum(CS02), tot_emp = sum(C000)) %>% 
  mutate(female_perc = female/tot_emp*100,
         Type = "City") %>% 
  select(Type, year:female_perc) %>% as.data.frame(.)

sev_gender <- rbind(as.data.frame(sev_gender), as.data.frame(sf_gender))
sev_gender[sev_gender$year<2009,][,c(3,5)] <- NA
sev_gender$Type <- as.factor(as.character(sev_gender$Type))

gender_plot <- dist_trend_plot(sev_gender,demo = "Female", demo_code = "female_perc", corridor_name = "17th Street", cat = "Employment", construct_year = 2011, end_year = 2012, 47, 57.5)

sev_gender_rac <- sf_corridor_rac %>% as.data.frame() %>% filter(Group == 2) %>% 
  group_by(Type, year) %>% 
  summarise(female = sum(CS02), tot_emp = sum(C000)) %>% 
  mutate(female_perc = female/tot_emp*100) 

sf_gender_rac <- sf_rac %>% 
  group_by(year) %>% 
  summarise(female = sum(CS02), tot_emp = sum(C000)) %>% 
  mutate(female_perc = female/tot_emp*100,
         Type = "City") %>% 
  select(Type, year:female_perc) %>% as.data.frame(.) 

sev_gender_rac <- rbind(as.data.frame(sev_gender_rac), as.data.frame(sf_gender_rac))
sev_gender_rac[sev_gender_rac$year<2009,][,c(3,5)] <- NA
sev_gender_rac$Type <- as.factor(as.character(sev_gender_rac$Type))

gender_rac_plot <- dist_trend_plot(sev_gender_rac,demo = "Female", demo_code = "female_perc", corridor_name = "17th Street", cat = "Residents", construct_year = 2009, end_year = 2010, 40, 50)

prow <- plot_grid(gender_plot + theme(legend.position="none"),
                  gender_rac_plot + theme(legend.position="none"),
           align = 'vh', hjust = -1, nrow = 1)

legend_b <- get_legend(gender_plot + theme(legend.position="bottom"))

plot_grid( prow, legend_b, ncol = 1, rel_heights = c(4, .2))
```
