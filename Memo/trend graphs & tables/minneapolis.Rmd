---
title: "Minneapolis trend tables"
author: "Wei Shi"
date: "March 15, 2019"
output: html_document
---


```{r message=FALSE, warning=FALSE, include=FALSE}

if(!require(pacman)){install.packages("pacman"); library(pacman)}
p_load(here, RPostgreSQL, sf, ggplot2, directlabels,ggthemes, lubridate, dplyr, dbplyr, stargazer,cowplot, zoo, tidyr, kableExtra, data.table, bindrcpp, knitr, pander)


user <- "shiwei"
host <- "pgsql102.rc.pdx.edu"
pw <- scan(here::here("batteries.pgpss"), what = "")
dbname <- "bike_lanes"

con <- dbConnect("PostgreSQL", host = host, user = user, dbname = dbname, 
                 password = pw, port = 5433)


source(here::here("Code/corridor_comparison_functions.R"))

minn_corridor <- st_read(dsn = con, query = "select a.geoid10 as geoid, a.c000 as c000,
a.cns07 as cns07, a.cns08 as cns08, a.cns12 as cns12, a.cns14 as cns14, a.cns15 as cns15, a.cns16 as cns16, a.cns17 as cns17, a.cns18 as cns18, a.cns19 as cns19, b.name as Name, 
b.buildstart as buildstart, b.buildend as buildend, b.group as corridor_group, 
b.type as grouptype,  a.year as year, a.geometry as geom
FROM minneapolis_lehd a, minneapolis_corridors b
WHERE ST_Intersects(ST_Buffer(b.geom, 20), a.geometry);")

minn_corridor <- minn_corridor %>%
  rename(C000 = c000, CNS07 = cns07, CNS08 = cns08,CNS18 = cns18, CNS12 = cns12, CNS14 = cns14, CNS15 = cns15,CNS16 = cns16, CNS17 = cns17, CNS18 = cns18, CNS19 = cns19, Group = corridor_group, BuildStart = buildstart, BuildEnd = buildend, Name = name)
#add new colume of construct year as numeric

minn_lehd <- st_read(dsn = con, "minneapolis_lehd") %>% as.data.frame()

minn_lehd <- minn_lehd %>%
  rename(C000 = c000, CNS07 = cns07, CNS08 = cns08,CNS18 = cns18, CNS12 = cns12, CNS14 = cns14, CNS15 = cns15,CNS16 = cns16, CNS17 = cns17, CNS18 = cns18, CNS19 = cns19)

minn_corridor <- minn_corridor %>% rename(Type = grouptype)

minn_sale <- tbl(con, "minn_sales_tax") %>% collect()
minn_qcew <- tbl(con, "minneapolis_qcew_modified") %>% collect()

```

# functions
```{r message=FALSE, warning=FALSE, include=FALSE}
percent <- function(x, digits = 2, format = "f", ...) {
  paste0(formatC(100 * x, format = format, digits = digits, ...), "%")
}

lehd_t <- function(df, construction_year){
  base_start= construction_year-3
  base_end = construction_year-1
  post_start=construction_year+1
  post_end=construction_year+3
  
  base <- filter(df, year%in%(base_start:base_end)) %>% 
    select(Type, CNS07, CNS18) %>% 
  group_by(Type) %>% 
  mutate(CNS07_base = (CNS07/lag(CNS07)-1),
          CNS18_base = (CNS18/lag(CNS18)-1)) %>% 
  summarise(CNS07=round(mean(CNS07),0), CNS18=round(mean(CNS18),0), 
         CNS07_base = mean(CNS07_base,na.rm=T), CNS18_base = mean(CNS18_base,na.rm=T)) 
  
  post <- df %>% filter (year %in% c(post_start:post_end)) %>% ungroup() %>% 
    rbind(base %>% mutate(year=construction_year-2, business=CNS07+CNS18) %>% 
            select(year, Type, CNS07, CNS18, business)) %>% arrange(by_group=year) %>% 
    group_by(Type) %>% mutate(CNS07 = (CNS07/lag(CNS07)-1),CNS18 = (CNS18/lag(CNS18)-1))

  post <- dcast(setDT(post), Type ~ year, value.var = c("CNS07", "CNS18")) 
  post <- post[,-c(2,6)]
  post <- post %>% mutate(CNS07_post = rowMeans(select(.,starts_with("CNS07"))),
                          CNS18_post = rowMeans(select(.,starts_with("CNS18"))))

  lehd <- merge(base,post, by="Type") %>% 
    select(Type, CNS07,CNS07_base, starts_with("CNS07"),CNS18,CNS18_base, starts_with("CNS18")) %>%
    arrange(desc(Type)) %>% mutate_at(vars(contains("CNS07_")), percent) %>% mutate_at(vars(contains("CNS18_")), percent)

  coln <- c("Area", "Base","Growth", "1st Year", "2nd Year", "3rd Year","Average",
          "Base","Growth", "1st Year", "2nd Year", "3rd Year","Average")
  names(lehd)<-coln

  return(lehd)
}


sales_t <- function(df, construction_year){
  base_start= ifelse(construction_year==2012,construction_year-4, construction_year-3)
  base_end = ifelse(construction_year==2012,construction_year-2, construction_year-1)
  post_start=ifelse(construction_year==2012,construction_year+2, construction_year+1)
  post_end=ifelse(construction_year==2009,construction_year+5, construction_year+5)
  # sales data miss 2011 and 2013 data, to keep three data points before and after, different corridor use different start and end years 
  
  base <- filter(df, year%in%(base_start:base_end)) %>% 
    select(Type, CNS07, CNS18) %>% 
  group_by(Type) %>% 
  mutate(CNS07_base = (CNS07/lag(CNS07)-1),
          CNS18_base = (CNS18/lag(CNS18)-1)) %>% 
  summarise(CNS07=round(mean(CNS07,na.rm=T),0), CNS18=round(mean(CNS18,na.rm=T),0), 
         CNS07_base = mean(CNS07_base,na.rm=T), CNS18_base = mean(CNS18_base,na.rm=T)) 
  
  post <- df %>% filter (year %in% c(post_start:post_end)) %>% ungroup() %>% 
    rbind(base %>% mutate(year=construction_year-2, business=CNS07+CNS18) %>% 
            select(year, Type, CNS07, CNS18, business)) %>% arrange(by_group=year) %>% 
    group_by(Type) %>% mutate(CNS07 = (CNS07/lag(CNS07)-1),CNS18 = (CNS18/lag(CNS18)-1))

  post <- dcast(setDT(post), Type ~ year, value.var = c("CNS07", "CNS18")) 
  post <- post[,-c(2,6)]
  post <- post %>% mutate(CNS07_post = rowMeans(select(.,starts_with("CNS07"))),
                          CNS18_post = rowMeans(select(.,starts_with("CNS18"))))

  sales <- merge(base,post, by="Type") %>% 
    select(Type, CNS07,CNS07_base, starts_with("CNS07"),CNS18,CNS18_base, starts_with("CNS18")) %>%
    arrange(desc(Type)) %>% mutate_at(vars(contains("CNS07_")), percent) %>% mutate_at(vars(contains("CNS18_")), percent)

  coln <- c("Area", "Base","Growth", "1st Year", "2nd Year", "3rd Year","Average",
          "Base","Growth", "1st Year", "2nd Year", "3rd Year","Average")
  names(sales)<-coln

  return(sales)
}

qcew_t <- function(df, construction_year){
  base_start= construction_year-3
  base_end = construction_year-1
  post_start=construction_year+1
  post_end=construction_year+3
  
  df <- df %>% rename(CNS07=avg_emp) %>% 
    group_by(year, Type) %>% 
    summarise(CNS07=mean(CNS07,na.rm=T)) %>% 
    mutate(CNS18=0, business=CNS07+CNS18) %>% select(year, Type, CNS07, CNS18, business) 
  
  base <- filter(df, year%in%(base_start:base_end)) %>% 
    select(Type, CNS07, CNS18) %>% 
  group_by(Type) %>% 
  mutate(CNS07_base = (CNS07/lag(CNS07)-1),
          CNS18_base = (CNS18/lag(CNS18)-1)) %>% 
  summarise(CNS07=round(mean(CNS07),0), CNS18=round(mean(CNS18),0), 
         CNS07_base = mean(CNS07_base,na.rm=T), CNS18_base = mean(CNS18_base,na.rm=T)) 
  
  post <- df %>% filter (year %in% c(post_start:post_end)) %>% ungroup() %>% 
    rbind(base %>% mutate(year=construction_year-2, business=CNS07+CNS18) %>% 
            select(year, Type, CNS07, CNS18, business)) %>% arrange(by_group=year) %>% 
    group_by(Type) %>% mutate(CNS07 = (CNS07/lag(CNS07)-1),CNS18 = (CNS18/lag(CNS18)-1))

  post <- dcast(setDT(post), Type ~ year, value.var = c("CNS07", "CNS18")) 
  post <- post[,-c(2,6)]
  post <- post %>% mutate(CNS07_post = rowMeans(select(.,starts_with("CNS07"))),
                          CNS18_post = rowMeans(select(.,starts_with("CNS18"))))

  qcew <- merge(base,post, by="Type") %>% 
    select(Type, CNS07,CNS07_base, starts_with("CNS07"),CNS18,CNS18_base, starts_with("CNS18")) %>%
    arrange(desc(Type)) %>% mutate_at(vars(contains("CNS07_")), percent) 

  coln <- c("Area", "Base","Growth", "1st Year", "2nd Year", "3rd Year","Average",
          "Base","Growth", "1st Year", "2nd Year", "3rd Year","Average")
  names(qcew)<-coln
  
  qcew[is.na(qcew)]<-NA
  qcew[qcew==0]<-NA

  return(qcew)
}

plot_t <- function(df){
  options(knitr.kable.NA = '-')
  plot <- knitr::kable(t, align = "lcccccccccccc",  format.args = list(big.mark = ",")) %>%
  kable_styling(bootstrap_options = c("striped", "hover", "bordered", "condensed"), full_width=F, font_size=11) %>% 
  add_header_above(c("","Baseline"=2,"Post-implementation"=4,"Baseline"=2,"Post-implementation"=4)) %>% 
  add_header_above(c("", "Retail"= 6, "Food"= 6)) %>% 
  row_spec(c(1,3,5),background="#ccffcc") %>% 
  group_rows("LEHD: (employment)",1,2) %>% 
  group_rows("Sales: (sales revenue, $)",3,4) %>% 
  group_rows("QCEW: (employment)",5,6) %>% 
  footnote(number = c("Baseline is defined as the average of previous three years before construction year;",
             "Pre-growth rate is defined as average of baseline annual growth rate;",
             "1st year growth rate is defined as the growth rate of the year after construction compared to baseline."))

  return(plot)

}

plot_tc <- function(df){
  options(knitr.kable.NA = '-')
  plot <- knitr::kable(t_c, align = "llcccccc", format.args = list(big.mark = ",")) %>%
  kable_styling(bootstrap_options = c("striped", "bordered", "condensed"), full_width=F, font_size=11) %>% 
  add_header_above(c("","", "Retail"= 3, "Food"= 3)) %>% 
  row_spec(c(1,3,5),background="#ccffcc") %>% 
  column_spec(1, bold=T,background="white", width="0.5in") %>% 
  collapse_rows(columns=1) %>% 
  footnote(number = c("Baseline is defined as the average of previous three years before construction year;",
             "Pre-growth rate is defined as average of baseline annual growth rate;",
             "Post-growth rate is defined as average annual growth rate of three time points after construction year."))

  return(plot)
}

```

# riverside
```{r, echo=FALSE, message=FALSE, warning=FALSE,results="asis"}

riverside_lehd <- agg_trend_table(minn_corridor, group = 1) %>% 
  mutate(Type =ifelse(Type == "control", "Control: Cedar Ave", "Treatment")) 

lehd <- lehd_t(riverside_lehd, 2009)


riverside_sale <- agg_trend_table(minn_sale, group = 1) %>% 
  mutate(Type = case_when(Type == " Improvement" ~ "Treatment",
                          Type == "Control" ~ "Control: Cedar Ave"))
sales <- sales_t(riverside_sale, 2009)


riverside_qcew <- minn_qcew %>% filter(corridors == "Riverside Ave" | corridors == "Cedar Ave") %>% 
  mutate(Type = case_when(street_type == "improvement" ~ "Treatment",
                                 street_type == "control" ~ "Control: Cedar Ave")) 

qcew <- qcew_t(riverside_qcew, 2009)


# make combined table         
t <- rbind(lehd, sales, qcew)
 
plot_t(t)


t_c <- t[c(1:3,7:9,13)] 
data <- data.frame(c(rep("LEHD: \n (employment)",2), rep("Sales: \n(sales revenue, $)",2),rep("QCEW: \n(employment)",2)))
t_c <- bind_cols(data, t_c)
coln <- c("Data","Area", "Baseline","Pre-Growth", "Post-Growth","Baseline","Pre-Growth", "Post-Growth")
names(t_c)<-coln

plot_tc(t_c)

```


# franklin
```{r, echo=FALSE, message=FALSE, warning=FALSE,results="asis"}

franklin_lehd <- agg_trend_table(minn_corridor, group = 2) %>% 
  mutate(Type =ifelse(Type == "control", "Control: Franklin Ave", "Treatment")) 

lehd <- lehd_t(franklin_lehd, 2011)


franklin_sale <- agg_trend_table(minn_sale, group = 2) 
sales <- sales_t(franklin_sale, 2011)


franklin_qcew <- minn_qcew %>% filter(corridors == "Franklin Ave") %>% 
  mutate(Type = case_when(street_type == "improvement" ~ "Treatment",
                                 street_type == "control" ~ "Control: Franklin Ave")) 

qcew <- qcew_t(franklin_qcew, 2011)


# make combined table         
t <- rbind(lehd, qcew)
 
knitr::kable(t, align = "lcccccccccccc",  format.args = list(big.mark = ",")) %>%
  kable_styling(bootstrap_options = c("striped", "hover", "bordered", "condensed"), full_width=F, font_size=11) %>%
  add_header_above(c("","Baseline"=2,"Post-implementation"=4,"Baseline"=2,"Post-implementation"=4)) %>% 
  add_header_above(c("", "Retail"= 6, "Food"= 6)) %>% 
  row_spec(c(1,3),background="#ccffcc") %>% 
  group_rows("LEHD: (employment)",1,2) %>% 
  group_rows("QCEW: (employment)",3,4) %>% 
  footnote(number = c("Baseline is defined as the average of previous three years before construction year;",
             "Pre-growth rate is defined as average of baseline annual growth rate;",
             "1st year growth rate is defined as the growth rate of the year after construction compared to baseline."))



t_c <- t[c(1:3,7:9,13)] 
data <- data.frame(c(rep("LEHD: \n (employment)",2), rep("QCEW: \n(employment)",2)))
t_c <- bind_cols(data, t_c)
coln <- c("Data","Area", "Baseline","Pre-Growth", "Post-Growth","Baseline","Pre-Growth", "Post-Growth")
names(t_c)<-coln

knitr::kable(t_c, align = "llcccccc", format.args = list(big.mark = ",")) %>%
  kable_styling(bootstrap_options = c("striped", "bordered", "condensed"), full_width=F, font_size=11) %>% 
  add_header_above(c("","", "Retail"= 3, "Food"= 3)) %>% 
  row_spec(c(1,3),background="#ccffcc") %>% 
  column_spec(1, bold=T,background="white", width="0.5in") %>% 
  collapse_rows(columns=1) %>% 
  footnote(number = c("Baseline is defined as the average of previous three years before construction year;",
             "Pre-growth rate is defined as average of baseline annual growth rate;",
             "Post-growth rate is defined as average annual growth rate of three time points after construction year."))

```



# central
```{r, echo=FALSE, message=FALSE, warning=FALSE,results="asis"}

central_lehd <- agg_trend_table(minn_corridor, group = 3) %>% 
  mutate(Type =ifelse(Type == "control", "Control: University Ave", "Treatment")) 

lehd <- lehd_t(central_lehd, 2012)


central_sale <- agg_trend_table(minn_sale, group = 3) %>% 
  mutate(Type = case_when(Type == " Improvement" ~ "Treatment",
                          Type == "Control" ~ "Control: University Ave"))
sales <- sales_t(central_sale, 2012)


central_qcew <- minn_qcew %>% filter(corridors == "Central Ave" | corridors == "University Ave") %>% 
  mutate(Type = case_when(street_type == "improvement" ~ "Treatment",
                                 street_type == "control" ~ "Control: University Ave")) 

qcew <- qcew_t(central_qcew, 2012)


# make combined table         
t <- rbind(lehd, sales, qcew)
 
plot_t(t)


t_c <- t[c(1:3,7:9,13)] 
data <- data.frame(c(rep("LEHD: \n (employment)",2), rep("Sales: \n(sales revenue, $)",2),rep("QCEW: \n(employment)",2)))
t_c <- bind_cols(data, t_c)
coln <- c("Data","Area", "Baseline","Pre-Growth", "Post-Growth","Baseline","Pre-Growth", "Post-Growth")
names(t_c)<-coln

plot_tc(t_c)

```


# lyndale
```{r, echo=FALSE, message=FALSE, warning=FALSE,results="asis"}

lyndale_lehd <- agg_trend_table(minn_corridor, group = 4) %>% 
  mutate(Type =ifelse(Type == "control", "Control: Grand Ave", "Treatment")) 

lehd <- lehd_t(lyndale_lehd, 2008)


lyndale_sale <- agg_trend_table(minn_sale, group = 4) %>% 
  mutate(Type = case_when(Type == " Improvement" ~ "Treatment",
                          Type == "Control" ~ "Control: Grand Ave"))
sales <- sales_t(lyndale_sale, 2008)


lyndale_qcew <- minn_qcew %>% filter(corridors == "Lyndale Ave S" | corridors == "Grand Ave") %>% 
  mutate(Type = case_when(street_type == "improvement" ~ "Treatment",
                                 street_type == "control" ~ "Control: Grand Ave")) 

qcew <- qcew_t(lyndale_qcew, 2012)


# make combined table         
t <- rbind(lehd, sales, qcew)
 
plot_t(t)


t_c <- t[c(1:3,7:9,13)] 
data <- data.frame(c(rep("LEHD: \n (employment)",2), rep("Sales: \n(sales revenue, $)",2),rep("QCEW: \n(employment)",2)))
t_c <- bind_cols(data, t_c)
coln <- c("Data","Area", "Baseline","Pre-Growth", "Post-Growth","Baseline","Pre-Growth", "Post-Growth")
names(t_c)<-coln

plot_tc(t_c)

```

# North second
```{r, echo=FALSE, message=FALSE, warning=FALSE,results="asis"}

lyndale_lehd <- agg_trend_table(minn_corridor, group = 5) %>% 
  mutate(Type =ifelse(Type == "control", "Control: Broadway Ave", "Treatment")) 

lehd <- lehd_t(lyndale_lehd, 2011)


lyndale_sale <- agg_trend_table(minn_sale, group = 5) %>% 
  mutate(Type = case_when(Type == " Improvement" ~ "Treatment",
                          Type == "Control" ~ "Control: Broadway Ave"))

base <- filter(lyndale_sale, year%in%(2008:2010)) %>% 
    select(Type, CNS07, CNS18) %>% 
  group_by(Type) %>% 
  mutate(CNS07_base = (CNS07/lag(CNS07)-1),
          CNS18_base = (CNS18/lag(CNS18)-1)) %>% 
  summarise(CNS07=round(mean(CNS07,na.rm=T),0), CNS18=round(mean(CNS18,na.rm=T),0), 
         CNS07_base = mean(CNS07_base,na.rm=T), CNS18_base = mean(CNS18_base,na.rm=T)) 
  
  post <- lyndale_sale %>% filter (year %in% c(2012:2015)) %>% ungroup() %>% 
    rbind(base %>% mutate(year=2009, business=CNS07+CNS18) %>% 
            select(year, Type, CNS07, CNS18, business)) %>% arrange(by_group=year) %>% 
    group_by(Type) %>% mutate(CNS07 = (CNS07/lag(CNS07)-1),CNS18 = (CNS18/lag(CNS18)-1))

  post <- dcast(setDT(post), Type ~ year, value.var = c("CNS07", "CNS18")) 
  post <- post[,-c(2,6)]
  post <- post %>% mutate(CNS07_post = rowMeans(select(.,starts_with("CNS07"))),
                          CNS18_post = rowMeans(select(.,starts_with("CNS18"))))

  sales <- merge(base,post, by="Type")
  sales[is.na(sales)] <- NA
  sales<- sales %>% select(Type, CNS07,CNS07_base, starts_with("CNS07"),CNS18,CNS18_base, starts_with("CNS18")) %>%
    arrange(desc(Type)) %>% mutate_at(vars(contains("CNS07_")), percent) 

  coln <- c("Area", "Base","Growth", "1st Year", "2nd Year", "3rd Year","Average",
          "Base","Growth", "1st Year", "2nd Year", "3rd Year","Average")
  names(sales)<-coln


lyndale_qcew <- minn_qcew %>% filter(corridors == "North 2nd Street" | corridors == "Broadway Ave") %>% 
  mutate(Type = case_when(street_type == "improvement" ~ "Treatment",
                                 street_type == "control" ~ "Control: Broadway Ave")) 

qcew <- qcew_t(lyndale_qcew, 2011)


# make combined table         
t <- rbind(lehd, sales, qcew)
 
plot_t(t)


t_c <- t[c(1:3,7:9,13)] 
data <- data.frame(c(rep("LEHD: \n (employment)",2), rep("Sales: \n(sales revenue, $)",2),rep("QCEW: \n(employment)",2)))
t_c <- bind_cols(data, t_c)
coln <- c("Data","Area", "Baseline","Pre-Growth", "Post-Growth","Baseline","Pre-Growth", "Post-Growth")
names(t_c)<-coln

plot_tc(t_c)

```

#Trend plots ---- Minji

```{r, echo=FALSE, echo=FALSE, message=FALSE, warning=FALSE}

#Define functions: agg_index_trend_table, trend_agg_plot_LEHD, trend_agg_index_plot_LEHD, trend_agg_index_plot_city_LEHD

#agg_index_trend_table
agg_index_trend_table <- function(df, group, construct_year) {
  
  #prepare tables for plotting
  df <- as.data.frame(df, stringsAsFactors = FALSE)
  
  df <- df %>% filter(Group == group)
  
  start= construct_year-3
  end=construct_year-1

  df <- df %>% filter(Group == 2) %>%
    mutate(business = CNS07 + CNS18)
  

  df_agg <- df %>% group_by(year, Type) %>%
    summarise(CNS07 = sum(CNS07, na.rm = TRUE),
              CNS18 = sum(CNS18, na.rm = TRUE),
              business = sum(business, na.rm = TRUE))
  
  base_year <-  df_agg %>% filter(year %in% c(start:end)) %>% group_by(Type) %>% 
    summarise(CNS07_base = mean(CNS07), CNS18_base = mean(CNS18), business_base = mean(business))
  
  
  df_plot <- df_agg %>%  
    left_join(base_year, by = "Type") %>%
    mutate(CNS07_sd = CNS07/CNS07_base*100,
           CNS18_sd = CNS18/CNS18_base*100,
           business_sd = business/business_base*100) %>%
    select(Type, year = year, CNS07_sd, CNS18_sd, business_sd) %>% filter(!is.na(CNS07_sd))
  
  return(df_plot)
  
}

city_agg_index_trend_table <- function(df, construct_year) {
  
  if(class(df) == "sf") {
    
    df <- as.data.frame(df, stringsAsFactors = FALSE)
    
  } else {
    
    df
  }
  
  df <- df %>% mutate(business = CNS07 + CNS18)
  
  start= construct_year-3
  end=construct_year-1
  
  df_agg <- df %>% group_by(year) %>%
    summarise(CNS07 = sum(CNS07),
              CNS18 = sum(CNS18),
              business = sum(business)) %>% 
    mutate(Type = "city")
  
  base_year <-  df_agg %>% filter(year %in% c(start:end)) %>% group_by(Type) %>% 
    summarise(CNS07_base = mean(CNS07), CNS18_base = mean(CNS18), business_base = mean(business))
  
  df_plot <- df_agg %>%  
    left_join(base_year,by="Type") %>%
    mutate(CNS07_sd = CNS07/CNS07_base*100,
           CNS18_sd = CNS18/CNS18_base*100,
           business_sd = business/business_base*100,
           Type = "city") %>%
    select(Type, year, CNS07_sd, CNS18_sd, business_sd) %>% filter(!is.na(CNS07_sd))
  
  return(df_plot)
  
}


#trend_agg_plot_LEHD

trend_agg_plot_LEHD <- function(df_plot, base, industry, corridor_name, control_corridor, 
                                      industry_code = c("CNS07", "CNS18", "business"), 
                                      construct_year, end_year, construct_year2, end_year2) {

  ##convert year to proper date
  
  df_plot$year <-as.character(paste0(df_plot$year, "-01-01"))
  df_plot$year <- as.Date(df_plot$year, "%Y-%m-%d")
  
  construct_date <- as.character(paste0(construct_year-1, "-07-01"))
  construct_date <- as.Date(construct_date, "%Y-%m-%d")
  
  end_date <- as.character(paste0(end_year-1, "-07-01"))
  end_date <- as.Date(end_date, "%Y-%m-%d")
  
  construct_date2 <- as.character(paste0(construct_year-4, "-07-01"))
  construct_date2 <- as.Date(construct_date2, "%Y-%m-%d")
  
  end_date2 <- as.character(paste0(end_year-2, "-07-01"))
  end_date2 <- as.Date(end_date2, "%Y-%m-%d")
  
  ##making the plot
  
  ats_df <- ggplot(df_plot, aes(x = year, y = get(industry_code), 
                                group = Type, colour = Type, shape=Type)) + 
    geom_line()  +
    geom_rect(aes(xmin = as.Date(construct_date, "%Y"), 
                  xmax = as.Date(end_date, "%Y"), 
                  ymin = -Inf, ymax = Inf),
              fill = "#adff2f",linetype=0,alpha = 0.03) +
    
    geom_rect(aes(xmin = as.Date(construct_date2, "%Y"), 
                  xmax = as.Date(end_date2, "%Y"), 
                  ymin = -Inf, ymax = Inf),
              fill = "grey",linetype=0,alpha = 0.03) +
    
    geom_point(size = 3, fill="white") +
    scale_x_date(date_breaks = "2 years", date_labels = "%Y") +
    theme_minimal() +
    labs(title = glue("{industry} {base} Comparison:\n {corridor_name}"), x="Year",y={base},
         caption = glue("Gray shaded area is pre-construction period\n Green shaded area is construction period")) + guides(title = "Street Type") 
  
  return(ats_df)
}

#trend_agg_plot_LEHD_sa

trend_agg_plot_LEHD_sa <- function(df_plot, base, industry, corridor_name, control_corridor, 
                                      industry_code = c("CNS07", "CNS18", "business"), 
                                      construct_year, end_year, construct_year2, end_year2) {

  ##convert year to proper date
  
  df_plot$year <-as.character(paste0(df_plot$year, "-01-01"))
  df_plot$year <- as.Date(df_plot$year, "%Y-%m-%d")
  
  construct_date <- as.character(paste0(construct_year-1, "-07-01"))
  construct_date <- as.Date(construct_date, "%Y-%m-%d")
  
  end_date <- as.character(paste0(end_year-1, "-07-01"))
  end_date <- as.Date(end_date, "%Y-%m-%d")
  
  construct_date2 <- as.character(paste0(construct_year-4, "-07-01"))
  construct_date2 <- as.Date(construct_date2, "%Y-%m-%d")
  
  end_date2 <- as.character(paste0(end_year-2, "-07-01"))
  end_date2 <- as.Date(end_date2, "%Y-%m-%d")
  
  ##making the plot
  
  ats_df <- ggplot(df_plot, aes(x = year, y = get(industry_code)/1000000, 
                                group = Type, colour = Type, shape=Type)) + 
    geom_line()  +
    geom_rect(aes(xmin = as.Date(construct_date, "%Y"), 
                  xmax = as.Date(end_date, "%Y"), 
                  ymin = -Inf, ymax = Inf),
              fill = "#adff2f",linetype=0,alpha = 0.03) +
    
    geom_rect(aes(xmin = as.Date(construct_date2, "%Y"), 
                  xmax = as.Date(end_date2, "%Y"), 
                  ymin = -Inf, ymax = Inf),
              fill = "grey",linetype=0,alpha = 0.03) +
    
    geom_point(size = 3, fill="white") +
    scale_x_date(date_breaks = "2 years", date_labels = "%Y") +
    theme_minimal() +
    labs(title = glue("{industry} {base} Comparison:\n {corridor_name}"), x="Year",y=paste({base}," (in millions)"),
         caption = glue("Gray shaded area is pre-construction period\n Green shaded area is construction period")) + guides(title = "Street Type") 
  
  return(ats_df)
}

#trend_agg_index_plot_LEHD

trend_agg_index_plot_LEHD <- function(df_plot, base, industry, corridor_name, control_corridor, 
                                      industry_code = c("CNS07_sd", "CNS18_sd", "business_sd"), 
                                      construct_year, end_year, construct_year2, end_year2) {

  ##convert year to proper date
  
  df_plot$year <-as.character(paste0(df_plot$year, "-01-01"))
  df_plot$year <- as.Date(df_plot$year, "%Y-%m-%d")
  
  construct_date <- as.character(paste0(construct_year-1, "-07-01"))
  construct_date <- as.Date(construct_date, "%Y-%m-%d")
  
  end_date <- as.character(paste0(end_year-1, "-07-01"))
  end_date <- as.Date(end_date, "%Y-%m-%d")
  
  construct_date2 <- as.character(paste0(construct_year-4, "-07-01"))
  construct_date2 <- as.Date(construct_date2, "%Y-%m-%d")
  
  end_date2 <- as.character(paste0(end_year-2, "-07-01"))
  end_date2 <- as.Date(end_date2, "%Y-%m-%d")
  
  ##making the plot
  
  ats_df <- ggplot(df_plot, aes(x = year, y = get(industry_code), 
                                group = Type, colour = Type, shape=Type)) + 
    geom_line()  +
    geom_rect(aes(xmin = as.Date(construct_date, "%Y"), 
                  xmax = as.Date(end_date, "%Y"), 
                  ymin = -Inf, ymax = Inf),
              fill = "#adff2f",linetype=0,alpha = 0.03) +
    
    geom_rect(aes(xmin = as.Date(construct_date2, "%Y"), 
                  xmax = as.Date(end_date2, "%Y"), 
                  ymin = -Inf, ymax = Inf),
              fill = "grey",linetype=0,alpha = 0.03) +
    
    geom_point(size = 3, fill="white") +
    scale_x_date(date_breaks = "2 years", date_labels = "%Y") +
    theme_minimal() +
    labs(title = glue("{industry} {base} Comparison:\n {corridor_name}"), x="Year",y=paste({base}," Index"),
         caption = glue("Gray shaded area is pre-construction period\n Green shaded area is construction period\n {base} is indexed to the baseline years (3 years pre-construction)")) + guides(title = "Street Type") 
  
  return(ats_df)
}


#trend_agg_index_plot_city_LEHD
trend_agg_index_plot_city_LEHD <- function(df_plot, base, industry, corridor_name, control_corridor, 
                                      industry_code = c("CNS07_sd", "CNS18_sd", "business_sd"), 
                                      construct_year, end_year, construct_year2, end_year2) {
  
  df_plot <- df_plot %>% 
    mutate(Type = case_when(Type == "improvement" ~ "Treatment",
                            Type == "control" ~ paste0("Control: ", control_corridor),
                            Type == "city" ~ "City"))

  df_plot$Type <- factor(df_plot$Type, 
                       levels = c("Treatment", paste0("Control: ", control_corridor), "City"))

  ##convert year to proper date
  
  df_plot$year <-as.character(paste0(df_plot$year, "-01-01"))
  df_plot$year <- as.Date(df_plot$year, "%Y-%m-%d")
  
  construct_date <- as.character(paste0(construct_year-1, "-07-01"))
  construct_date <- as.Date(construct_date, "%Y-%m-%d")
  
  end_date <- as.character(paste0(end_year-1, "-07-01"))
  end_date <- as.Date(end_date, "%Y-%m-%d")
  
  construct_date2 <- as.character(paste0(construct_year-4, "-07-01"))
  construct_date2 <- as.Date(construct_date2, "%Y-%m-%d")
  
  end_date2 <- as.character(paste0(end_year-2, "-07-01"))
  end_date2 <- as.Date(end_date2, "%Y-%m-%d")
  
  ##making the plot
  
  ats_df <- ggplot(df_plot, aes(x = year, y = get(industry_code), 
                                group = Type, colour = Type, shape=Type)) + 
    geom_line()  +
    geom_rect(aes(xmin = as.Date(construct_date, "%Y"), 
                  xmax = as.Date(end_date, "%Y"), 
                  ymin = -Inf, ymax = Inf),
                  fill = "#adff2f",linetype=0,alpha = 0.03) +
    
    geom_rect(aes(xmin = as.Date(construct_date2, "%Y"), 
                  xmax = as.Date(end_date2, "%Y"), 
                  ymin = -Inf, ymax = Inf),
                  fill = "grey",linetype=0,alpha = 0.03) +
    
    geom_point(size = 3, fill="white") +
    scale_x_date(date_breaks = "2 years", date_labels = "%Y") +
    theme_minimal() +
    labs(title = glue("{industry} {base} Comparison:\n {corridor_name}"), x="Year", y=paste({base}," Index"),
         caption = glue("Gray shaded area is pre-construction period\n Green shaded area is construction period\n {base} is indexed to the baseline years (3 years pre-construction)")) + guides(title = "Street Type") 
  
  return(ats_df)
}

```

#Define fuctions: trend_agg_plot_qcew, trend_agg_index_plot_qcew

```{r echo=FALSE, message=FALSE, warning=FALSE}

#trend_agg_plot_qcew
trend_agg_plot_qcew <- function(df_plot, base, industry, corridor_name, control_corridor, 
                                base_code = c("avg_emp", "total_wages"), construct_year) {

  ##making the plot
  
  ats_df <- ggplot(df_plot, aes(x = year_quarter, y = get(base_code), group = street_type, colour = street_type, shape = street_type)) + 
  geom_line() + 
    
  geom_rect(aes(xmin = construct_year-0.5, 
                xmax = construct_year+0.5, 
                ymin = -Inf, ymax = Inf),
                fill = "#adff2f",linetype=0,alpha = 0.03) +
    
  geom_rect(aes(xmin = construct_year-3.5, 
                xmax = construct_year-0.5, 
                ymin = -Inf, ymax = Inf),
                fill = "grey",linetype=0, alpha = 0.03) +
    
  scale_x_yearqtr() +
  scale_color_manual(values = c( "#F8766D","#00BFC4")) +
  theme_minimal() +
    geom_point(size = 3, fill = "white") +
  labs(x = "Quarter", y = {base}, title = glue("{industry} {base} Comparison:\n {corridor_name}"),
       caption = "Gray shaded area is pre-construction period\n Green shaded area is construction period") +
  guides(shape = guide_legend("Corridor"), colour = guide_legend("Corridor")) +
  scale_y_continuous(labels = scales::comma) +
    theme(axis.text.x = element_text(angle=45, vjust = 0.5))
  
  return(ats_df)
}

#trend_agg_plot_qcew_d
trend_agg_plot_qcew_d <- function(df_plot, base, industry, corridor_name, control_corridor, 
                                base_code = c("avg_emp", "total_wages"), construct_year) {

  ##making the plot
  
  ats_df <- ggplot(df_plot, aes(x = year_quarter, y = get(base_code)/1000000, group = street_type, colour = street_type, shape = street_type)) + 
  geom_line() + 
    
  geom_rect(aes(xmin = construct_year-0.5, 
                xmax = construct_year+0.5, 
                ymin = -Inf, ymax = Inf),
                fill = "#adff2f",linetype=0,alpha = 0.03) +
    
  geom_rect(aes(xmin = construct_year-3.5, 
                xmax = construct_year-0.5, 
                ymin = -Inf, ymax = Inf),
                fill = "grey",linetype=0,alpha = 0.03) +
    
  scale_x_yearqtr() +
    scale_color_manual(values = c( "#F8766D", "#00BFC4")) +
  theme_minimal() +
    geom_point(size = 3, fill = "white") +
  labs(x = "Quarter", y = paste({base}," (in millions)"), title = glue("{industry} {base} Comparison:\n {corridor_name}"),
       caption = "Gray shaded area is pre-construction period\n Green shaded area is construction period") +
  guides(shape = guide_legend("Corridor"), colour = guide_legend("Corridor")) +
    theme(axis.text.x = element_text(angle=45, vjust = 0.5))
  
  return(ats_df)
}

#trend_agg_plot_qcew_p
trend_agg_plot_qcew_p <- function(df_plot, base, industry, corridor_name, control_corridor, 
                                base_code = c("avg_emp", "total_wages"), construct_year) {

  ##making the plot
  
  ats_df <- ggplot(df_plot, aes(x = year_quarter, y = get(base_code)*100, group = street_type, colour = street_type, shape = street_type)) + 
  geom_line() + 
    
  geom_rect(aes(xmin = construct_year-0.5, 
                xmax = construct_year+0.5, 
                ymin = -Inf, ymax = Inf),
                fill = "#adff2f",linetype=0,alpha = 0.03) +
    
  geom_rect(aes(xmin = construct_year-3.5, 
                xmax = construct_year-0.5, 
                ymin = -Inf, ymax = Inf),
              fill = "grey",linetype=0,alpha = 0.03) +
    
  scale_x_yearqtr() +
    scale_color_manual(values = c("#F8766D","#00BFC4" )) +
  theme_minimal() +
    geom_point(size = 3, fill = "white") +
  labs(x = "Quarter", y =  paste({base}," Index"), title = glue("{industry} {base} Comparison:\n {corridor_name}"),
       caption = glue("Gray shaded area is pre-construction period\n Green shaded area is construction period\n Data are indexed to the baseline years (3 years pre-construction)")) +
  guides(shape = guide_legend("Corridor"), colour = guide_legend("Corridor")) +
 # scale_y_continuous(labels = scales::percent) +
    theme(axis.text.x = element_text(angle=45, vjust = 0.5))
  
  return(ats_df)
}

```

# Data Analysis


## Riverside Avenue

### Trend Analysis

#### LEHD

Riverside retail employment trends seem to suggest a possible positive effect of the bike infrastructure installation with a major jump in employment in the two years immediately after construction and positively trending employment growth since the initial jumps. The comparison corridor's (Cedar Avenue) employment remains basically unchanged except for a minor bump between 2010 and 2011 where employment returns to 2009 levels. 

The Riverside accommodations patterns are more mixed. Employment growth for the improvement corridor is more robust and consistent after construction compared to the control corridor. The trend analysis here implies a potential positive effect of the infrastructure construction but given the control corridor's positive trends it is not clear that the infrastructure development itself has an independent effect.

```{r, fig.width = 10, echo=FALSE, message=FALSE, warning=FALSE, fig.height= 5}

minn_corridor <- as.data.frame(minn_corridor, stringsAsFactors = FALSE)

#riverside index table and plot
riverside_agg_idx <- agg_index_trend_table(minn_corridor, group = 1, construct_year = 2009)

#city agg plots
minn_agg <- city_agg_index_trend_table(minn_lehd, construct_year = 2009)

riverside_agg_idx <- bind_rows(riverside_agg_idx, minn_agg)
riverside_agg_idx <- riverside_agg_idx %>% filter(!is.na(year))

riverside_agg_retail <- trend_agg_index_plot_city_LEHD(riverside_agg_idx, base = "Employment", industry = "Retail",
                                                       corridor_name = "Riverside Ave.", control_corridor = "Cedar Ave.",
                                                       industry_code = "CNS07_sd", construct_year = 2009, end_year = 2010)

riverside_agg_accom <- trend_agg_index_plot_city_LEHD(riverside_agg_idx, base = "Employment", industry = "Food",
                                                      corridor_name = "Riverside Ave.", control_corridor = "Cedar Ave.",
                                                      industry_code = "CNS18_sd", construct_year = 2009, end_year = 2010)

prow <- plot_grid(riverside_agg_retail + theme(legend.position="none"),
                  riverside_agg_accom + theme(legend.position="none"),
                  align = 'vh', hjust = -1, nrow = 1)

legend_b <- get_legend(riverside_agg_retail + theme(legend.position="bottom"))

plot_grid(prow, legend_b, ncol = 1, rel_heights = c(4, .2))

```

#### Sales Tax 

```{r, echo=FALSE, message=FALSE, warning=FALSE, fig.width = 10, fig.height= 10}

#prep corridor sales tax df from Wei---------------
minn_sale <- tbl(con, "minn_sales_tax")
minn_sale <- collect(minn_sale)

riverside_agg <- agg_trend_table(minn_sale, group = 1)
riverside_agg <- riverside_agg %>% 
  mutate(Type = case_when(Type == " Improvement" ~ "Treatment",
                          Type == "Control" ~ "Control: Cedar Ave."))
riverside_agg$Type <- factor(riverside_agg$Type, levels = c("Treatment", "Control: Cedar Ave."))

riverside_agg_idx <- agg_index_trend_table (minn_sale, group = 1, construct_year = 2009)
riverside_agg_idx <- riverside_agg_idx %>% 
  mutate(Type = case_when(Type == " Improvement" ~ "Treatment",
                          Type == "Control" ~ "Control: Cedar Ave.")) 
riverside_agg_idx$Type <- factor(riverside_agg_idx$Type, levels = c("Treatment", "Control: Cedar Ave."))

#riverside graphs------------

<<<<<<< HEAD
riverside_agg_retail_plot <- trend_agg_plot_LEHD_sa(riverside_agg, base = "Sales Revenue", industry = "Retail", corridor_name = "Riverside Ave.", control_corridor = "Cedar Ave.", industry_code = "CNS07", construct_year = 2009, end_year = 2010)

riverside_agg_accom_plot <- trend_agg_plot_LEHD_sa(riverside_agg, base = "Sales Revenue", industry = "Food", corridor_name = "Riverside Ave.", control_corridor = "Cedar Ave.", industry_code = "CNS18", construct_year = 2009, end_year = 2010)
 
riverside_agg_retail_idx_plot <- trend_agg_index_plot_LEHD(riverside_agg_idx, base = "Sales Revenue", industry = "Retail", corridor_name = "Riverside Ave.", control_corridor = "Cedar Ave.", industry_code = "CNS07_sd", construct_year = 2009, end_year = 2010)

riverside_agg_idx_accom_plot <- trend_agg_index_plot_LEHD(riverside_agg_idx, base = "Sales Revenue", industry = "Food", corridor_name = "Riverside Ave.", control_corridor = "Cedar Ave.", industry_code = "CNS18_sd", construct_year = 2009, end_year = 2010)
=======
riverside_agg_retail_plot <- trend_agg_plot_LEHD_sa(riverside_agg, base = "Sales Tax", industry = "Retail",
                                                    corridor_name = "Riverside Ave.", control_corridor = "Cedar Ave.",
                                                    industry_code = "CNS07", construct_year = 2009, end_year = 2010)

riverside_agg_accom_plot <- trend_agg_plot_LEHD_sa(riverside_agg, base = "Sales Tax", industry = "Food",
                                                   corridor_name = "Riverside Ave.", control_corridor = "Cedar Ave.",
                                                   industry_code = "CNS18", construct_year = 2009, end_year = 2010)
 
riverside_agg_retail_idx_plot <- trend_agg_index_plot_LEHD(riverside_agg_idx, base = "Sales",
                                                           industry = "Retail", corridor_name = "Riverside Ave.",
                                                           control_corridor = "Cedar Ave.", industry_code = "CNS07_sd",
                                                           construct_year = 2009, end_year = 2010)

riverside_agg_idx_accom_plot <- trend_agg_index_plot_LEHD(riverside_agg_idx, base = "Sales", industry = "Food",
                                                          corridor_name = "Riverside Ave.", control_corridor = "Cedar Ave.",
                                                          industry_code = "CNS18_sd", construct_year = 2009, end_year = 2010)
>>>>>>> 1d3e5496943849fc9b98e75f69f5404983bc6060

prow <- plot_grid(riverside_agg_retail_plot + theme(legend.position="none"),
                  riverside_agg_accom_plot + theme(legend.position="none"),
                  riverside_agg_retail_idx_plot + theme(legend.position="none"),
                  riverside_agg_idx_accom_plot + theme(legend.position="none"),
                  align = 'vh', hjust = -1, nrow = 2)

legend_b <- get_legend(riverside_agg_retail_plot + theme(legend.position="bottom"))

plot_grid( prow, legend_b, ncol = 1, rel_heights = c(4, .2))

```

#### QCEW

```{r, echo=FALSE, message=FALSE, warning=FALSE, fig.width=10, fig.height=8}

riverside_qcew <- minn_qcew %>% filter(corridors == "Riverside Ave"| corridors == "Cedar Ave") %>% 
  collect()

riverside_qcew <- riverside_qcew %>% 
  mutate(year_quarter = paste0(year,"-",quarter), 
         year_quarter = as.yearqtr(year_quarter))

riverside_qcew <- riverside_qcew %>% 
  mutate(street_type = case_when(street_type == "improvement" ~ "Treatment",
                                 street_type == "control" ~ "Control: Cedar Ave"))

riverside_qcew$street_type <- factor(riverside_qcew$street_type, 
                                     levels = c("Treatment", "Control: Cedar Ave"))

riverside_agg <- riverside_qcew %>% 
 filter(year %in% (2006:2008)) %>% 
  group_by(street_type) %>% 
  mutate(estab_base = mean(establishments), base_wage = mean(total_wages), base_avg_emp = mean(avg_emp)) %>% 
  select(corridors, street_type, estab_base, base_wage, base_avg_emp) %>% unique()

riverside_qcew <- riverside_qcew %>% 
  left_join(riverside_agg, by = c("corridors" = "corridors", "street_type" = "street_type"))

riverside_qcew <- riverside_qcew %>% 
  mutate(estab_idx = establishments/estab_base,
         wage_idx = total_wages/base_wage,
         avg_emp_idx = avg_emp/base_avg_emp)

qc_riverside1 <- trend_agg_plot_qcew(riverside_qcew, base="Employment", industry = "Retail", corridor_name = "Riverside Ave",
                                               control_corridor = "Cedar Ave", base_code = "avg_emp", construct_year = 2009)
 
qc_riverside2 <- trend_agg_plot_qcew_d(riverside_qcew, base="Total Wages", industry = "Retail", corridor_name = "Riverside Ave",
                                                       control_corridor = "Cedar Ave", base_code = "total_wages", construct_year = 2009)

prow <- plot_grid(qc_riverside1 + theme(legend.position="none"),
                  qc_riverside2 + theme(legend.position="none"),
                  align = 'vh', hjust = -1, nrow = 1)

legend_b <- get_legend(qc_riverside1 + theme(legend.position="bottom"))

plot_grid(qc_riverside1, qc_riverside2,  ncol = 1)

```

```{r, echo=FALSE, message=FALSE, warning=FALSE, fig.width=10, fig.height=8}

qc_idx_riverside1 <- trend_agg_plot_qcew_p(riverside_qcew, base="Employment", industry = "Retail", corridor_name = "Riverside Ave",
                                               control_corridor = "Cedar Ave", base_code = "avg_emp_idx", construct_year = 2009)
 
qc_idx_riverside2 <- trend_agg_plot_qcew_p(riverside_qcew, base="Total Wage", industry = "Retail", corridor_name = "Riverside Ave",
                                                       control_corridor = "Cedar Ave", base_code = "wage_idx", construct_year = 2009)

prow <- plot_grid(qc_idx_riverside1 + theme(legend.position="none"),
                  qc_idx_riverside2 + theme(legend.position="none"),
                  align = 'vh', hjust = -1, nrow = 1)

legend_b <- get_legend(qc_idx_riverside1 + theme(legend.position="bottom"))

plot_grid(qc_idx_riverside1, qc_idx_riverside2,  ncol = 1)

```


## Franklin Avenue

### Trend Analysis

#### LEHD

Retail employment does show consistent, though moderate, growth for the improvement corridor though the control corridor has a dramatic spike in employment between 2014 and 2015. In terms of overall trends, the control corridor has consistently higher year over year growth compared to the treatment corridor.

```{r, echo=FALSE, message=FALSE, warning=FALSE, fig.width = 10, fig.height= 5}

#making plots for franklin Ave.

#franklin index table and plot
franklin_agg_idx2 <- agg_index_trend_table(minn_corridor, group = 2, construct_year = 2011)

#city agg plots
minn_agg <- city_agg_index_trend_table(minn_lehd, construct_year = 2011)

franklin_agg_idx2 <- bind_rows(franklin_agg_idx2, minn_agg)
franklin_agg_idx2 <- franklin_agg_idx2 %>% filter(!is.na(year))

franklin_agg_retail <- trend_agg_index_plot_city_LEHD(franklin_agg_idx2, base = "Employment", industry = "Retail", corridor_name = "Franklin Ave.",
                                                       control_corridor = "Franklin Ave.", industry_code = "CNS07_sd", construct_year = 2011, end_year = 2012)

franklin_agg_accom <- trend_agg_index_plot_city_LEHD(franklin_agg_idx2, base = "Employment", industry = "Food", corridor_name = "Franklin Ave.",
                                                      control_corridor = "Franklin Ave.", industry_code = "CNS18_sd", construct_year = 2011, end_year = 2012)

prow <- plot_grid(franklin_agg_retail + theme(legend.position="none"),
                  franklin_agg_accom + theme(legend.position="none"),
                  align = 'vh', hjust = -1, nrow = 1)

legend_b <- get_legend(franklin_agg_retail + theme(legend.position="bottom"))

plot_grid(prow, legend_b, ncol = 1, rel_heights = c(4, .2))


```

In terms of accommodations employment the trend analysis is relatively ambiguous. In the post-construction period both the improvement and control corridor employment remained flat to slightly negative while the improvement corridor sees dramatic growth in the last year to year period. Given the timing and dramatic change in growth it is unlikely the construction itself is responsible for the spike. 

#### Sales Tax 

It was not impossible to parse out the sales tax differences between the two sections of Franklin Avenue due to their proximity so these figures are excluded from the study.


#### QCEW

The treated section of the Franklin Ave corridor has significantly more employment than the control area, but note the accelerated change in slope for the treated section a little before 2010 that carries through the construction period and finally moderates and drops in the past few quarters. This is in comparison to the relatively flat overall growth of the control section. 

```{r, echo=FALSE, message=FALSE, warning=FALSE, fig.width=10, fig.height=8}

franklin_qcew <- minn_qcew %>% filter(corridors == "Franklin Ave") %>% 
  collect()

franklin_qcew <- franklin_qcew %>% 
  mutate(year_quarter = paste0(year,"-",quarter), 
          year_quarter = as.yearqtr(year_quarter))

franklin_qcew <- franklin_qcew %>% 
  mutate(street_type = case_when(street_type == "improvement" ~ "Treatment",
                                 street_type == "control" ~ "Control: Franklin Ave"))

franklin_qcew$street_type <- factor(franklin_qcew$street_type, 
                                     levels = c("Treatment", "Control: Franklin Ave"))

franklin_agg <- franklin_qcew %>% 
 filter(year %in% (2008:2010)) %>% 
  group_by(street_type) %>% 
  mutate(estab_base = mean(establishments), base_wage = mean(total_wages), base_avg_emp = mean(avg_emp)) %>% 
  select(corridors, street_type, estab_base, base_wage, base_avg_emp) %>% unique()

franklin_qcew <- franklin_qcew %>% 
  left_join(franklin_agg, by = c("corridors" = "corridors", "street_type" = "street_type"))

franklin_qcew <- franklin_qcew %>% 
  mutate(estab_idx = establishments/estab_base,
         wage_idx = total_wages/base_wage,
         avg_emp_idx = avg_emp/base_avg_emp)

qc_franklin1 <- trend_agg_plot_qcew(franklin_qcew, base="Employment", industry = "Retail", corridor_name = "Franklin Ave",
                                               control_corridor = "Franklin Ave", base_code = "avg_emp", construct_year = 2011)
 
qc_franklin2 <- trend_agg_plot_qcew_d(franklin_qcew, base="Total Wages", industry = "Retail", corridor_name = "Franklin Ave",
                                                       control_corridor = "Franklin Ave", base_code = "total_wages", construct_year = 2011)

prow <- plot_grid(qc_franklin1 + theme(legend.position="none"),
                  qc_franklin2 + theme(legend.position="none"),
                  align = 'vh', hjust = -1, nrow = 1)

legend_b <- get_legend(qc_franklin1 + theme(legend.position="bottom"))

plot_grid(qc_franklin1, qc_franklin2,  ncol = 1)

```

The indexed figures for both total wages and average employment growth show the two corridors tracking each other closely with a slight divergence in later quarters for the treated section of the corridor. This follows logically given the fact that these are two sections of the same stretch of street. That being said, the corridor has seen robust, consistent growth over time, though it is not immediately apparent if the infrastructure construction had a clear effect from the trend analysis alone. 

```{r, echo=FALSE, message=FALSE, warning=FALSE, fig.width=10, fig.height=8}

qc_idx_franklin1 <- trend_agg_plot_qcew_p(franklin_qcew, base="Employment", industry = "Retail", corridor_name = "Franklin Ave",
                                               control_corridor = "Franklin Ave", base_code = "avg_emp_idx", construct_year = 2011)
 
qc_idx_franklin2 <- trend_agg_plot_qcew_p(franklin_qcew, base="Total Wage", industry = "Retail", corridor_name = "Franklin Ave",
                                                       control_corridor = "Franklin Ave", base_code = "wage_idx", construct_year = 2011)

prow <- plot_grid(qc_idx_franklin1 + theme(legend.position="none"),
                  qc_idx_franklin2 + theme(legend.position="none"),
                  align = 'vh', hjust = -1, nrow = 1)

legend_b <- get_legend(qc_idx_franklin1 + theme(legend.position="bottom"))

plot_grid(qc_idx_franklin1, qc_idx_franklin2,  ncol = 1)

```


## Central Avenue

### Aggregated Trend Analysis

####  LEHD

Central Avenue shows a clear positive retail employment trend post-construction for the treatment corridor that eventually overtakes the control corridor in the latest period. Note that both corridors have positive employment trends post-construction though the control corridor has its most dramatic year to year growth during the construction period. 

```{r, echo=FALSE, message=FALSE, warning=FALSE, fig.width = 10, fig.height= 5}

central_agg <- agg_index_trend_table(minn_corridor, group = 3, construct_year = 2012)
minn_agg <- city_agg_index_trend_table(minn_lehd, construct_year = 2012)

central_agg <- bind_rows(central_agg, minn_agg)

central_agg_idx_retail <- trend_agg_index_plot_city_LEHD(df_plot = central_agg, base = "Employment", industry = "Retail", corridor_name = "Central Ave.",
                                                                control_corridor = "University Ave,", industry_code = "CNS07_sd", construct_year = 2012, end_year = 2013)

central_agg_idx_accom <- trend_agg_index_plot_city_LEHD(df_plot = central_agg, base = "Employment", industry = "Food", corridor_name = "Central Ave.",
                                                               control_corridor = "University Ave,", industry_code = "CNS18_sd", construct_year = 2012, end_year = 2013)

prow <- plot_grid(central_agg_idx_retail + theme(legend.position="none"),
                  central_agg_idx_accom + theme(legend.position="none"),
                  align = 'vh', hjust = -1, nrow = 1)

legend_b <- get_legend(central_agg_idx_accom + theme(legend.position="bottom"))

plot_grid( prow, legend_b, ncol = 1, rel_heights = c(4, .2))

```

The accommodations employment trend is more ambiguous. The treatment corridor saw a huge jump in employment immediately post construction but given the largely pre-construction negative trend, the shorter post-construction period, and the extreme growth this is probably due to the entry of some large employer as opposed to a response to new infrastructure.


#### Sales Tax 

Sales tax receipts for Central Ave do not necessarily signal an effect of lane installation in one way or the other. While Central's receipts, overall, have grown for both retail and restaurant sales, the positive growth trends for both industries start either before or at the beginning of the construction period.  The rate of change in growth, though, in restaurant receipts for both Central accelerates post-construction. While not definitive, the restaurant receipts hint at a potential relationship with the new infrastructure that our econometric models will be better able to explore.

```{r, echo=FALSE, message=FALSE, warning=FALSE, fig.width = 10, fig.height=10}

minn_sale <- tbl(con, "minn_sales_tax")
minn_sale <- collect(minn_sale)

central_agg <- agg_trend_table(minn_sale, group = 3)
central_agg <- central_agg %>% 
  mutate(Type = case_when(Type == " Improvement" ~ "Treatment",
                          Type == "Control" ~ "Control: University Ave."))
central_agg$Type <- factor(central_agg$Type, levels = c("Treatment", "Control: University Ave."))

central_agg_idx <- agg_index_trend_table (minn_sale, group = 3,2012)
central_agg_idx <- central_agg_idx %>% 
  mutate(Type = case_when(Type == " Improvement" ~ "Treatment",
                          Type == "Control" ~ "Control: University Ave.")) 
central_agg_idx$Type <- factor(central_agg_idx$Type, levels = c("Treatment", "Control: University Ave."))

<<<<<<< HEAD
central_agg_retail_plot <- trend_agg_plot_LEHD_sa(central_agg, base = "Sales Revenue", industry = "Retail", corridor_name = "Central Ave.",
                                               control_corridor = "University Ave.", industry_code = "CNS07", construct_year = 2012, end_year = 2013)

central_agg_accom_plot <- trend_agg_plot_LEHD_sa(central_agg, base = "Sales Revenue", industry = "Food", corridor_name = "Central Ave.",
                                              control_corridor = "University Ave.", industry_code = "CNS18", construct_year = 2012, end_year = 2013)
 
central_agg_retail_idx_plot <- trend_agg_index_plot_LEHD(central_agg_idx, base = "Sales Revenue", industry = "Retail", corridor_name = "Central Ave.",
                                                         control_corridor = "University Ave.", industry_code = "CNS07_sd", construct_year = 2012, end_year = 2013)

central_agg_idx_accom_plot <- trend_agg_index_plot_LEHD(central_agg_idx, base = "Sales Revenue", industry = "Food", corridor_name = "Central Ave.",
                                                        control_corridor = "University Ave.", industry_code = "CNS18_sd", construct_year = 2012, end_year = 2013)
=======
central_agg_retail_plot <- trend_agg_plot_LEHD_sa(central_agg, base = "Sales Tax", industry = "Retail",
                                                  corridor_name = "Central Ave.", control_corridor = "University Ave.",
                                                  industry_code = "CNS07", construct_year = 2012, end_year = 2013)

central_agg_accom_plot <- trend_agg_plot_LEHD_sa(central_agg, base = "Sales Tax", industry = "Food", 
                                                 corridor_name = "Central Ave.", control_corridor = "University Ave.",
                                              industry_code = "CNS18", construct_year = 2012, end_year = 2013)
 
central_agg_retail_idx_plot <- trend_agg_index_plot_LEHD(central_agg_idx, base = "Sales", industry = "Retail",
                                                         corridor_name = "Central Ave.", control_corridor = "University Ave.",
                                                         industry_code = "CNS07_sd", construct_year = 2012, end_year = 2013)

central_agg_idx_accom_plot <- trend_agg_index_plot_LEHD(central_agg_idx, base = "Sales", industry = "Food",
                                                        corridor_name = "Central Ave.", control_corridor = "University Ave.",
                                                        industry_code = "CNS18_sd", construct_year = 2012, end_year = 2013)
>>>>>>> 1d3e5496943849fc9b98e75f69f5404983bc6060

prow <- plot_grid(central_agg_retail_plot + theme(legend.position="none"),
                  central_agg_accom_plot + theme(legend.position="none"),
                  central_agg_retail_idx_plot + theme(legend.position="none"),
                  central_agg_idx_accom_plot + theme(legend.position="none"),
                  align = 'vh', hjust = -1, nrow = 2)

legend_b <- get_legend(central_agg_retail_plot + theme(legend.position="bottom"))

plot_grid(prow, legend_b, ncol = 1, rel_heights = c(4, .2))

```

The index value plots bring the difference in growth rates between the two corridors into stark relief. Central has fared much better over the course of the study period exhibiting robust growth in retail and restaurant sales. The post-construction growth bump is especially apparent in the restaurant sales indexed plot. University Ave's flattened growth in both restaurant and retail sales is especially striking in comparison to university's consistent growth. 

#### QCEW

Central Ave retail employment change was highly volatile in the early part of the 2000s, maintained a level around 200 jobs immediately before and through the recession and has seen fairly dramatic growth in the past few years. University Ave, on the other hand, has largely been down with respect to employment growth but saw a spike in employment starting during 2012, peaking in 2014, and has largely trended negatively since. Both corridors' total wages paid over time largely mirror their employment directly. For both, there is not an immediately apparent connection between the construction of new cycling infrastructure and employment or wage change. 

```{r, echo=FALSE, message=FALSE, warning=FALSE, fig.width=10, fig.height=8}

central_qcew <- minn_qcew %>% filter(corridors == "Central Ave"| corridors == "University Ave") %>% 
  collect()

central_qcew <- central_qcew %>% 
  mutate(year_quarter = paste0(year,"-",quarter), 
          year_quarter = as.yearqtr(year_quarter))

central_qcew <- central_qcew %>% 
  mutate(street_type = case_when(street_type == "improvement" ~ "Treatment",
                                 street_type == "control" ~ "Control: University Ave"))

central_qcew$street_type <- factor(central_qcew$street_type, 
                                     levels = c("Treatment", "Control: University Ave"))

central_agg <- central_qcew %>% 
 filter(year %in% (2009:2011)) %>% 
  group_by(street_type) %>% 
  mutate(estab_base = mean(establishments), base_wage = mean(total_wages), base_avg_emp = mean(avg_emp)) %>% 
  select(corridors, street_type, estab_base, base_wage, base_avg_emp) %>% unique()

central_qcew <- central_qcew %>% 
  left_join(central_agg, by = c("corridors" = "corridors", "street_type" = "street_type"))

central_qcew <- central_qcew %>% 
  mutate(estab_idx = establishments/estab_base,
         wage_idx = total_wages/base_wage,
         avg_emp_idx = avg_emp/base_avg_emp)

qc_central1 <- trend_agg_plot_qcew(central_qcew, base="Employment", industry = "Retail", corridor_name = "Central Ave",
                                               control_corridor = "University Ave", base_code = "avg_emp", construct_year = 2012)
 
qc_central2 <- trend_agg_plot_qcew_d(central_qcew, base="Total Wages", industry = "Retail", corridor_name = "Central Ave",
                                                       control_corridor = "University Ave", base_code = "total_wages", construct_year = 2012)

prow <- plot_grid(qc_central1 + theme(legend.position="none"),
                  qc_central2 + theme(legend.position="none"),
                  align = 'vh', hjust = -1, nrow = 1)

legend_b <- get_legend(qc_central1 + theme(legend.position="bottom"))

plot_grid(qc_central1, qc_central2,  ncol = 1)

```

The index plots show the dramatic growth of both Central and University Avenues over the past decade and a half with respect to both retail employment and wages. One detail to note is that Central continues on a positive trajectory for both wages and employment in the last few years ultimately surpassing the much more volatile University in terms of growth. 

```{r, echo=FALSE, message=FALSE, warning=FALSE, fig.width=10, fig.height=8}

qc_idx_central1 <- trend_agg_plot_qcew_p(central_qcew, base="Employment", industry = "Retail", corridor_name = "Central Ave",
                                               control_corridor = "University Ave", base_code = "avg_emp_idx", construct_year = 2012)
 
qc_idx_central2 <- trend_agg_plot_qcew_p(central_qcew, base="Total Wage", industry = "Retail", corridor_name = "Central Ave",
                                                       control_corridor = "University Ave", base_code = "wage_idx", construct_year = 2012)

prow <- plot_grid(qc_idx_central1 + theme(legend.position="none"),
                  qc_idx_central2 + theme(legend.position="none"),
                  align = 'vh', hjust = -1, nrow = 1)

legend_b <- get_legend(qc_idx_central1 + theme(legend.position="bottom"))

plot_grid(qc_idx_central1, qc_idx_central2,  ncol = 1)

```

## Lyndale Avenue South

### Aggregated Trend Analysis

#### LEHD

Retail employment on the Lyndale Avenue corridor looks to only have just recovered its employment since the recession though its growth pattern has been much more consistent than its comparison corridor. Interestingly, both the improved and control corridors saw a spike in retail employment in 2015. This is generally good news for the corridors though we the trend analysis does not show any real impact of the street improvement itself on retail employment. 

```{r, echo=FALSE, message=FALSE, warning=FALSE, fig.width = 10, fig.height= 5}
lyndale_agg <- agg_index_trend_table(minn_corridor, group = 4, construct_year = 2008)
minn_agg <- city_agg_index_trend_table(minn_lehd, construct_year = 2008)

lyndale_agg <- bind_rows(lyndale_agg, minn_agg)

lyndale_agg_idx_retail <- trend_agg_index_plot_city_LEHD(df_plot = lyndale_agg, base = "Employment", industry = "Retail", corridor_name = "Lyndale Ave. S.",
                                                                control_corridor = "Grand Ave.", industry_code = "CNS07_sd", construct_year = 2008, end_year = 2009)

lyndale_agg_idx_accom <- trend_agg_index_plot_city_LEHD(df_plot = lyndale_agg, base = "Employment", industry = "Food", corridor_name = "Lyndale Ave. S.",
                                                               control_corridor = "Grand Ave.", industry_code = "CNS18_sd", construct_year = 2008, end_year = 2009)

prow <- plot_grid(lyndale_agg_idx_retail + theme(legend.position="none"),
                  lyndale_agg_idx_accom + theme(legend.position="none"),
                  align = 'vh', hjust = -1, nrow = 1)

legend_b <- get_legend(lyndale_agg_idx_accom + theme(legend.position="bottom"))

plot_grid( prow, legend_b, ncol = 1, rel_heights = c(4, .2))

```

#### Sales Tax 

The Lyndale Ave corridor also displays ambiguous impacts of new cycling infrastructure on retail and restaurant demand. There is a  minor bump post construction for retail that results in increased growth over time signaling a possible effect of construction. Restaurant sales tax growth, though, is clearly tied to some major increase in demand nearly a decade after construction. Additionally, the growth in restaurant sales tax receipts was less than that of its control corridor both in absolute and relative terms.

```{r, echo=FALSE, message=FALSE, warning=FALSE, fig.width = 10, fig.height= 10}

minn_sale <- tbl(con, "minn_sales_tax")
minn_sale <- collect(minn_sale)

lyndale_agg <- agg_trend_table(minn_sale, group = 4)
lyndale_agg <- lyndale_agg %>% 
  mutate(Type = case_when(Type == " Improvement" ~ "Treatment",
                          Type == "Control" ~ "Control: Grand Ave."))
lyndale_agg$Type <- factor(lyndale_agg$Type, levels = c("Treatment", "Control: Grand Ave."))

lyndale_agg_idx <- agg_index_trend_table (minn_sale, group = 4, 2008)
lyndale_agg_idx <- lyndale_agg_idx %>% 
  mutate(Type = case_when(Type == " Improvement" ~ "Treatment",
                          Type == "Control" ~ "Control: Grand Ave.")) 
lyndale_agg_idx$Type <- factor(lyndale_agg_idx$Type, levels = c("Treatment", "Control: Grand Ave."))

lyndale_agg_retail_plot <- trend_agg_plot_LEHD_sa(lyndale_agg, base = "Sales Revenue", industry = "Retail", corridor_name = "Lyndale Ave. S.",
                                               control_corridor = "Grand Ave.", industry_code = "CNS07", construct_year = 2008, end_year = 2009)

lyndale_agg_accom_plot <- trend_agg_plot_LEHD_sa(lyndale_agg, base = "Sales Revenue", industry = "Food", corridor_name = "Lyndale Ave. S.",
                                              control_corridor = "Grand Ave.", industry_code = "CNS18", construct_year = 2008, end_year = 2009)
 
lyndale_agg_retail_idx_plot <- trend_agg_index_plot_LEHD(lyndale_agg_idx, base = "Sales Revenue", industry = "Retail", corridor_name = "Lyndale Ave. S.",
                                                         control_corridor = "Grand Ave.", industry_code = "CNS07_sd", construct_year = 2008, end_year = 2009)

lyndale_agg_idx_accom_plot <- trend_agg_index_plot_LEHD(lyndale_agg_idx, base = "Sales Revenue", industry = "Food", corridor_name = "Lyndale Ave. S.",
                                                        control_corridor = "Grand Ave.", industry_code = "CNS18_sd", construct_year = 2008, end_year = 2009)

prow <- plot_grid(lyndale_agg_retail_plot + theme(legend.position="none"),
                  lyndale_agg_accom_plot + theme(legend.position="none"),
                  lyndale_agg_retail_idx_plot + theme(legend.position="none"),
                  lyndale_agg_idx_accom_plot + theme(legend.position="none"),
                  align = 'vh', hjust = -1, nrow = 2)

legend_b <- get_legend(lyndale_agg_retail_plot + theme(legend.position="bottom"))

plot_grid(prow, legend_b, ncol = 1, rel_heights = c(4, .2))

```

The index plots echo the conclusions seen in the absolute value plots. In particular, notice the dramatic decline of retail sales for Grand Ave compared to the modest, but steady, growth in receipts on Lyndale. Grand performs better when examining restaurant sales growing at a faster rate than Lyndale until the final year where Lyndale experiences a monster jump in growth. But as mentioned earlier, these graphs do not provide compelling visual clues as to the effect of new infrastructure on sales tax receipts.

#### QCEW

Thought the baseline numbers differ drastically the absolute employment and wage values for Lyndale Ave still offer some enlightenment as to overall patterns of growth and the difference between Lyndale and Grand. First, while Lyndale starts from a much higher base employment both corridors see some growth immediately pre-recession, consistent employment loss during the recession and recovery after. Though note that Lyndale's recovery is more consistent post recession than Grand's which has a slight, though consistent fall in employment until nearly 2015.

```{r, echo=FALSE, message=FALSE, warning=FALSE, fig.width=10, fig.height=8}

lyndale_qcew <- minn_qcew %>% filter(corridors == "Lyndale Ave S" | corridors == "Grand Ave") %>% 
  collect()

lyndale_qcew <- lyndale_qcew %>% 
  mutate(year_quarter = paste0(year,"-",quarter), 
         year_quarter = as.yearqtr(year_quarter))

lyndale_qcew <- lyndale_qcew %>% 
  mutate(street_type = case_when(street_type == "improvement" ~ "Treatment",
                                 street_type == "control" ~ "Control: Grand Ave"))

lyndale_qcew$street_type <- factor(lyndale_qcew$street_type, 
                                     levels = c("Treatment", "Control: Grand Ave"))

lyndale_agg <- lyndale_qcew %>% 
 filter(year %in% (2005:2007)) %>% 
  group_by(street_type) %>% 
  mutate(estab_base = mean(establishments), base_wage = mean(total_wages), base_avg_emp = mean(avg_emp)) %>% 
  select(corridors, street_type, estab_base, base_wage, base_avg_emp) %>% unique()

lyndale_qcew <- lyndale_qcew %>% 
  left_join(lyndale_agg, by = c("corridors" = "corridors", "street_type" = "street_type"))

lyndale_qcew <- lyndale_qcew %>% 
  mutate(estab_idx = establishments/estab_base,
         wage_idx = total_wages/base_wage,
         avg_emp_idx = avg_emp/base_avg_emp)

qc_lyndale1 <- trend_agg_plot_qcew(lyndale_qcew, base="Employment", industry = "Retail", corridor_name = "Lyndale Ave S",
                                               control_corridor = "Grand Ave", base_code = "avg_emp", construct_year = 2008)
 
qc_lyndale2 <- trend_agg_plot_qcew_d(lyndale_qcew, base="Total Wages", industry = "Retail", corridor_name = "Lyndale Ave S",
                                                       control_corridor = "Grand Ave", base_code = "total_wages", construct_year = 2008)

prow <- plot_grid(qc_lyndale1 + theme(legend.position="none"),
                  qc_lyndale2 + theme(legend.position="none"),
                  align = 'vh', hjust = -1, nrow = 1)

legend_b <- get_legend(qc_lyndale1 + theme(legend.position="bottom"))

plot_grid(qc_lyndale1, qc_lyndale2,  ncol = 1)

```

The indexed figures give us a better idea of the patterns of growth between the two corridors.  In particular, both for wages and employment the corridors have similar growth trajectories while Lyndale Ave is consistently less volatile and has a higher rate of growth, at least for employment, starting around 2012 and carrying through 2015 when Cedar Ave takes over. Again, note that there does not seem to be an immediately apparent relationship between the construction period and wage or employment growth.

```{r, echo=FALSE, message=FALSE, warning=FALSE, fig.width=10, fig.height=8}

qc_idx_lyndale1 <- trend_agg_plot_qcew_p(lyndale_qcew, base="Employment", industry = "Retail", corridor_name = "Lyndale Ave S",
                                               control_corridor = "Grand Ave", base_code = "avg_emp_idx", construct_year = 2008)
 
qc_idx_lyndale2 <- trend_agg_plot_qcew_p(lyndale_qcew, base="Total Wage", industry = "Retail", corridor_name = "Lyndale Ave S",
                                                       control_corridor = "Grand Ave", base_code = "wage_idx", construct_year = 2008)

prow <- plot_grid(qc_idx_lyndale1 + theme(legend.position="none"),
                  qc_idx_lyndale2 + theme(legend.position="none"),
                  align = 'vh', hjust = -1, nrow = 1)

legend_b <- get_legend(qc_idx_lyndale1 + theme(legend.position="bottom"))

plot_grid(qc_idx_lyndale1, qc_idx_lyndale2,  ncol = 1)

```


## North 2nd Street

### Aggregated Trend Analysis

#### LEHD

North 2nd Street's employment trends point towards a probable impact of street improvement as the overall trend was negative before construction, with a minor rebound immediately pre-construction, a dip during construction, and then rebound in all periods post-construction.

```{r, echo=FALSE, message=FALSE, warning=FALSE, fig.width = 10, fig.height= 5}
north_agg <- agg_index_trend_table(minn_corridor, group = 5, construct_year = 2011)
minn_agg <- city_agg_index_trend_table(minn_lehd, construct_year = 2011)

north_agg <- bind_rows(north_agg, minn_agg)

north_agg_idx_retail <- trend_agg_index_plot_city_LEHD(df_plot = north_agg, base = "Employment", industry = "Retail", corridor_name = "North 2nd St.",
                                                                control_corridor = "Broadway Ave.", industry_code = "CNS07_sd", construct_year = 2011, end_year = 2012)

north_agg_idx_accom <- trend_agg_index_plot_city_LEHD(df_plot = north_agg, base = "Employment", industry = "Food", corridor_name = "North 2nd St.",
                                                               control_corridor = "Broadway Ave.", industry_code = "CNS18_sd", construct_year = 2011, end_year = 2012)

prow <- plot_grid(north_agg_idx_retail + theme(legend.position="none"),
                  north_agg_idx_accom + theme(legend.position="none"),
                  align = 'vh', hjust = -1, nrow = 1)

legend_b <- get_legend(north_agg_idx_accom + theme(legend.position="bottom"))

plot_grid( prow, legend_b, ncol = 1, rel_heights = c(4, .2))

```

Accommodations employment growth is quite robust for the treatment corridor but its growth trend starts at the beginning of the construction period and continues afterwards.

#### Sales Tax 

At first glance, North 2nd potential offers dramatic evidence of a positive effect of new infrastructure construction, but the extreme jump in sales tax receipts signals some greater change probably affected the corridor, such as the opening of multiple new establishments or one especially large establishment. Initial jump aside, the continued growth after the large spike in growth is a positive sign of the overall health of retail on the corridor. 

We do not include the restaurant sales tax values because no restaurant sales tax was collected on North 2nd until 2014.

```{r, echo=FALSE, message=FALSE, warning=FALSE, fig.width = 10, fig.height= 5}

minn_sale <- tbl(con, "minn_sales_tax")
minn_sale <- collect(minn_sale)

north_agg <- agg_trend_table(minn_sale, group = 5)
north_agg <- north_agg %>% 
  mutate(Type = case_when(Type == " Improvement" ~ "Treatment",
                          Type == "Control" ~ "Control: West Broadway"))
north_agg$Type <- factor(north_agg$Type, levels = c("Treatment", "Control: West Broadway"))

north_agg_idx <- agg_index_trend_table(minn_sale, group = 5,2012)

north_agg_idx <- north_agg_idx %>% 
  mutate(Type = stringr::str_trim(Type, "both"),
         Type = case_when(Type == "Improvement" ~ "Treatment",
                          Type == "Control" ~ "Control: West Broadway"))
north_agg_idx$Type <- factor(north_agg_idx$Type, levels = c("Treatment", "Control: West Broadway"))

north_agg_retail_plot <- trend_agg_plot_LEHD_sa(north_agg, base = "Sales Revenue", industry = "Retail", corridor_name = "North 2nd St.",
                                               control_corridor = "West Broadway", industry_code = "CNS07", construct_year = 2011, end_year = 2012)
 
north_agg_retail_idx_plot <- trend_agg_index_plot_LEHD(north_agg_idx, base = "Sales Revenue", industry = "Retail", corridor_name = "North 2nd St.",
                                                       control_corridor = "West Broadway", industry_code = "CNS07_sd", construct_year = 2011, end_year = 2012)


prow <- plot_grid(north_agg_retail_plot + theme(legend.position="none"),
                  north_agg_retail_idx_plot + theme(legend.position="none"),
                  align = 'vh', hjust = -1, nrow = 1)

legend_b <- get_legend(north_agg_retail_plot + theme(legend.position="bottom"))

plot_grid(prow, legend_b, ncol = 1, rel_heights = c(4, .2))

```

The index plot highlights the immense rate of growth North 2nd has seen in retail sales since 2012 and the relatively static nature of retail activity on West Broadway. Again, it is unlikely that the new infrastructure is the principle cause of such a dramatic jump in sales, but consistent growth over time after the initial jump may be, in some part, connected to the new infrastructure. 

####QCEW

The absolute graphs show the general decline of North 2nd compared to Broadway over the last two decades. After a high in the early part of the 2000s, North 2nd has largely been in decline with a slight uptick starting 2012/2013, but it is still far below its peak. Broadway, on the other hand, is defined by some pretty dramatic drops in employment and quick recoveries, though its last major fall during the recession has met with only a mild recovery. Note that for North 2nd there is not an immediately apparent relationship between the construction period and employment or wages.

```{r, echo=FALSE, message=FALSE, warning=FALSE, fig.width=10, fig.height=8}

north_qcew <- minn_qcew %>% 
  filter(corridors == "North 2nd Street" | corridors == "Broadway Ave")

north_qcew <- collect(north_qcew) %>% 
  mutate(year_quarter = paste0(year,"-",quarter), 
         year_quarter = as.yearqtr(year_quarter))

north_qcew <- north_qcew %>% 
  mutate(street_type = case_when(street_type == "improvement" ~ "Treatment",
                                 street_type == "control" ~ "Control: Broadway Ave"))

north_qcew$street_type <- factor(north_qcew$street_type, 
                                     levels = c("Treatment", "Control: Broadway Ave"))

north_agg <- north_qcew %>% 
 filter(year %in% (2008:2010)) %>% 
  group_by(street_type) %>% 
  mutate(estab_base = mean(establishments), base_wage = mean(total_wages), base_avg_emp = mean(avg_emp)) %>% 
  select(corridors, street_type, estab_base, base_wage, base_avg_emp) %>% unique()
north_qcew <- north_qcew %>% 
  left_join(north_agg, by = c("corridors" = "corridors", "street_type" = "street_type"))

north_qcew <- north_qcew %>% 
  mutate(estab_idx = establishments/estab_base,
         wage_idx = total_wages/base_wage,
         avg_emp_idx = avg_emp/base_avg_emp)

qc_emp_north <- trend_agg_plot_qcew(north_qcew, base="Employment", industry = "Retail", corridor_name = "North 2nd St.",
                                               control_corridor = "West Broadway", base_code = "avg_emp", construct_year = 2011)
 
qc_north_wages <- trend_agg_plot_qcew_d(north_qcew, base="Total Wages", industry = "Retail", corridor_name = "North 2nd St.",
                                                       control_corridor = "West Broadway", base_code = "total_wages", construct_year = 2011)

prow <- plot_grid(qc_emp_north + theme(legend.position="none"),
                  qc_north_wages + theme(legend.position="none"),
                  align = 'vh', hjust = -1, nrow = 1)

legend_b <- get_legend(qc_emp_north + theme(legend.position="bottom"))

plot_grid(qc_emp_north, qc_north_wages,  ncol = 1)

```

The indexed figures reinforce what the above figures demonstrate but they do offer a clearer example of the mirrored growth trends between the corridors starting around 2006/2007. Both corridors are only just now starting to grow beyond their 2011 baseline values with North 2nd showing a greater growth rate than Broadway post-2015. Note that these figures also do not.

```{r, echo=FALSE, message=FALSE, warning=FALSE, fig.width=10, fig.height=8}

qc_idx_emp_north <- trend_agg_plot_qcew_p(north_qcew, base="Employment", industry = "Retail", corridor_name = "North 2nd St.",
                                               control_corridor = "West Broadway", base_code = "avg_emp_idx", construct_year = 2011)
 
qc_idx_north_wages <- trend_agg_plot_qcew_p(north_qcew, base="Total Wage", industry = "Retail", corridor_name = "North 2nd St.",
                                                       control_corridor = "West Broadway", base_code = "wage_idx", construct_year = 2011)

prow <- plot_grid(qc_idx_emp_north + theme(legend.position="none"),
                  qc_idx_north_wages + theme(legend.position="none"),
                  align = 'vh', hjust = -1, nrow = 1)

legend_b <- get_legend(qc_idx_emp_north + theme(legend.position="bottom"))

plot_grid(qc_idx_emp_north, qc_idx_north_wages,  ncol = 1)

dbDisconnect(con)

```

