---
title: "2-15_Minneapolis_distributional_analysis"
author: "Wei Shi"
date: "Febrary 15, 2018"
output:
  word_document: default
  pdf_document:
    includes:
      in_header: header.tex
    number_sections: true
fig_width: 7
fig_height: 5
---

```{r setup,include=FALSE}

knitr::opts_chunk$set(cache = TRUE)
```

# load data
```{r message=FALSE, warning=FALSE, include=FALSE}

if(!require(pacman)){install.packages("pacman"); library(pacman)}
p_load(here, RPostgreSQL, sf, ggplot2, directlabels,ggthemes, tidyverse, dbplyr, stargazer,cowplot, lubridate, gridExtra,data.table)

user <- "shiwei"
host <- "pgsql102.rc.pdx.edu"
pw <- scan(here::here("batteries.pgpss"), what = "")
dbname <- "bike_lanes"

con <- dbConnect("PostgreSQL", host = host, user = user, dbname = dbname, 
                 password = pw, port = 5433)


source(here::here("Code/corridor_comparison_functions.R"))

minn_corridor <- st_read(dsn = con, query = "select a.geoid10 as geoid, a.c000 as c000,
a.cns07 as cns07, a.cns08 as cns08, a.cns12 as cns12, a.cns14 as cns14, a.cns15 as cns15, 
a.cns16 as cns16, a.cns17 as cns17, a.cns18 as cns18, a.cns19 as cns19, a.ce01 as ce01, a.ce02 as ce02, a.ce03 as ce03, a.cr01 as cr01,a.cr02 as cr02, a.cr03 as cr03, a.cr04 as cr04, a.cr05 as cr05, a.cr07 as cr07, a.cs02 as cs02, a.cd01 as cd01, a.cd02 as cd02, a.cd02 as cd03, a.cd04 as cd04, b.name as Name, b.type as Type, b.buildstart as buildstart, b.buildend as buildend, b.group as corridor_group, a.year as year, a.geometry
FROM minneapolis_lehd a, minneapolis_corridors b
WHERE ST_Intersects(ST_Buffer(b.geom, 20), a.geometry);")

minn_corridor[minn_corridor$name=="Central Ave (improvement)",]$type <- "Treatment: Central"
minn_corridor[minn_corridor$name =="University Ave NE (control)",]$type <- "Control: University"
minn_corridor[minn_corridor$name=="Franklin Ave (improvement)",]$type <- "Treatment: Franklin"
minn_corridor[minn_corridor$name=="Franklin Ave (control)",]$type <- "Control: Franklin"

minn_corridor <- minn_corridor %>%
  rename(C000 = c000, CNS07 = cns07, CNS08 = cns08,CNS18 = cns18, CNS12 = cns12, CNS14 = cns14, CNS15 = cns15,CNS16 = cns16, CNS17 = cns17, CNS18 = cns18, CNS19 = cns19, CE01=ce01, CE02=ce02, 
         CE03=ce03, CR01=cr01, CR02=cr02, CR03=cr03, CR04=cr04, CR05=cr05, CR07=cr07, CS02=cs02, 
         CD01=cd01, CD02=cd02, CD03=cd03, CD04=cd04, Group = corridor_group, BuildStart = buildstart, BuildEnd = buildend, Name = name, Type= type)

minn_lehd <- st_read(dsn = con, "minneapolis_lehd") %>% as.data.frame()

minn_lehd <- minn_lehd %>%
  rename(C000 = c000, CNS07 = cns07, CNS08 = cns08,CNS18 = cns18, CNS12 = cns12, CNS14 = cns14, CNS15 = cns15,CNS16 = cns16, CNS17 = cns17, CNS18 = cns18, CNS19 = cns19, CE01=ce01, CE02=ce02, 
         CE03=ce03, CR01=cr01, CR02=cr02, CR03=cr03, CR04=cr04, CR05=cr05, CR07=cr07, CS02=cs02, 
         CD01=cd01, CD02=cd02, CD03=cd03, CD04=cd04)


minn_corridor_rac <- st_read(dsn = con, query = "select a.geoid10 as geoid, a.c000 as c000,
a.cns07 as cns07, a.cns08 as cns08, a.cns12 as cns12, a.cns14 as cns14, a.cns15 as cns15, 
a.cns16 as cns16, a.cns17 as cns17, a.cns18 as cns18, a.cns19 as cns19, a.ce01 as ce01, a.ce02 as ce02, a.ce03 as ce03, a.cr01 as cr01,a.cr02 as cr02, a.cr03 as cr03, a.cr04 as cr04, a.cr05 as cr05, a.cr07 as cr07, a.cs02 as cs02, a.cd01 as cd01, a.cd02 as cd02, a.cd03 as cd03, a.cd04 as cd04, b.name as Name, b.type as Type, b.buildstart as buildstart, b.buildend as buildend, b.group as corridor_group, a.year as year, a.geometry
FROM minn_rac a, minneapolis_corridors b
WHERE ST_Intersects(ST_Buffer(b.geom, 20), a.geometry);")

minn_corridor_rac[minn_corridor_rac$name=="Central Ave (improvement)",]$type <- "Treatment: Central"
minn_corridor_rac[minn_corridor_rac$name =="University Ave NE (control)",]$type <- "Control: University"
minn_corridor_rac[minn_corridor_rac$name=="Franklin Ave (improvement)",]$type <- "Treatment: Franklin"
minn_corridor_rac[minn_corridor_rac$name=="Franklin Ave (control)",]$type <- "Control: Franklin"

minn_corridor_rac <- minn_corridor_rac %>%
  rename(C000 = c000, CNS07 = cns07, CNS08 = cns08, CNS12 = cns12, CNS14 = cns14, CNS15 = cns15,
         CNS16 = cns16, CNS17 = cns17, CNS18 = cns18, CNS19 = cns19, CE01=ce01, CE02=ce02, 
         CE03=ce03, CR01=cr01, CR02=cr02, CR03=cr03, CR04=cr04, CR05=cr05, CR07=cr07, CS02=cs02, 
         CD01=cd01, CD02=cd02, CD03=cd03, CD04=cd04,
         Group=corridor_group, BuildStart = buildstart, BuildEnd = buildend, Name = name, Type=type)

minn_rac <- st_read(dsn = con, query = "SELECT * FROM minn_rac") %>% as.data.frame() %>% 
  rename(C000 = c000, CNS07 = cns07, CNS18 = cns18, CNS12 = cns12, CNS14 = cns14, CNS15 = cns15,
         CNS16 = cns16, CNS17 = cns17, CNS18 = cns18, CNS19 = cns19, CE01=ce01, CE02=ce02, 
         CE03=ce03, CR01=cr01, CR02=cr02, CR03=cr03, CR04=cr04, CR05=cr05, CR07=cr07, CS02=cs02, 
         CD01=cd01, CD02=cd02, CD03=cd03, CD04=cd04)


dbDisconnect(con)

```


# Distributional analysis - Central
## additional distributional analysis - income (bar graph)
```{r echo=FALSE, fig.asp=0.5, fig.width=9.5, message=FALSE, warning=FALSE}
central_inc <- minn_corridor_rac %>% as.data.frame() %>% filter(Group == 3) %>% 
  mutate(Type = factor(Type, levels = c("Treatment: Central", "Control: University"))) %>% 
  group_by(Type, year) %>% 
  summarise(low_income = sum(CE01), 
            mid_income = sum(CE02), 
            high_income = sum(CE03)) %>% 
  group_by(Type) %>% 
  gather(income_level, employment,low_income, mid_income, high_income) %>% 
  mutate(year = as.Date(as.character(paste0(year, "-01-01")),"%Y-%m-%d"),
         income_level = factor(income_level, levels=c("high_income", "mid_income", "low_income")),
         n = case_when(Type == "Treatment: Central" ~ 27,
                       Type == "Control: University" ~54)) 

ggplot(data=central_inc, aes(x=year, y=employment/n)) +
  geom_bar(aes(fill=income_level),stat = "identity")+
  facet_wrap(~Type)+
  scale_x_date(date_breaks = "3 years", date_labels = "%Y") +
  labs(title="Income Composition Trend Among Corridors", x="Year", y ="Employment per block", 
       caption = "Bike lane is constructed in 2012") +
  theme(legend.position = "bottom") +
  scale_fill_discrete(name="Income Level",
                      breaks=c("high_income", "mid_income", "low_income"),
                      labels=c("High income", "Middle income", "Low income"))
  

```


## additional distributional analysis - race (line chart)
```{r echo=FALSE, fig.asp=1.5, fig.width=9.5, message=FALSE, warning=FALSE}
central_race <- minn_corridor %>% as.data.frame() %>% filter(Group == 3) %>% 
  group_by(Type, year) %>% 
  summarise(
    white = sum(CR01), black = sum(CR02), ameindian = sum(CR03), asian = sum(CR04), 
    hawaii=sum(CR05), other=sum(CR07), tot_emp = sum(C000)) %>% 
  mutate(white_perc = white/tot_emp*100,
         black_perc = black/tot_emp*100,
         ameindian_perc = ameindian/tot_emp*100,
         asian_perc = asian/tot_emp*100,
         hawaii_perc = hawaii/tot_emp*100,
         other_perc = other/tot_emp*100) 

minn_race <- minn_lehd %>% 
  group_by(year) %>% 
  summarise(
    white = sum(CR01), black = sum(CR02), ameindian = sum(CR03), asian = sum(CR04), 
    hawaii=sum(CR05), other=sum(CR07), tot_emp = sum(C000)) %>% 
  mutate(white_perc = white/tot_emp*100,
         black_perc = black/tot_emp*100,
         ameindian_perc = ameindian/tot_emp*100,
         asian_perc = asian/tot_emp*100,
         hawaii_perc = hawaii/tot_emp*100,
         other_perc = other/tot_emp*100,
         Type = "City") %>% 
  select(Type, year:other_perc) %>% as.data.frame()


central_race <- rbind(as.data.frame(central_race), as.data.frame(minn_race))
central_race[central_race$year<2009,][,c(3:8,10:15)] <- NA
central_race$Type <- as.factor(as.character(central_race$Type))
  
# find the largest interval of all percentages
range <- lapply(central_race %>% select(ends_with('_perc')), function(x) FUN = max(x, na.rm = T)-min(x, na.rm = T))
intv <- ceiling(max(unlist(range)))+2

white_plot <- dist_trend_plot(central_race,demo = "White", demo_code = "white_perc", corridor_name = "Central Avenue", cat = "Employment", construct_year = 2012, end_year = 2013, floor(min(central_race$white_perc, na.rm = T))-1, floor(min(central_race$white_perc, na.rm = T))+intv)

black_plot <- dist_trend_plot(central_race,demo = "Black", demo_code = "black_perc", corridor_name = "Central Avenue", cat = "Employment", construct_year = 2012, end_year = 2013, floor(min(central_race$black_perc, na.rm = T))-1, floor(min(central_race$black_perc, na.rm = T))+intv)

ameindian_plot <- dist_trend_plot(central_race,demo = "American Indian", demo_code = "ameindian_perc", corridor_name = "Central Avenue", cat = "Employment",construct_year = 2012, end_year = 2013, 0,intv)

asian_plot <- dist_trend_plot(central_race,demo = "Asian", demo_code = "asian_perc", corridor_name = "Central Avenue", cat = "Employment", construct_year = 2012, end_year = 2013,floor(min(central_race$asian_perc, na.rm = T))-1, floor(min(central_race$asian_perc, na.rm = T))+intv)

hawaii_plot <- dist_trend_plot(central_race,demo = "Native Hawaiian", demo_code = "hawaii_perc", corridor_name = "Central Avenue", cat = "Employment", construct_year = 2012, end_year = 2013,0,intv)

other_plot <- dist_trend_plot(central_race,demo = "Two or More Races", demo_code = "other_perc", corridor_name = "Central Avenue", cat = "Employment", construct_year = 2012, end_year = 2013,0,intv)

prow <- plot_grid(white_plot + theme(legend.position="none"),
                  black_plot + theme(legend.position="none"),
                  asian_plot + theme(legend.position="none"),
                  ameindian_plot + theme(legend.position="none"),
                  hawaii_plot + theme(legend.position="none"),
                  other_plot + theme(legend.position="none"), 
           align = 'vh', hjust = -1, nrow = 3)

legend_b <- get_legend(white_plot + theme(legend.position="bottom"))

plot_grid( prow, legend_b, ncol = 1, rel_heights = c(4, .2))

```


## additional distributional analysis - race (table)
```{r}
start_end_race <- central_race %>% filter(year >=2012) %>% 
  select(Type, year, ends_with("_perc")) %>% # select variables ends with "_perc"
  filter(complete.cases(.)) %>%
  group_by(Type) %>% 
  summarise_at(vars(ends_with("_perc")), funs(change = (last(.)-first(.))/first(.)/4*100))

  
# calculate year by year race categories percentage change  
y_o_y_race <- central_race %>% filter(year >=2012) %>%
  select(Type, year, ends_with("_perc")) %>% 
  mutate_if(is.numeric, funs(change = ./lag(.)*100 -100)) %>% 
  group_by(Type) %>% 
  summarise_at(vars(ends_with("_change")), funs(mean(., na.rm=T)))

```

## residence - race
```{r echo=FALSE, fig.asp=1.5, fig.width=9.5, message=FALSE, warning=FALSE}
central_race <- minn_corridor_rac %>% as.data.frame() %>% filter(Group == 3) %>% 
  group_by(Type, year) %>% 
  summarise(
    white = sum(CR01), black = sum(CR02), ameindian = sum(CR03), asian = sum(CR04), 
    hawaii=sum(CR05), other=sum(CR07), tot_emp = sum(C000)) %>% 
  mutate(white_perc = white/tot_emp*100,
         black_perc = black/tot_emp*100,
         ameindian_perc = ameindian/tot_emp*100,
         asian_perc = asian/tot_emp*100,
         hawaii_perc = hawaii/tot_emp*100,
         other_perc = other/tot_emp*100) 

minn_race <- minn_rac %>% 
  group_by(year) %>% 
  summarise(
    white = sum(CR01), black = sum(CR02), ameindian = sum(CR03), asian = sum(CR04), 
    hawaii=sum(CR05), other=sum(CR07), tot_emp = sum(C000)) %>% 
  mutate(white_perc = white/tot_emp*100,
         black_perc = black/tot_emp*100,
         ameindian_perc = ameindian/tot_emp*100,
         asian_perc = asian/tot_emp*100,
         hawaii_perc = hawaii/tot_emp*100,
         other_perc = other/tot_emp*100,
         Type = "City") %>% 
  select(Type, year:other_perc)


central_race <- rbind(as.data.frame(central_race), as.data.frame(minn_race))
central_race[central_race$year<2009,][,c(3:8,10:15)] <- NA
central_race$Type <- as.factor(as.character(central_race$Type))

# find the largest interval of all percentages
range <- lapply(central_race %>% select(ends_with('_perc')), function(x) FUN = max(x, na.rm = T)-min(x, na.rm = T))
intv <- ceiling(max(unlist(range)))+2  

white_plot <- dist_trend_plot(central_race,demo = "White", demo_code = "white_perc", corridor_name = "Central Avenue", cat = "Residents", construct_year = 2012, end_year = 2013, floor(min(central_race$white_perc, na.rm = T))-1, floor(min(central_race$white_perc, na.rm = T))+intv)

black_plot <- dist_trend_plot(central_race,demo = "Black", demo_code = "black_perc",  corridor_name = "Central Avenue", cat = "Residents", construct_year = 2012, end_year = 2013, floor(min(central_race$black_perc, na.rm = T))-1, floor(min(central_race$black_perc, na.rm = T))+intv)

ameindian_plot <- dist_trend_plot(central_race,demo = "American Indian", demo_code = "ameindian_perc", corridor_name = "Central Avenue", cat = "Residents", construct_year = 2012, end_year = 2013, 0,intv)

asian_plot <- dist_trend_plot(central_race,demo = "Asian", demo_code = "asian_perc", corridor_name = "Central Avenue", cat = "Residents", construct_year = 2012, end_year = 2013, 0, intv)

hawaii_plot <- dist_trend_plot(central_race,demo = "Native Hawaiian", demo_code = "hawaii_perc", corridor_name = "Central Avenue", cat = "Residents", construct_year = 2012, end_year = 2013, 0,intv)

other_plot <- dist_trend_plot(central_race,demo = "Two or More Races", demo_code = "other_perc",  corridor_name = "Central Avenue", cat = "Residents", construct_year = 2012, end_year = 2013, 0,intv)

prow <- plot_grid(white_plot + theme(legend.position="none"),
                  black_plot + theme(legend.position="none"),
                  ameindian_plot + theme(legend.position="none"),
                  asian_plot + theme(legend.position="none"),
                  hawaii_plot + theme(legend.position="none"),
                  other_plot + theme(legend.position="none"), 
           align = 'vh', hjust = -1, nrow = 3)

legend_b <- get_legend(white_plot + theme(legend.position="bottom"))

plot_grid( prow, legend_b, ncol = 1, rel_heights = c(4, .2))
```

## residence -race (table)
```{r}
start_end_race <- central_race %>% filter(year >=2012) %>%
  select(Type, year, ends_with("_perc")) %>% # select variables ends with "_perc"
  filter(complete.cases(.)) %>%
  group_by(Type) %>% 
  summarise_at(vars(ends_with("_perc")), funs(change = (last(.)-first(.))/first(.)/4*100))

  
# calculate year by year race categories percentage change  
y_o_y_race <- central_race %>% filter(year >=2012) %>%
  select(Type, year, ends_with("_perc")) %>% 
  mutate_if(is.numeric, funs(change = ./lag(.)*100 -100)) %>% 
  group_by(Type) %>% 
  summarise_at(vars(ends_with("_change")), funs(mean(., na.rm=T)))

```



## additional distributional analysis - education (line chart)
```{r echo=FALSE, fig.asp=1, fig.width=9.5, message=FALSE, warning=FALSE}
central_edu <- minn_corridor %>% as.data.frame() %>% filter(Group == 3) %>% 
  group_by(Type, year) %>% 
  summarise(
    hisch_under = sum(CD01), hisch = sum(CD02), col = sum(CD03), bach = sum(CD04), tot_emp = sum(C000)) %>% 
  mutate(hisch_under_perc = hisch_under/tot_emp*100,
         hisch_perc = hisch/tot_emp*100,
         col_perc = col/tot_emp*100,
         bach_perc = bach/tot_emp*100) 

minn_edu <- minn_lehd %>% 
  group_by(year) %>% 
  summarise(
    hisch_under = sum(CD01), hisch = sum(CD02), col = sum(CD03), bach = sum(CD04), tot_emp = sum(C000)) %>% 
  mutate(hisch_under_perc = hisch_under/tot_emp*100,
         hisch_perc = hisch/tot_emp*100,
         col_perc = col/tot_emp*100,
         bach_perc = bach/tot_emp*100,
         Type = "City") %>% 
  select(Type, year:bach_perc) %>% as.data.frame(.)


central_edu <- rbind(as.data.frame(central_edu), as.data.frame(minn_edu))
central_edu[central_edu$year<2009,][,c(3:6,8:11)] <- NA
central_edu$Type <- as.factor(as.character(central_edu$Type))
  

# find the largest interval of all percentages
range <- lapply(central_edu %>% select(ends_with('_perc')), function(x) FUN = max(x, na.rm = T)-min(x, na.rm = T))
intv <- ceiling(max(unlist(range)))+2


hisch_under_plot <- dist_trend_plot(central_edu,demo = "Less Than High School", demo_code = "hisch_under_perc", corridor_name = "Central Avenue", cat = "Employment", construct_year = 2012, end_year = 2013, 0,intv)

hisch_plot <- dist_trend_plot(central_edu,demo = "High School", demo_code = "hisch_perc", corridor_name = "Central Avenue", cat = "Employment", construct_year = 2012, end_year = 2013, floor(min(central_edu$hisch_perc,na.rm = T))-6, floor(min(central_edu$hisch_perc,na.rm = T))+intv-5)

col_plot <- dist_trend_plot(central_edu,demo = "College", demo_code = "col_perc", corridor_name = "Central Avenue", cat = "Employment", construct_year = 2012, end_year = 2013, floor(min(central_edu$col_perc,na.rm = T))-6, floor(min(central_edu$col_perc,na.rm = T))+intv-5)

bach_plot <- dist_trend_plot(central_edu,demo = "Bachelor or Above", demo_code = "bach_perc", corridor_name = "Central Avenue", cat = "Employment", construct_year = 2012, end_year = 2013, floor(min(central_edu$bach_perc,na.rm = T))-1, floor(min(central_edu$bach_perc,na.rm = T))+intv)

prow <- plot_grid(hisch_under_plot + theme(legend.position="none"),
                  hisch_plot + theme(legend.position="none"),
                  col_plot + theme(legend.position="none"),
                  bach_plot + theme(legend.position="none"),
           align = 'vh', hjust = -1, nrow = 2)

legend_b <- get_legend(col_plot + theme(legend.position="bottom"))

plot_grid( prow, legend_b, ncol = 1, rel_heights = c(4, .2))
```

## additional distributional analysis - edu (table)
```{r}
start_end_edu <- central_edu %>% filter(year>=2012) %>% 
  select(Type, year, ends_with("_perc")) %>% # select variables ends with "_perc"
  filter(complete.cases(.)) %>%
  group_by(Type) %>% 
  summarise_at(vars(ends_with("_perc")), funs(change = (last(.)-first(.))/first(.)/4*100))
  
  
# calculate year by year race categories percentage change  
y_o_y_edu <- central_edu %>% 
  select(Type, year, ends_with("_perc")) %>% 
  mutate_if(is.numeric, funs(change = ./lag(.)*100 -100)) %>% 
  group_by(Type) %>% 
  summarise_at(vars(ends_with("_change")), funs(mean(., na.rm=T)))
```

## residence - education (line chart)
```{r echo=FALSE, fig.asp=1, fig.width=9.5, message=FALSE, warning=FALSE}
central_edu <- minn_corridor_rac %>% as.data.frame() %>% filter(Group == 3) %>% 
  group_by(Type, year) %>% 
  summarise(
    hisch_under = sum(CD01), hisch = sum(CD02), col = sum(CD03), bach = sum(CD04), tot_emp = sum(C000)) %>% 
  mutate(hisch_under_perc = hisch_under/tot_emp*100,
         hisch_perc = hisch/tot_emp*100,
         col_perc = col/tot_emp*100,
         bach_perc = bach/tot_emp*100) 

minn_edu <- minn_rac %>% 
  group_by(year) %>% 
  summarise(
    hisch_under = sum(CD01), hisch = sum(CD02), col = sum(CD03), bach = sum(CD04), tot_emp = sum(C000)) %>% 
  mutate(hisch_under_perc = hisch_under/tot_emp*100,
         hisch_perc = hisch/tot_emp*100,
         col_perc = col/tot_emp*100,
         bach_perc = bach/tot_emp*100,
         Type = "City") %>% 
  select(Type, year:bach_perc) %>% as.data.frame(.)


central_edu <- rbind(as.data.frame(central_edu), as.data.frame(minn_edu))
central_edu[central_edu$year<2009,][,c(3:6,8:11)] <- NA
central_edu$Type <- as.factor(as.character(central_edu$Type))
  
# find the largest interval of all percentages
range <- lapply(central_edu %>% select(ends_with('_perc')), function(x) FUN = max(x, na.rm = T)-min(x, na.rm = T))
intv <- ceiling(max(unlist(range)))+2

hisch_under_plot <- dist_trend_plot(central_edu,demo = "Less Than High School", demo_code = "hisch_under_perc", corridor_name = "Central Avenue", cat = "Residents", construct_year = 2012, end_year = 2013, 0, intv)

hisch_plot <- dist_trend_plot(central_edu,demo = "High School", demo_code = "hisch_perc", corridor_name = "Central Avenue", cat = "Residents", construct_year = 2012, end_year = 2013, floor(min(central_edu$hisch_perc,na.rm = T))-1, floor(min(central_edu$hisch_perc,na.rm = T))+intv)

col_plot <- dist_trend_plot(central_edu,demo = "College", demo_code = "col_perc", corridor_name = "Central Avenue", cat = "Residents", construct_year = 2012, end_year = 2013, floor(min(central_edu$col_perc,na.rm = T))-1, floor(min(central_edu$col_perc,na.rm = T))+intv)

bach_plot <- dist_trend_plot(central_edu,demo = "Bachelor or Above", demo_code = "bach_perc", corridor_name = "Central Avenue", cat = "Residents", construct_year = 2012, end_year = 2013, floor(min(central_edu$bach_perc,na.rm = T))-1, floor(min(central_edu$bach_perc,na.rm = T))+intv)

prow <- plot_grid(hisch_under_plot + theme(legend.position="none"),
                  hisch_plot + theme(legend.position="none"),
                  col_plot + theme(legend.position="none"),
                  bach_plot + theme(legend.position="none"),
           align = 'vh', hjust = -1, nrow = 2)

legend_b <- get_legend(col_plot + theme(legend.position="bottom"))

plot_grid( prow, legend_b, ncol = 1, rel_heights = c(4, .2))
```


## distributional rac - edu table
```{r echo=FALSE, fig.asp=1, fig.width=9.5, message=FALSE, warning=FALSE}
  
start_end_edu <- central_edu %>% filter(year>=2012) %>% 
  select(Type, year, ends_with("_perc")) %>% # select variables ends with "_perc"
  filter(complete.cases(.)) %>%
  group_by(Type) %>% 
  summarise_at(vars(ends_with("_perc")), funs(change = (last(.)-first(.))/first(.)/4*100))
  
  
# calculate year by year race categories percentage change  
y_o_y_edu <- central_edu %>% 
  select(Type, year, ends_with("_perc")) %>% 
  mutate_if(is.numeric, funs(change = ./lag(.)*100 -100)) %>% 
  group_by(Type) %>% 
  summarise_at(vars(ends_with("_change")), funs(mean(., na.rm=T))) 

```

## gender
```{r echo=FALSE, fig.asp=0.5, fig.width=9.5, message=FALSE, warning=FALSE}
central_gender <- minn_corridor %>% as.data.frame() %>% filter(Group == 3) %>% 
  group_by(Type, year) %>% 
  summarise(female = sum(CS02), tot_emp = sum(C000)) %>% 
  mutate(female_perc = female/tot_emp*100) 

minn_gender <- minn_lehd %>% 
  group_by(year) %>% 
  summarise(female = sum(CS02), tot_emp = sum(C000)) %>% 
  mutate(female_perc = female/tot_emp*100,
         Type = "City") %>% 
  select(Type, year:female_perc) %>% as.data.frame(.)

central_gender <- rbind(as.data.frame(central_gender), as.data.frame(minn_gender))
central_gender[central_gender$year<2009,][,c(3,5)] <- NA
central_gender$Type <- as.factor(as.character(central_gender$Type))

gender_plot <- dist_trend_plot(central_gender,demo = "Female", demo_code = "female_perc", corridor_name = "Central Avenue", cat = "Employment", construct_year = 2012, end_year = 2013, 30, 54)

central_gender_rac <- minn_corridor_rac %>% as.data.frame() %>% filter(Group == 3) %>% 
  group_by(Type, year) %>% 
  summarise(female = sum(CS02), tot_emp = sum(C000)) %>% 
  mutate(female_perc = female/tot_emp*100) 

minn_gender_rac <- minn_rac %>% 
  group_by(year) %>% 
  summarise(female = sum(CS02), tot_emp = sum(C000)) %>% 
  mutate(female_perc = female/tot_emp*100,
         Type = "City") %>% 
  select(Type, year:female_perc) %>% as.data.frame(.) 

central_gender_rac <- rbind(as.data.frame(central_gender_rac), as.data.frame(minn_gender_rac))
central_gender_rac[central_gender_rac$year<2009,][,c(3,5)] <- NA
central_gender_rac$Type <- as.factor(as.character(central_gender_rac$Type))

gender_rac_plot <- dist_trend_plot(central_gender_rac,demo = "Female", demo_code = "female_perc", corridor_name = "Central Avenue", cat = "Residents", construct_year = 2012, end_year = 2013, 38, 62)

prow <- plot_grid(gender_plot + theme(legend.position="none"),
                  gender_rac_plot + theme(legend.position="none"),
           align = 'vh', hjust = -1, nrow = 1)

legend_b <- get_legend(gender_plot + theme(legend.position="bottom"))

plot_grid( prow, legend_b, ncol = 1, rel_heights = c(4, .2))
```



# Distributional analysis - Franklin
## additional distributional analysis - income (bar graph)
```{r echo=FALSE, fig.asp=0.5, fig.width=9.5, message=FALSE, warning=FALSE}
franklin_inc <- minn_corridor_rac %>% as.data.frame() %>% filter(Group == 2) %>% 
  mutate(Type = factor(Type, levels = c("Treatment: Franklin", "Control: Franklin"))) %>% 
  group_by(Type, year) %>% 
  summarise(low_income = sum(CE01), 
            mid_income = sum(CE02), 
            high_income = sum(CE03)) %>% 
  group_by(Type) %>% 
  gather(income_level, employment,low_income, mid_income, high_income) %>% 
  mutate(year = as.Date(as.character(paste0(year, "-01-01")),"%Y-%m-%d"),
         income_level = factor(income_level, levels=c("high_income", "mid_income", "low_income")),
         n = case_when(Type == "Treatment: Franklin" ~ 33,
                       Type == "Control: Franklin" ~22)) 

ggplot(data=franklin_inc, aes(x=year, y=employment/n)) +
  geom_bar(aes(fill=income_level),stat = "identity")+
  facet_wrap(~Type)+
  scale_x_date(date_breaks = "3 years", date_labels = "%Y") +
  labs(title="Income Composition Trend Among Corridors", x="Year", y ="Employment per block", 
       caption = "Bike lane is constructed in 2011") +
  theme(legend.position = "bottom") +
  scale_fill_discrete(name="Income Level",
                      breaks=c("high_income", "mid_income", "low_income"),
                      labels=c("High income", "Middle income", "Low income"))
  

```


## additional distributional analysis - race (line chart)
```{r echo=FALSE, fig.asp=1.5, fig.width=9.5, message=FALSE, warning=FALSE}
franklin_race <- minn_corridor %>% as.data.frame() %>% filter(Group == 2) %>% 
  group_by(Type, year) %>% 
  summarise(
    white = sum(CR01), black = sum(CR02), ameindian = sum(CR03), asian = sum(CR04), 
    hawaii=sum(CR05), other=sum(CR07), tot_emp = sum(C000)) %>% 
  mutate(white_perc = white/tot_emp*100,
         black_perc = black/tot_emp*100,
         ameindian_perc = ameindian/tot_emp*100,
         asian_perc = asian/tot_emp*100,
         hawaii_perc = hawaii/tot_emp*100,
         other_perc = other/tot_emp*100) 

minn_race <- minn_lehd %>% 
  group_by(year) %>% 
  summarise(
    white = sum(CR01), black = sum(CR02), ameindian = sum(CR03), asian = sum(CR04), 
    hawaii=sum(CR05), other=sum(CR07), tot_emp = sum(C000)) %>% 
  mutate(white_perc = white/tot_emp*100,
         black_perc = black/tot_emp*100,
         ameindian_perc = ameindian/tot_emp*100,
         asian_perc = asian/tot_emp*100,
         hawaii_perc = hawaii/tot_emp*100,
         other_perc = other/tot_emp*100,
         Type = "City") %>% 
  select(Type, year:other_perc) %>% as.data.frame()


franklin_race <- rbind(as.data.frame(franklin_race), as.data.frame(minn_race))
franklin_race[franklin_race$year<2009,][,c(3:8,10:15)] <- NA
franklin_race$Type <- as.factor(as.character(franklin_race$Type))
  
# find the largest interval of all percentages
range <- lapply(franklin_race %>% select(ends_with('_perc')), function(x) FUN = max(x, na.rm = T)-min(x, na.rm = T))
intv <- ceiling(max(unlist(range)))+2

white_plot <- dist_trend_plot(franklin_race,demo = "White", demo_code = "white_perc", corridor_name = "Franklin Avenue", cat = "Employment", construct_year = 2011, end_year = 2012, floor(min(franklin_race$white_perc, na.rm = T))-1, floor(min(franklin_race$white_perc, na.rm = T))+intv)

black_plot <- dist_trend_plot(franklin_race,demo = "Black", demo_code = "black_perc", corridor_name = "Franklin Avenue", cat = "Employment", construct_year = 2011, end_year = 2012, floor(min(franklin_race$black_perc, na.rm = T))-1, floor(min(franklin_race$black_perc, na.rm = T))+intv)

ameindian_plot <- dist_trend_plot(franklin_race,demo = "American Indian", demo_code = "ameindian_perc", corridor_name = "Franklin Avenue", cat = "Employment",construct_year = 2011, end_year = 2012, 0,intv)

asian_plot <- dist_trend_plot(franklin_race,demo = "Asian", demo_code = "asian_perc", corridor_name = "Franklin Avenue", cat = "Employment", construct_year = 2011, end_year = 2012,floor(min(franklin_race$asian_perc, na.rm = T))-1, floor(min(franklin_race$asian_perc, na.rm = T))+intv)

hawaii_plot <- dist_trend_plot(franklin_race,demo = "Native Hawaiian", demo_code = "hawaii_perc", corridor_name = "Franklin Avenue", cat = "Employment", construct_year = 2011, end_year = 2012,0,intv)

other_plot <- dist_trend_plot(franklin_race,demo = "Two or More Races", demo_code = "other_perc", corridor_name = "Franklin Avenue", cat = "Employment", construct_year = 2011, end_year = 2012,0,intv)

prow <- plot_grid(white_plot + theme(legend.position="none"),
                  black_plot + theme(legend.position="none"),
                  asian_plot + theme(legend.position="none"),
                  ameindian_plot + theme(legend.position="none"),
                  hawaii_plot + theme(legend.position="none"),
                  other_plot + theme(legend.position="none"), 
           align = 'vh', hjust = -1, nrow = 3)

legend_b <- get_legend(white_plot + theme(legend.position="bottom"))

plot_grid( prow, legend_b, ncol = 1, rel_heights = c(4, .2))

```


## additional distributional analysis - race (table)
```{r}
start_end_race <- franklin_race %>% filter(year >=2011) %>% 
  select(Type, year, ends_with("_perc")) %>% # select variables ends with "_perc"
  filter(complete.cases(.)) %>%
  group_by(Type) %>% 
  summarise_at(vars(ends_with("_perc")), funs(change = (last(.)-first(.))/first(.)/4*100))

  
# calculate year by year race categories percentage change  
y_o_y_race <- franklin_race %>% filter(year >=2011) %>%
  select(Type, year, ends_with("_perc")) %>% 
  mutate_if(is.numeric, funs(change = ./lag(.)*100 -100)) %>% 
  group_by(Type) %>% 
  summarise_at(vars(ends_with("_change")), funs(mean(., na.rm=T)))

```

## residence - race
```{r echo=FALSE, fig.asp=1.5, fig.width=9.5, message=FALSE, warning=FALSE}
franklin_race <- minn_corridor_rac %>% as.data.frame() %>% filter(Group == 2) %>% 
  group_by(Type, year) %>% 
  summarise(
    white = sum(CR01), black = sum(CR02), ameindian = sum(CR03), asian = sum(CR04), 
    hawaii=sum(CR05), other=sum(CR07), tot_emp = sum(C000)) %>% 
  mutate(white_perc = white/tot_emp*100,
         black_perc = black/tot_emp*100,
         ameindian_perc = ameindian/tot_emp*100,
         asian_perc = asian/tot_emp*100,
         hawaii_perc = hawaii/tot_emp*100,
         other_perc = other/tot_emp*100) 

minn_race <- minn_rac %>% 
  group_by(year) %>% 
  summarise(
    white = sum(CR01), black = sum(CR02), ameindian = sum(CR03), asian = sum(CR04), 
    hawaii=sum(CR05), other=sum(CR07), tot_emp = sum(C000)) %>% 
  mutate(white_perc = white/tot_emp*100,
         black_perc = black/tot_emp*100,
         ameindian_perc = ameindian/tot_emp*100,
         asian_perc = asian/tot_emp*100,
         hawaii_perc = hawaii/tot_emp*100,
         other_perc = other/tot_emp*100,
         Type = "City") %>% 
  select(Type, year:other_perc)


franklin_race <- rbind(as.data.frame(franklin_race), as.data.frame(minn_race))
franklin_race[franklin_race$year<2009,][,c(3:8,10:15)] <- NA
franklin_race$Type <- as.factor(as.character(franklin_race$Type))

# find the largest interval of all percentages
range <- lapply(franklin_race %>% select(ends_with('_perc')), function(x) FUN = max(x, na.rm = T)-min(x, na.rm = T))
intv <- ceiling(max(unlist(range)))+2  

white_plot <- dist_trend_plot(franklin_race,demo = "White", demo_code = "white_perc", corridor_name = "Franklin Avenue", cat = "Residents", construct_year = 2011, end_year = 2012, floor(min(franklin_race$white_perc, na.rm = T))-1, floor(min(franklin_race$white_perc, na.rm = T))+intv)

black_plot <- dist_trend_plot(franklin_race,demo = "Black", demo_code = "black_perc",  corridor_name = "Franklin Avenue", cat = "Residents", construct_year = 2011, end_year = 2012, floor(min(franklin_race$black_perc, na.rm = T))-1, floor(min(franklin_race$black_perc, na.rm = T))+intv)

ameindian_plot <- dist_trend_plot(franklin_race,demo = "American Indian", demo_code = "ameindian_perc", corridor_name = "Franklin Avenue", cat = "Residents", construct_year = 2011, end_year = 2012, 0,intv)

asian_plot <- dist_trend_plot(franklin_race,demo = "Asian", demo_code = "asian_perc", corridor_name = "Franklin Avenue", cat = "Residents", construct_year = 2011, end_year = 2012, 0, intv)

hawaii_plot <- dist_trend_plot(franklin_race,demo = "Native Hawaiian", demo_code = "hawaii_perc", corridor_name = "Franklin Avenue", cat = "Residents", construct_year = 2011, end_year = 2012, 0,intv)

other_plot <- dist_trend_plot(franklin_race,demo = "Two or More Races", demo_code = "other_perc",  corridor_name = "Franklin Avenue", cat = "Residents", construct_year = 2011, end_year = 2012, 0,intv)

prow <- plot_grid(white_plot + theme(legend.position="none"),
                  black_plot + theme(legend.position="none"),
                  ameindian_plot + theme(legend.position="none"),
                  asian_plot + theme(legend.position="none"),
                  hawaii_plot + theme(legend.position="none"),
                  other_plot + theme(legend.position="none"), 
           align = 'vh', hjust = -1, nrow = 3)

legend_b <- get_legend(white_plot + theme(legend.position="bottom"))

plot_grid( prow, legend_b, ncol = 1, rel_heights = c(4, .2))
```

## residence -race (table)
```{r}
start_end_race <- franklin_race %>% filter(year >=2011) %>%
  select(Type, year, ends_with("_perc")) %>% # select variables ends with "_perc"
  filter(complete.cases(.)) %>%
  group_by(Type) %>% 
  summarise_at(vars(ends_with("_perc")), funs(change = (last(.)-first(.))/first(.)/4*100))

  
# calculate year by year race categories percentage change  
y_o_y_race <- franklin_race %>% filter(year >=2011) %>%
  select(Type, year, ends_with("_perc")) %>% 
  mutate_if(is.numeric, funs(change = ./lag(.)*100 -100)) %>% 
  group_by(Type) %>% 
  summarise_at(vars(ends_with("_change")), funs(mean(., na.rm=T)))

```



## additional distributional analysis - education (line chart)
```{r echo=FALSE, fig.asp=1, fig.width=9.5, message=FALSE, warning=FALSE}
franklin_edu <- minn_corridor %>% as.data.frame() %>% filter(Group == 2) %>% 
  group_by(Type, year) %>% 
  summarise(
    hisch_under = sum(CD01), hisch = sum(CD02), col = sum(CD03), bach = sum(CD04), tot_emp = sum(C000)) %>% 
  mutate(hisch_under_perc = hisch_under/tot_emp*100,
         hisch_perc = hisch/tot_emp*100,
         col_perc = col/tot_emp*100,
         bach_perc = bach/tot_emp*100) 

minn_edu <- minn_lehd %>% 
  group_by(year) %>% 
  summarise(
    hisch_under = sum(CD01), hisch = sum(CD02), col = sum(CD03), bach = sum(CD04), tot_emp = sum(C000)) %>% 
  mutate(hisch_under_perc = hisch_under/tot_emp*100,
         hisch_perc = hisch/tot_emp*100,
         col_perc = col/tot_emp*100,
         bach_perc = bach/tot_emp*100,
         Type = "City") %>% 
  select(Type, year:bach_perc) %>% as.data.frame(.)


franklin_edu <- rbind(as.data.frame(franklin_edu), as.data.frame(minn_edu))
franklin_edu[franklin_edu$year<2009,][,c(3:6,8:11)] <- NA
franklin_edu$Type <- as.factor(as.character(franklin_edu$Type))
  

# find the largest interval of all percentages
range <- lapply(franklin_edu %>% select(ends_with('_perc')), function(x) FUN = max(x, na.rm = T)-min(x, na.rm = T))
intv <- ceiling(max(unlist(range)))+2


hisch_under_plot <- dist_trend_plot(franklin_edu,demo = "Less Than High School", demo_code = "hisch_under_perc", corridor_name = "Franklin Avenue", cat = "Employment", construct_year = 2011, end_year = 2012, 0,intv)

hisch_plot <- dist_trend_plot(franklin_edu,demo = "High School", demo_code = "hisch_perc", corridor_name = "Franklin Avenue", cat = "Employment", construct_year = 2011, end_year = 2012, floor(min(franklin_edu$hisch_perc,na.rm = T))-6, floor(min(franklin_edu$hisch_perc,na.rm = T))+intv-5)

col_plot <- dist_trend_plot(franklin_edu,demo = "College", demo_code = "col_perc", corridor_name = "Franklin Avenue", cat = "Employment", construct_year = 2011, end_year = 2012, floor(min(franklin_edu$col_perc,na.rm = T))-6, floor(min(franklin_edu$col_perc,na.rm = T))+intv-5)

bach_plot <- dist_trend_plot(franklin_edu,demo = "Bachelor or Above", demo_code = "bach_perc", corridor_name = "Franklin Avenue", cat = "Employment", construct_year = 2011, end_year = 2012, floor(min(franklin_edu$bach_perc,na.rm = T))-1, floor(min(franklin_edu$bach_perc,na.rm = T))+intv)

prow <- plot_grid(hisch_under_plot + theme(legend.position="none"),
                  hisch_plot + theme(legend.position="none"),
                  col_plot + theme(legend.position="none"),
                  bach_plot + theme(legend.position="none"),
           align = 'vh', hjust = -1, nrow = 2)

legend_b <- get_legend(col_plot + theme(legend.position="bottom"))

plot_grid( prow, legend_b, ncol = 1, rel_heights = c(4, .2))
```

## additional distributional analysis - edu (table)
```{r}
start_end_edu <- franklin_edu %>% filter(year>=2011) %>% 
  select(Type, year, ends_with("_perc")) %>% # select variables ends with "_perc"
  filter(complete.cases(.)) %>%
  group_by(Type) %>% 
  summarise_at(vars(ends_with("_perc")), funs(change = (last(.)-first(.))/first(.)/4*100))
  
  
# calculate year by year race categories percentage change  
y_o_y_edu <- franklin_edu %>% 
  select(Type, year, ends_with("_perc")) %>% 
  mutate_if(is.numeric, funs(change = ./lag(.)*100 -100)) %>% 
  group_by(Type) %>% 
  summarise_at(vars(ends_with("_change")), funs(mean(., na.rm=T)))
```

## residence - education (line chart)
```{r echo=FALSE, fig.asp=1, fig.width=9.5, message=FALSE, warning=FALSE}
franklin_edu <- minn_corridor_rac %>% as.data.frame() %>% filter(Group == 2) %>% 
  group_by(Type, year) %>% 
  summarise(
    hisch_under = sum(CD01), hisch = sum(CD02), col = sum(CD03), bach = sum(CD04), tot_emp = sum(C000)) %>% 
  mutate(hisch_under_perc = hisch_under/tot_emp*100,
         hisch_perc = hisch/tot_emp*100,
         col_perc = col/tot_emp*100,
         bach_perc = bach/tot_emp*100) 

minn_edu <- minn_rac %>% 
  group_by(year) %>% 
  summarise(
    hisch_under = sum(CD01), hisch = sum(CD02), col = sum(CD03), bach = sum(CD04), tot_emp = sum(C000)) %>% 
  mutate(hisch_under_perc = hisch_under/tot_emp*100,
         hisch_perc = hisch/tot_emp*100,
         col_perc = col/tot_emp*100,
         bach_perc = bach/tot_emp*100,
         Type = "City") %>% 
  select(Type, year:bach_perc) %>% as.data.frame(.)


franklin_edu <- rbind(as.data.frame(franklin_edu), as.data.frame(minn_edu))
franklin_edu[franklin_edu$year<2009,][,c(3:6,8:11)] <- NA
franklin_edu$Type <- as.factor(as.character(franklin_edu$Type))
  
# find the largest interval of all percentages
range <- lapply(franklin_edu %>% select(ends_with('_perc')), function(x) FUN = max(x, na.rm = T)-min(x, na.rm = T))
intv <- ceiling(max(unlist(range)))+2

hisch_under_plot <- dist_trend_plot(franklin_edu,demo = "Less Than High School", demo_code = "hisch_under_perc", corridor_name = "Franklin Avenue", cat = "Residents", construct_year = 2011, end_year = 2012, 0, intv)

hisch_plot <- dist_trend_plot(franklin_edu,demo = "High School", demo_code = "hisch_perc", corridor_name = "Franklin Avenue", cat = "Residents", construct_year = 2011, end_year = 2012, floor(min(franklin_edu$hisch_perc,na.rm = T))-6, floor(min(franklin_edu$hisch_perc,na.rm = T))+intv-5)

col_plot <- dist_trend_plot(franklin_edu,demo = "College", demo_code = "col_perc", corridor_name = "Franklin Avenue", cat = "Residents", construct_year = 2011, end_year = 2012, floor(min(franklin_edu$col_perc,na.rm = T))-6, floor(min(franklin_edu$col_perc,na.rm = T))+intv-5)

bach_plot <- dist_trend_plot(franklin_edu,demo = "Bachelor or Above", demo_code = "bach_perc", corridor_name = "Franklin Avenue", cat = "Residents", construct_year = 2011, end_year = 2012, floor(min(franklin_edu$bach_perc,na.rm = T))-1, floor(min(franklin_edu$bach_perc,na.rm = T))+intv)

prow <- plot_grid(hisch_under_plot + theme(legend.position="none"),
                  hisch_plot + theme(legend.position="none"),
                  col_plot + theme(legend.position="none"),
                  bach_plot + theme(legend.position="none"),
           align = 'vh', hjust = -1, nrow = 2)

legend_b <- get_legend(col_plot + theme(legend.position="bottom"))

plot_grid( prow, legend_b, ncol = 1, rel_heights = c(4, .2))
```


## distributional rac - edu table
```{r echo=FALSE, fig.asp=1, fig.width=9.5, message=FALSE, warning=FALSE}
  
start_end_edu <- franklin_edu %>% filter(year>=2011) %>% 
  select(Type, year, ends_with("_perc")) %>% # select variables ends with "_perc"
  filter(complete.cases(.)) %>%
  group_by(Type) %>% 
  summarise_at(vars(ends_with("_perc")), funs(change = (last(.)-first(.))/first(.)/4*100))
  
  
# calculate year by year race categories percentage change  
y_o_y_edu <- franklin_edu %>% 
  select(Type, year, ends_with("_perc")) %>% 
  mutate_if(is.numeric, funs(change = ./lag(.)*100 -100)) %>% 
  group_by(Type) %>% 
  summarise_at(vars(ends_with("_change")), funs(mean(., na.rm=T))) 

```

## gender
```{r echo=FALSE, fig.asp=0.5, fig.width=9.5, message=FALSE, warning=FALSE}
franklin_gender <- minn_corridor %>% as.data.frame() %>% filter(Group == 2) %>% 
  group_by(Type, year) %>% 
  summarise(female = sum(CS02), tot_emp = sum(C000)) %>% 
  mutate(female_perc = female/tot_emp*100) 

minn_gender <- minn_lehd %>% 
  group_by(year) %>% 
  summarise(female = sum(CS02), tot_emp = sum(C000)) %>% 
  mutate(female_perc = female/tot_emp*100,
         Type = "City") %>% 
  select(Type, year:female_perc) %>% as.data.frame(.)

franklin_gender <- rbind(as.data.frame(franklin_gender), as.data.frame(minn_gender))
franklin_gender[franklin_gender$year<2009,][,c(3,5)] <- NA
franklin_gender$Type <- as.factor(as.character(franklin_gender$Type))

gender_plot <- dist_trend_plot(franklin_gender,demo = "Female", demo_code = "female_perc", corridor_name = "Franklin Avenue", cat = "Employment", construct_year = 2011, end_year = 2012, 47, 57.5)

franklin_gender_rac <- minn_corridor_rac %>% as.data.frame() %>% filter(Group == 2) %>% 
  group_by(Type, year) %>% 
  summarise(female = sum(CS02), tot_emp = sum(C000)) %>% 
  mutate(female_perc = female/tot_emp*100) 

minn_gender_rac <- minn_rac %>% 
  group_by(year) %>% 
  summarise(female = sum(CS02), tot_emp = sum(C000)) %>% 
  mutate(female_perc = female/tot_emp*100,
         Type = "City") %>% 
  select(Type, year:female_perc) %>% as.data.frame(.) 

franklin_gender_rac <- rbind(as.data.frame(franklin_gender_rac), as.data.frame(minn_gender_rac))
franklin_gender_rac[franklin_gender_rac$year<2009,][,c(3,5)] <- NA
franklin_gender_rac$Type <- as.factor(as.character(franklin_gender_rac$Type))

gender_rac_plot <- dist_trend_plot(franklin_gender_rac,demo = "Female", demo_code = "female_perc", corridor_name = "Franklin Avenue", cat = "Residents", construct_year = 2011, end_year = 2012, 43, 53)

prow <- plot_grid(gender_plot + theme(legend.position="none"),
                  gender_rac_plot + theme(legend.position="none"),
           align = 'vh', hjust = -1, nrow = 1)

legend_b <- get_legend(gender_plot + theme(legend.position="bottom"))

plot_grid( prow, legend_b, ncol = 1, rel_heights = c(4, .2))
```
